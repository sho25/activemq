begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|UnknownHostException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|Provider
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|Security
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CopyOnWriteArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CountDownLatch
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|LinkedBlockingQueue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|RejectedExecutionException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|RejectedExecutionHandler
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|SynchronousQueue
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadFactory
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadPoolExecutor
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicBoolean
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicLong
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|annotation
operator|.
name|PostConstruct
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|annotation
operator|.
name|PreDestroy
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|InstanceNotFoundException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|MalformedObjectNameException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|ObjectName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|ActiveMQConnectionMetaData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|ConfigurationException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|Service
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|advisory
operator|.
name|AdvisoryBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|cluster
operator|.
name|ConnectionSplitBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|AnnotatedMBean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|BrokerMBeanSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|BrokerView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|ConnectorView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|ConnectorViewMBean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|HealthView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|HealthViewMBean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|JmsConnectorView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|JobSchedulerView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|JobSchedulerViewMBean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|Log4JConfigView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|ManagedRegionBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|ManagementContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|NetworkConnectorView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|NetworkConnectorViewMBean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|jmx
operator|.
name|ProxyConnectorView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|CompositeDestinationInterceptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|Destination
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|DestinationFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|DestinationFactoryImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|DestinationInterceptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|RegionBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|policy
operator|.
name|PolicyMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|virtual
operator|.
name|MirroredQueue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|virtual
operator|.
name|VirtualDestination
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|virtual
operator|.
name|VirtualDestinationInterceptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|virtual
operator|.
name|VirtualTopic
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|scheduler
operator|.
name|JobSchedulerStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|scheduler
operator|.
name|SchedulerBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|scheduler
operator|.
name|memory
operator|.
name|InMemoryJobSchedulerStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ActiveMQDestination
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ActiveMQQueue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|BrokerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ProducerInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|filter
operator|.
name|DestinationFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|network
operator|.
name|ConnectionFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|network
operator|.
name|DiscoveryNetworkConnector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|network
operator|.
name|NetworkConnector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|network
operator|.
name|jms
operator|.
name|JmsConnector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|openwire
operator|.
name|OpenWireFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|proxy
operator|.
name|ProxyConnector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|security
operator|.
name|MessageAuthorizationPolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|selector
operator|.
name|SelectorParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|store
operator|.
name|JournaledStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|store
operator|.
name|PListStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|store
operator|.
name|PersistenceAdapter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|store
operator|.
name|PersistenceAdapterFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|store
operator|.
name|memory
operator|.
name|MemoryPersistenceAdapter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|thread
operator|.
name|Scheduler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|thread
operator|.
name|TaskRunnerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|transport
operator|.
name|TransportFactorySupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|transport
operator|.
name|TransportServer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|transport
operator|.
name|vm
operator|.
name|VMTransportFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|usage
operator|.
name|PercentLimitUsage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|usage
operator|.
name|StoreUsage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|usage
operator|.
name|SystemUsage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|BrokerSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|DefaultIOExceptionHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|IOExceptionHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|IOExceptionSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|IOHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|InetAddressUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|ServiceStopper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|StoreUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|ThreadPoolUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|TimeUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|MDC
import|;
end_import

begin_comment
comment|/**  * Manages the life-cycle of an ActiveMQ Broker. A BrokerService consists of a  * number of transport connectors, network connectors and a bunch of properties  * which can be used to configure the broker as its lazily created.  *  * @org.apache.xbean.XBean  */
end_comment

begin_class
specifier|public
class|class
name|BrokerService
implements|implements
name|Service
block|{
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_PORT
init|=
literal|"61616"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|LOCAL_HOST_NAME
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|BROKER_VERSION
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_BROKER_NAME
init|=
literal|"localhost"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|DEFAULT_MAX_FILE_LENGTH
init|=
literal|1024
operator|*
literal|1024
operator|*
literal|32
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|long
name|DEFAULT_START_TIMEOUT
init|=
literal|600000L
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|BrokerService
operator|.
name|class
argument_list|)
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unused"
argument_list|)
specifier|private
specifier|static
specifier|final
name|long
name|serialVersionUID
init|=
literal|7353129142305630237L
decl_stmt|;
specifier|private
name|boolean
name|useJmx
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|enableStatistics
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|persistent
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|populateJMSXUserID
decl_stmt|;
specifier|private
name|boolean
name|useAuthenticatedPrincipalForJMSXUserID
decl_stmt|;
specifier|private
name|boolean
name|populateUserNameInMBeans
decl_stmt|;
specifier|private
name|long
name|mbeanInvocationTimeout
init|=
literal|0
decl_stmt|;
specifier|private
name|boolean
name|useShutdownHook
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|useLoggingForShutdownErrors
decl_stmt|;
specifier|private
name|boolean
name|shutdownOnMasterFailure
decl_stmt|;
specifier|private
name|boolean
name|shutdownOnSlaveFailure
decl_stmt|;
specifier|private
name|boolean
name|waitForSlave
decl_stmt|;
specifier|private
name|long
name|waitForSlaveTimeout
init|=
name|DEFAULT_START_TIMEOUT
decl_stmt|;
specifier|private
name|boolean
name|passiveSlave
decl_stmt|;
specifier|private
name|String
name|brokerName
init|=
name|DEFAULT_BROKER_NAME
decl_stmt|;
specifier|private
name|File
name|dataDirectoryFile
decl_stmt|;
specifier|private
name|File
name|tmpDataDirectory
decl_stmt|;
specifier|private
name|Broker
name|broker
decl_stmt|;
specifier|private
name|BrokerView
name|adminView
decl_stmt|;
specifier|private
name|ManagementContext
name|managementContext
decl_stmt|;
specifier|private
name|ObjectName
name|brokerObjectName
decl_stmt|;
specifier|private
name|TaskRunnerFactory
name|taskRunnerFactory
decl_stmt|;
specifier|private
name|TaskRunnerFactory
name|persistenceTaskRunnerFactory
decl_stmt|;
specifier|private
name|SystemUsage
name|systemUsage
decl_stmt|;
specifier|private
name|SystemUsage
name|producerSystemUsage
decl_stmt|;
specifier|private
name|SystemUsage
name|consumerSystemUsage
decl_stmt|;
specifier|private
name|PersistenceAdapter
name|persistenceAdapter
decl_stmt|;
specifier|private
name|PersistenceAdapterFactory
name|persistenceFactory
decl_stmt|;
specifier|protected
name|DestinationFactory
name|destinationFactory
decl_stmt|;
specifier|private
name|MessageAuthorizationPolicy
name|messageAuthorizationPolicy
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|TransportConnector
argument_list|>
name|transportConnectors
init|=
operator|new
name|CopyOnWriteArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|NetworkConnector
argument_list|>
name|networkConnectors
init|=
operator|new
name|CopyOnWriteArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|ProxyConnector
argument_list|>
name|proxyConnectors
init|=
operator|new
name|CopyOnWriteArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|JmsConnector
argument_list|>
name|jmsConnectors
init|=
operator|new
name|CopyOnWriteArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|Service
argument_list|>
name|services
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
specifier|transient
name|Thread
name|shutdownHook
decl_stmt|;
specifier|private
name|String
index|[]
name|transportConnectorURIs
decl_stmt|;
specifier|private
name|String
index|[]
name|networkConnectorURIs
decl_stmt|;
specifier|private
name|JmsConnector
index|[]
name|jmsBridgeConnectors
decl_stmt|;
comment|// these are Jms to Jms bridges
comment|// to other jms messaging systems
specifier|private
name|boolean
name|deleteAllMessagesOnStartup
decl_stmt|;
specifier|private
name|boolean
name|advisorySupport
init|=
literal|true
decl_stmt|;
specifier|private
name|URI
name|vmConnectorURI
decl_stmt|;
specifier|private
name|String
name|defaultSocketURIString
decl_stmt|;
specifier|private
name|PolicyMap
name|destinationPolicy
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|started
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|stopped
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|stopping
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|preShutdownHooksInvoked
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
name|BrokerPlugin
index|[]
name|plugins
decl_stmt|;
specifier|private
name|boolean
name|keepDurableSubsActive
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|useVirtualTopics
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|useMirroredQueues
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|useTempMirroredQueues
init|=
literal|true
decl_stmt|;
comment|/**      * Whether or not virtual destination subscriptions should cause network demand      */
specifier|private
name|boolean
name|useVirtualDestSubs
init|=
literal|false
decl_stmt|;
comment|/**      * Whether or not the creation of destinations that match virtual destinations      * should cause network demand      */
specifier|private
name|boolean
name|useVirtualDestSubsOnCreation
init|=
literal|false
decl_stmt|;
specifier|private
name|BrokerId
name|brokerId
decl_stmt|;
specifier|private
specifier|volatile
name|DestinationInterceptor
index|[]
name|destinationInterceptors
decl_stmt|;
specifier|private
name|ActiveMQDestination
index|[]
name|destinations
decl_stmt|;
specifier|private
name|PListStore
name|tempDataStore
decl_stmt|;
specifier|private
name|int
name|persistenceThreadPriority
init|=
name|Thread
operator|.
name|MAX_PRIORITY
decl_stmt|;
specifier|private
name|boolean
name|useLocalHostBrokerName
decl_stmt|;
specifier|private
specifier|final
name|CountDownLatch
name|stoppedLatch
init|=
operator|new
name|CountDownLatch
argument_list|(
literal|1
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|CountDownLatch
name|startedLatch
init|=
operator|new
name|CountDownLatch
argument_list|(
literal|1
argument_list|)
decl_stmt|;
specifier|private
name|Broker
name|regionBroker
decl_stmt|;
specifier|private
name|int
name|producerSystemUsagePortion
init|=
literal|60
decl_stmt|;
specifier|private
name|int
name|consumerSystemUsagePortion
init|=
literal|40
decl_stmt|;
specifier|private
name|boolean
name|splitSystemUsageForProducersConsumers
decl_stmt|;
specifier|private
name|boolean
name|monitorConnectionSplits
init|=
literal|false
decl_stmt|;
specifier|private
name|int
name|taskRunnerPriority
init|=
name|Thread
operator|.
name|NORM_PRIORITY
decl_stmt|;
specifier|private
name|boolean
name|dedicatedTaskRunner
decl_stmt|;
specifier|private
name|boolean
name|cacheTempDestinations
init|=
literal|false
decl_stmt|;
comment|// useful for failover
specifier|private
name|int
name|timeBeforePurgeTempDestinations
init|=
literal|5000
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|Runnable
argument_list|>
name|shutdownHooks
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
name|boolean
name|systemExitOnShutdown
decl_stmt|;
specifier|private
name|int
name|systemExitOnShutdownExitCode
decl_stmt|;
specifier|private
name|SslContext
name|sslContext
decl_stmt|;
specifier|private
name|boolean
name|forceStart
init|=
literal|false
decl_stmt|;
specifier|private
name|IOExceptionHandler
name|ioExceptionHandler
decl_stmt|;
specifier|private
name|boolean
name|schedulerSupport
init|=
literal|false
decl_stmt|;
specifier|private
name|File
name|schedulerDirectoryFile
decl_stmt|;
specifier|private
name|Scheduler
name|scheduler
decl_stmt|;
specifier|private
name|ThreadPoolExecutor
name|executor
decl_stmt|;
specifier|private
name|int
name|schedulePeriodForDestinationPurge
init|=
literal|0
decl_stmt|;
specifier|private
name|int
name|maxPurgedDestinationsPerSweep
init|=
literal|0
decl_stmt|;
specifier|private
name|int
name|schedulePeriodForDiskUsageCheck
init|=
literal|0
decl_stmt|;
specifier|private
name|int
name|diskUsageCheckRegrowThreshold
init|=
operator|-
literal|1
decl_stmt|;
specifier|private
name|boolean
name|adjustUsageLimits
init|=
literal|true
decl_stmt|;
specifier|private
name|BrokerContext
name|brokerContext
decl_stmt|;
specifier|private
name|boolean
name|networkConnectorStartAsync
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|allowTempAutoCreationOnSend
decl_stmt|;
specifier|private
name|JobSchedulerStore
name|jobSchedulerStore
decl_stmt|;
specifier|private
specifier|final
name|AtomicLong
name|totalConnections
init|=
operator|new
name|AtomicLong
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|AtomicInteger
name|currentConnections
init|=
operator|new
name|AtomicInteger
argument_list|()
decl_stmt|;
specifier|private
name|long
name|offlineDurableSubscriberTimeout
init|=
operator|-
literal|1
decl_stmt|;
specifier|private
name|long
name|offlineDurableSubscriberTaskSchedule
init|=
literal|300000
decl_stmt|;
specifier|private
name|DestinationFilter
name|virtualConsumerDestinationFilter
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|persistenceAdapterStarted
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
name|Throwable
name|startException
init|=
literal|null
decl_stmt|;
specifier|private
name|boolean
name|startAsync
init|=
literal|false
decl_stmt|;
specifier|private
name|Date
name|startDate
decl_stmt|;
specifier|private
name|boolean
name|slave
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|restartAllowed
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|restartRequested
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|rejectDurableConsumers
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|rollbackOnlyOnAsyncException
init|=
literal|true
decl_stmt|;
specifier|private
name|int
name|storeOpenWireVersion
init|=
name|OpenWireFormat
operator|.
name|DEFAULT_STORE_VERSION
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|Runnable
argument_list|>
name|preShutdownHooks
init|=
operator|new
name|CopyOnWriteArrayList
argument_list|<>
argument_list|()
decl_stmt|;
static|static
block|{
try|try
block|{
name|ClassLoader
name|loader
init|=
name|BrokerService
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
decl_stmt|;
name|Class
argument_list|<
name|?
argument_list|>
name|clazz
init|=
name|loader
operator|.
name|loadClass
argument_list|(
literal|"org.bouncycastle.jce.provider.BouncyCastleProvider"
argument_list|)
decl_stmt|;
name|Provider
name|bouncycastle
init|=
operator|(
name|Provider
operator|)
name|clazz
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|Security
operator|.
name|insertProviderAt
argument_list|(
name|bouncycastle
argument_list|,
name|Integer
operator|.
name|getInteger
argument_list|(
literal|"org.apache.activemq.broker.BouncyCastlePosition"
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Loaded the Bouncy Castle security provider."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
comment|// No BouncyCastle found so we use the default Java Security Provider
block|}
name|String
name|localHostName
init|=
literal|"localhost"
decl_stmt|;
try|try
block|{
name|localHostName
operator|=
name|InetAddressUtil
operator|.
name|getLocalHostName
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnknownHostException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to resolve localhost"
argument_list|)
expr_stmt|;
block|}
name|LOCAL_HOST_NAME
operator|=
name|localHostName
expr_stmt|;
name|String
name|version
init|=
literal|null
decl_stmt|;
try|try
init|(
name|InputStream
name|in
init|=
name|BrokerService
operator|.
name|class
operator|.
name|getResourceAsStream
argument_list|(
literal|"/org/apache/activemq/version.txt"
argument_list|)
init|)
block|{
if|if
condition|(
name|in
operator|!=
literal|null
condition|)
block|{
try|try
init|(
name|InputStreamReader
name|isr
init|=
operator|new
name|InputStreamReader
argument_list|(
name|in
argument_list|)
init|;                     BufferedReader reader = new BufferedReader(isr)
block|)
block|{
name|version
operator|=
name|reader
operator|.
name|readLine
argument_list|()
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error reading broker version "
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
name|BROKER_VERSION
operator|=
name|version
expr_stmt|;
block|}
end_class

begin_function
annotation|@
name|Override
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
literal|"BrokerService["
operator|+
name|getBrokerName
argument_list|()
operator|+
literal|"]"
return|;
block|}
end_function

begin_function
specifier|private
name|String
name|getBrokerVersion
parameter_list|()
block|{
name|String
name|version
init|=
name|ActiveMQConnectionMetaData
operator|.
name|PROVIDER_VERSION
decl_stmt|;
if|if
condition|(
name|version
operator|==
literal|null
condition|)
block|{
name|version
operator|=
name|BROKER_VERSION
expr_stmt|;
block|}
return|return
name|version
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new transport connector for the given bind address      *      * @return the newly created and added transport connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|TransportConnector
name|addConnector
parameter_list|(
name|String
name|bindAddress
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|addConnector
argument_list|(
operator|new
name|URI
argument_list|(
name|bindAddress
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new transport connector for the given bind address      *      * @return the newly created and added transport connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|TransportConnector
name|addConnector
parameter_list|(
name|URI
name|bindAddress
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|addConnector
argument_list|(
name|createTransportConnector
argument_list|(
name|bindAddress
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new transport connector for the given TransportServer transport      *      * @return the newly created and added transport connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|TransportConnector
name|addConnector
parameter_list|(
name|TransportServer
name|transport
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|addConnector
argument_list|(
operator|new
name|TransportConnector
argument_list|(
name|transport
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new transport connector      *      * @return the transport connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|TransportConnector
name|addConnector
parameter_list|(
name|TransportConnector
name|connector
parameter_list|)
throws|throws
name|Exception
block|{
name|transportConnectors
operator|.
name|add
argument_list|(
name|connector
argument_list|)
expr_stmt|;
return|return
name|connector
return|;
block|}
end_function

begin_comment
comment|/**      * Stops and removes a transport connector from the broker.      *      * @param connector      * @return true if the connector has been previously added to the broker      * @throws Exception      */
end_comment

begin_function
specifier|public
name|boolean
name|removeConnector
parameter_list|(
name|TransportConnector
name|connector
parameter_list|)
throws|throws
name|Exception
block|{
name|boolean
name|rc
init|=
name|transportConnectors
operator|.
name|remove
argument_list|(
name|connector
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|unregisterConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new network connector using the given discovery address      *      * @return the newly created and added network connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|NetworkConnector
name|addNetworkConnector
parameter_list|(
name|String
name|discoveryAddress
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|addNetworkConnector
argument_list|(
operator|new
name|URI
argument_list|(
name|discoveryAddress
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new proxy connector using the given bind address      *      * @return the newly created and added network connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|ProxyConnector
name|addProxyConnector
parameter_list|(
name|String
name|bindAddress
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|addProxyConnector
argument_list|(
operator|new
name|URI
argument_list|(
name|bindAddress
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new network connector using the given discovery address      *      * @return the newly created and added network connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|NetworkConnector
name|addNetworkConnector
parameter_list|(
name|URI
name|discoveryAddress
parameter_list|)
throws|throws
name|Exception
block|{
name|NetworkConnector
name|connector
init|=
operator|new
name|DiscoveryNetworkConnector
argument_list|(
name|discoveryAddress
argument_list|)
decl_stmt|;
return|return
name|addNetworkConnector
argument_list|(
name|connector
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new proxy connector using the given bind address      *      * @return the newly created and added network connector      * @throws Exception      */
end_comment

begin_function
specifier|public
name|ProxyConnector
name|addProxyConnector
parameter_list|(
name|URI
name|bindAddress
parameter_list|)
throws|throws
name|Exception
block|{
name|ProxyConnector
name|connector
init|=
operator|new
name|ProxyConnector
argument_list|()
decl_stmt|;
name|connector
operator|.
name|setBind
argument_list|(
name|bindAddress
argument_list|)
expr_stmt|;
name|connector
operator|.
name|setRemote
argument_list|(
operator|new
name|URI
argument_list|(
literal|"fanout:multicast://default"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|addProxyConnector
argument_list|(
name|connector
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a new network connector to connect this broker to a federated      * network      */
end_comment

begin_function
specifier|public
name|NetworkConnector
name|addNetworkConnector
parameter_list|(
name|NetworkConnector
name|connector
parameter_list|)
throws|throws
name|Exception
block|{
name|connector
operator|.
name|setBrokerService
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connector
operator|.
name|setLocalUri
argument_list|(
name|getVmConnectorURI
argument_list|()
argument_list|)
expr_stmt|;
comment|// Set a connection filter so that the connector does not establish loop
comment|// back connections.
name|connector
operator|.
name|setConnectionFilter
argument_list|(
operator|new
name|ConnectionFilter
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|boolean
name|connectTo
parameter_list|(
name|URI
name|location
parameter_list|)
block|{
name|List
argument_list|<
name|TransportConnector
argument_list|>
name|transportConnectors
init|=
name|getTransportConnectors
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
argument_list|<
name|TransportConnector
argument_list|>
name|iter
init|=
name|transportConnectors
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
try|try
block|{
name|TransportConnector
name|tc
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|location
operator|.
name|equals
argument_list|(
name|tc
operator|.
name|getConnectUri
argument_list|()
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{                     }
block|}
return|return
literal|true
return|;
block|}
block|}
argument_list|)
expr_stmt|;
name|networkConnectors
operator|.
name|add
argument_list|(
name|connector
argument_list|)
expr_stmt|;
return|return
name|connector
return|;
block|}
end_function

begin_comment
comment|/**      * Removes the given network connector without stopping it. The caller      * should call {@link NetworkConnector#stop()} to close the connector      */
end_comment

begin_function
specifier|public
name|boolean
name|removeNetworkConnector
parameter_list|(
name|NetworkConnector
name|connector
parameter_list|)
block|{
name|boolean
name|answer
init|=
name|networkConnectors
operator|.
name|remove
argument_list|(
name|connector
argument_list|)
decl_stmt|;
if|if
condition|(
name|answer
condition|)
block|{
name|unregisterNetworkConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
return|return
name|answer
return|;
block|}
end_function

begin_function
specifier|public
name|ProxyConnector
name|addProxyConnector
parameter_list|(
name|ProxyConnector
name|connector
parameter_list|)
throws|throws
name|Exception
block|{
name|URI
name|uri
init|=
name|getVmConnectorURI
argument_list|()
decl_stmt|;
name|connector
operator|.
name|setLocalUri
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|proxyConnectors
operator|.
name|add
argument_list|(
name|connector
argument_list|)
expr_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|registerProxyConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
return|return
name|connector
return|;
block|}
end_function

begin_function
specifier|public
name|JmsConnector
name|addJmsConnector
parameter_list|(
name|JmsConnector
name|connector
parameter_list|)
throws|throws
name|Exception
block|{
name|connector
operator|.
name|setBrokerService
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|jmsConnectors
operator|.
name|add
argument_list|(
name|connector
argument_list|)
expr_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|registerJmsConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
return|return
name|connector
return|;
block|}
end_function

begin_comment
comment|/**      * Adds a {@link Runnable} hook that will be invoked before the      * broker is stopped. This allows performing cleanup actions      * before the broker is stopped. The hook should not throw      * exceptions or block.      */
end_comment

begin_function
specifier|public
specifier|final
name|void
name|addPreShutdownHook
parameter_list|(
specifier|final
name|Runnable
name|hook
parameter_list|)
block|{
name|preShutdownHooks
operator|.
name|add
argument_list|(
name|hook
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|JmsConnector
name|removeJmsConnector
parameter_list|(
name|JmsConnector
name|connector
parameter_list|)
block|{
if|if
condition|(
name|jmsConnectors
operator|.
name|remove
argument_list|(
name|connector
argument_list|)
condition|)
block|{
return|return
name|connector
return|;
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|masterFailed
parameter_list|()
block|{
if|if
condition|(
name|shutdownOnMasterFailure
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"The Master has failed ... shutting down"
argument_list|)
expr_stmt|;
try|try
block|{
name|stop
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to stop for master failure"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Master Failed - starting all connectors"
argument_list|)
expr_stmt|;
try|try
block|{
name|startAllConnectors
argument_list|()
expr_stmt|;
name|broker
operator|.
name|nowMasterBroker
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to startAllConnectors"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|public
name|String
name|getUptime
parameter_list|()
block|{
name|long
name|delta
init|=
name|getUptimeMillis
argument_list|()
decl_stmt|;
if|if
condition|(
name|delta
operator|==
literal|0
condition|)
block|{
return|return
literal|"not started"
return|;
block|}
return|return
name|TimeUtils
operator|.
name|printDuration
argument_list|(
name|delta
argument_list|)
return|;
block|}
end_function

begin_function
specifier|public
name|long
name|getUptimeMillis
parameter_list|()
block|{
if|if
condition|(
name|startDate
operator|==
literal|null
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
operator|new
name|Date
argument_list|()
operator|.
name|getTime
argument_list|()
operator|-
name|startDate
operator|.
name|getTime
argument_list|()
return|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isStarted
parameter_list|()
block|{
return|return
name|started
operator|.
name|get
argument_list|()
operator|&&
name|startedLatch
operator|.
name|getCount
argument_list|()
operator|==
literal|0
return|;
block|}
end_function

begin_comment
comment|/**      * Forces a start of the broker.      * By default a BrokerService instance that was      * previously stopped using BrokerService.stop() cannot be restarted      * using BrokerService.start().      * This method enforces a restart.      * It is not recommended to force a restart of the broker and will not work      * for most but some very trivial broker configurations.      * For restarting a broker instance we recommend to first call stop() on      * the old instance and then recreate a new BrokerService instance.      *      * @param force - if true enforces a restart.      * @throws Exception      */
end_comment

begin_function
specifier|public
name|void
name|start
parameter_list|(
name|boolean
name|force
parameter_list|)
throws|throws
name|Exception
block|{
name|forceStart
operator|=
name|force
expr_stmt|;
name|stopped
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|started
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|start
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|// Service interface
end_comment

begin_comment
comment|// -------------------------------------------------------------------------
end_comment

begin_function
specifier|protected
name|boolean
name|shouldAutostart
parameter_list|()
block|{
return|return
literal|true
return|;
block|}
end_function

begin_comment
comment|/**      * JSR-250 callback wrapper; converts checked exceptions to runtime exceptions      *      * delegates to autoStart, done to prevent backwards incompatible signature change      */
end_comment

begin_function
annotation|@
name|PostConstruct
specifier|private
name|void
name|postConstruct
parameter_list|()
block|{
try|try
block|{
name|autoStart
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|ex
argument_list|)
throw|;
block|}
block|}
end_function

begin_comment
comment|/**      *      * @throws Exception      * @org. apache.xbean.InitMethod      */
end_comment

begin_function
specifier|public
name|void
name|autoStart
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|shouldAutostart
argument_list|()
condition|)
block|{
name|start
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
annotation|@
name|Override
specifier|public
name|void
name|start
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|stopped
operator|.
name|get
argument_list|()
operator|||
operator|!
name|started
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
comment|// lets just ignore redundant start() calls
comment|// as its way too easy to not be completely sure if start() has been
comment|// called or not with the gazillion of different configuration
comment|// mechanisms
comment|// throw new IllegalStateException("Already started.");
return|return;
block|}
name|setStartException
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|stopping
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|preShutdownHooksInvoked
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|startDate
operator|=
operator|new
name|Date
argument_list|()
expr_stmt|;
name|MDC
operator|.
name|put
argument_list|(
literal|"activemq.broker"
argument_list|,
name|brokerName
argument_list|)
expr_stmt|;
try|try
block|{
name|checkMemorySystemUsageLimits
argument_list|()
expr_stmt|;
if|if
condition|(
name|systemExitOnShutdown
operator|&&
name|useShutdownHook
condition|)
block|{
throw|throw
operator|new
name|ConfigurationException
argument_list|(
literal|"'useShutdownHook' property cannot be be used with 'systemExitOnShutdown', please turn it off (useShutdownHook=false)"
argument_list|)
throw|;
block|}
name|processHelperProperties
argument_list|()
expr_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
comment|// need to remove MDC during starting JMX, as that would otherwise causes leaks, as spawned threads inheirt the MDC and
comment|// we cannot cleanup clear that during shutdown of the broker.
name|MDC
operator|.
name|remove
argument_list|(
literal|"activemq.broker"
argument_list|)
expr_stmt|;
try|try
block|{
name|startManagementContext
argument_list|()
expr_stmt|;
for|for
control|(
name|NetworkConnector
name|connector
range|:
name|getNetworkConnectors
argument_list|()
control|)
block|{
name|registerNetworkConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|MDC
operator|.
name|put
argument_list|(
literal|"activemq.broker"
argument_list|,
name|brokerName
argument_list|)
expr_stmt|;
block|}
block|}
comment|// in jvm master slave, lets not publish over existing broker till we get the lock
specifier|final
name|BrokerRegistry
name|brokerRegistry
init|=
name|BrokerRegistry
operator|.
name|getInstance
argument_list|()
decl_stmt|;
if|if
condition|(
name|brokerRegistry
operator|.
name|lookup
argument_list|(
name|getBrokerName
argument_list|()
argument_list|)
operator|==
literal|null
condition|)
block|{
name|brokerRegistry
operator|.
name|bind
argument_list|(
name|getBrokerName
argument_list|()
argument_list|,
name|BrokerService
operator|.
name|this
argument_list|)
expr_stmt|;
block|}
name|startPersistenceAdapter
argument_list|(
name|startAsync
argument_list|)
expr_stmt|;
name|startBroker
argument_list|(
name|startAsync
argument_list|)
expr_stmt|;
name|brokerRegistry
operator|.
name|bind
argument_list|(
name|getBrokerName
argument_list|()
argument_list|,
name|BrokerService
operator|.
name|this
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to start Apache ActiveMQ ({}, {})"
argument_list|,
name|getBrokerName
argument_list|()
argument_list|,
name|brokerId
argument_list|,
name|e
argument_list|)
expr_stmt|;
try|try
block|{
if|if
condition|(
operator|!
name|stopped
operator|.
name|get
argument_list|()
condition|)
block|{
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Failed to stop broker after failure in start. This exception will be ignored."
argument_list|,
name|ex
argument_list|)
expr_stmt|;
block|}
throw|throw
name|e
throw|;
block|}
finally|finally
block|{
name|MDC
operator|.
name|remove
argument_list|(
literal|"activemq.broker"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|private
name|void
name|startPersistenceAdapter
parameter_list|(
name|boolean
name|async
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|async
condition|)
block|{
operator|new
name|Thread
argument_list|(
literal|"Persistence Adapter Starting Thread"
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|doStartPersistenceAdapter
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|setStartException
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
synchronized|synchronized
init|(
name|persistenceAdapterStarted
init|)
block|{
name|persistenceAdapterStarted
operator|.
name|set
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|persistenceAdapterStarted
operator|.
name|notifyAll
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|doStartPersistenceAdapter
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|private
name|void
name|doStartPersistenceAdapter
parameter_list|()
throws|throws
name|Exception
block|{
name|PersistenceAdapter
name|persistenceAdapterToStart
init|=
name|getPersistenceAdapter
argument_list|()
decl_stmt|;
if|if
condition|(
name|persistenceAdapterToStart
operator|==
literal|null
condition|)
block|{
name|checkStartException
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|ConfigurationException
argument_list|(
literal|"Cannot start null persistence adapter"
argument_list|)
throw|;
block|}
name|persistenceAdapterToStart
operator|.
name|setUsageManager
argument_list|(
name|getProducerSystemUsage
argument_list|()
argument_list|)
expr_stmt|;
name|persistenceAdapterToStart
operator|.
name|setBrokerName
argument_list|(
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Using Persistence Adapter: {}"
argument_list|,
name|persistenceAdapterToStart
argument_list|)
expr_stmt|;
if|if
condition|(
name|deleteAllMessagesOnStartup
condition|)
block|{
name|deleteAllMessages
argument_list|()
expr_stmt|;
block|}
name|persistenceAdapterToStart
operator|.
name|start
argument_list|()
expr_stmt|;
name|getTempDataStore
argument_list|()
expr_stmt|;
if|if
condition|(
name|tempDataStore
operator|!=
literal|null
condition|)
block|{
try|try
block|{
comment|// start after we have the store lock
name|tempDataStore
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|RuntimeException
name|exception
init|=
operator|new
name|RuntimeException
argument_list|(
literal|"Failed to start temp data store: "
operator|+
name|tempDataStore
argument_list|,
name|e
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|exception
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
name|exception
throw|;
block|}
block|}
name|getJobSchedulerStore
argument_list|()
expr_stmt|;
if|if
condition|(
name|jobSchedulerStore
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|jobSchedulerStore
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|RuntimeException
name|exception
init|=
operator|new
name|RuntimeException
argument_list|(
literal|"Failed to start job scheduler store: "
operator|+
name|jobSchedulerStore
argument_list|,
name|e
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|exception
operator|.
name|getLocalizedMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
name|exception
throw|;
block|}
block|}
block|}
end_function

begin_function
specifier|private
name|void
name|startBroker
parameter_list|(
name|boolean
name|async
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|async
condition|)
block|{
operator|new
name|Thread
argument_list|(
literal|"Broker Starting Thread"
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
synchronized|synchronized
init|(
name|persistenceAdapterStarted
init|)
block|{
if|if
condition|(
operator|!
name|persistenceAdapterStarted
operator|.
name|get
argument_list|()
condition|)
block|{
name|persistenceAdapterStarted
operator|.
name|wait
argument_list|()
expr_stmt|;
block|}
block|}
name|doStartBroker
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|setStartException
argument_list|(
name|t
argument_list|)
expr_stmt|;
block|}
block|}
block|}
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|doStartBroker
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|private
name|void
name|doStartBroker
parameter_list|()
throws|throws
name|Exception
block|{
name|checkStartException
argument_list|()
expr_stmt|;
name|startDestinations
argument_list|()
expr_stmt|;
name|addShutdownHook
argument_list|()
expr_stmt|;
name|broker
operator|=
name|getBroker
argument_list|()
expr_stmt|;
name|brokerId
operator|=
name|broker
operator|.
name|getBrokerId
argument_list|()
expr_stmt|;
comment|// need to log this after creating the broker so we have its id and name
name|LOG
operator|.
name|info
argument_list|(
literal|"Apache ActiveMQ {} ({}, {}) is starting"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|getBrokerVersion
argument_list|()
block|,
name|getBrokerName
argument_list|()
block|,
name|brokerId
block|}
argument_list|)
expr_stmt|;
name|broker
operator|.
name|start
argument_list|()
expr_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
if|if
condition|(
name|getManagementContext
argument_list|()
operator|.
name|isCreateConnector
argument_list|()
operator|&&
operator|!
name|getManagementContext
argument_list|()
operator|.
name|isConnectorStarted
argument_list|()
condition|)
block|{
comment|// try to restart management context
comment|// typical for slaves that use the same ports as master
name|managementContext
operator|.
name|stop
argument_list|()
expr_stmt|;
name|startManagementContext
argument_list|()
expr_stmt|;
block|}
name|ManagedRegionBroker
name|managedBroker
init|=
operator|(
name|ManagedRegionBroker
operator|)
name|regionBroker
decl_stmt|;
name|managedBroker
operator|.
name|setContextBroker
argument_list|(
name|broker
argument_list|)
expr_stmt|;
name|adminView
operator|.
name|setBroker
argument_list|(
name|managedBroker
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioExceptionHandler
operator|==
literal|null
condition|)
block|{
name|setIoExceptionHandler
argument_list|(
operator|new
name|DefaultIOExceptionHandler
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isUseJmx
argument_list|()
operator|&&
name|Log4JConfigView
operator|.
name|isLog4JAvailable
argument_list|()
condition|)
block|{
name|ObjectName
name|objectName
init|=
name|BrokerMBeanSupport
operator|.
name|createLog4JConfigViewName
argument_list|(
name|getBrokerObjectName
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|Log4JConfigView
name|log4jConfigView
init|=
operator|new
name|Log4JConfigView
argument_list|()
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|log4jConfigView
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
block|}
name|startAllConnectors
argument_list|()
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Apache ActiveMQ {} ({}, {}) started"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|getBrokerVersion
argument_list|()
block|,
name|getBrokerName
argument_list|()
block|,
name|brokerId
block|}
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"For help or more information please see: http://activemq.apache.org"
argument_list|)
expr_stmt|;
name|getBroker
argument_list|()
operator|.
name|brokerServiceStarted
argument_list|()
expr_stmt|;
name|checkStoreSystemUsageLimits
argument_list|()
expr_stmt|;
name|startedLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
name|getBroker
argument_list|()
operator|.
name|nowMasterBroker
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * JSR-250 callback wrapper; converts checked exceptions to runtime exceptions      *      * delegates to stop, done to prevent backwards incompatible signature change      */
end_comment

begin_function
annotation|@
name|PreDestroy
specifier|private
name|void
name|preDestroy
parameter_list|()
block|{
try|try
block|{
name|stop
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|()
throw|;
block|}
block|}
end_function

begin_comment
comment|/**      *      * @throws Exception      * @org.apache .xbean.DestroyMethod      */
end_comment

begin_function
annotation|@
name|Override
specifier|public
name|void
name|stop
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|ServiceStopper
name|stopper
init|=
operator|new
name|ServiceStopper
argument_list|()
decl_stmt|;
comment|//The preShutdownHooks need to run before stopping.compareAndSet()
comment|//so there is a separate AtomicBoolean so the hooks only run once
comment|//We want to make sure the hooks are run before stop is initialized
comment|//including setting the stopping variable - See AMQ-6706
if|if
condition|(
name|preShutdownHooksInvoked
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
for|for
control|(
name|Runnable
name|hook
range|:
name|preShutdownHooks
control|)
block|{
try|try
block|{
name|hook
operator|.
name|run
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|stopper
operator|.
name|onException
argument_list|(
name|hook
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|stopping
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Broker already stopping/stopped"
argument_list|)
expr_stmt|;
return|return;
block|}
name|setStartException
argument_list|(
operator|new
name|BrokerStoppedException
argument_list|(
literal|"Stop invoked"
argument_list|)
argument_list|)
expr_stmt|;
name|MDC
operator|.
name|put
argument_list|(
literal|"activemq.broker"
argument_list|,
name|brokerName
argument_list|)
expr_stmt|;
if|if
condition|(
name|systemExitOnShutdown
condition|)
block|{
operator|new
name|Thread
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|System
operator|.
name|exit
argument_list|(
name|systemExitOnShutdownExitCode
argument_list|)
expr_stmt|;
block|}
block|}
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Apache ActiveMQ {} ({}, {}) is shutting down"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|getBrokerVersion
argument_list|()
block|,
name|getBrokerName
argument_list|()
block|,
name|brokerId
block|}
argument_list|)
expr_stmt|;
name|removeShutdownHook
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|scheduler
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|scheduler
operator|.
name|stop
argument_list|()
expr_stmt|;
name|this
operator|.
name|scheduler
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|services
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|Service
name|service
range|:
name|services
control|)
block|{
name|stopper
operator|.
name|stop
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
block|}
name|stopAllConnectors
argument_list|(
name|stopper
argument_list|)
expr_stmt|;
name|this
operator|.
name|slave
operator|=
literal|true
expr_stmt|;
comment|// remove any VMTransports connected
comment|// this has to be done after services are stopped,
comment|// to avoid timing issue with discovery (spinning up a new instance)
name|BrokerRegistry
operator|.
name|getInstance
argument_list|()
operator|.
name|unbind
argument_list|(
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
name|VMTransportFactory
operator|.
name|stopped
argument_list|(
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|broker
operator|!=
literal|null
condition|)
block|{
name|stopper
operator|.
name|stop
argument_list|(
name|broker
argument_list|)
expr_stmt|;
name|broker
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|jobSchedulerStore
operator|!=
literal|null
condition|)
block|{
name|jobSchedulerStore
operator|.
name|stop
argument_list|()
expr_stmt|;
name|jobSchedulerStore
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|tempDataStore
operator|!=
literal|null
condition|)
block|{
name|tempDataStore
operator|.
name|stop
argument_list|()
expr_stmt|;
name|tempDataStore
operator|=
literal|null
expr_stmt|;
block|}
try|try
block|{
name|stopper
operator|.
name|stop
argument_list|(
name|getPersistenceAdapter
argument_list|()
argument_list|)
expr_stmt|;
name|persistenceAdapter
operator|=
literal|null
expr_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|stopper
operator|.
name|stop
argument_list|(
name|managementContext
argument_list|)
expr_stmt|;
name|managementContext
operator|=
literal|null
expr_stmt|;
block|}
comment|// Clear SelectorParser cache to free memory
name|SelectorParser
operator|.
name|clearCache
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|started
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|stopped
operator|.
name|set
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|stoppedLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|this
operator|.
name|taskRunnerFactory
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|taskRunnerFactory
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|this
operator|.
name|taskRunnerFactory
operator|=
literal|null
expr_stmt|;
block|}
if|if
condition|(
name|this
operator|.
name|executor
operator|!=
literal|null
condition|)
block|{
name|ThreadPoolUtils
operator|.
name|shutdownNow
argument_list|(
name|executor
argument_list|)
expr_stmt|;
name|this
operator|.
name|executor
operator|=
literal|null
expr_stmt|;
block|}
name|this
operator|.
name|destinationInterceptors
operator|=
literal|null
expr_stmt|;
name|this
operator|.
name|destinationFactory
operator|=
literal|null
expr_stmt|;
if|if
condition|(
name|startDate
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Apache ActiveMQ {} ({}, {}) uptime {}"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|getBrokerVersion
argument_list|()
block|,
name|getBrokerName
argument_list|()
block|,
name|brokerId
block|,
name|getUptime
argument_list|()
block|}
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Apache ActiveMQ {} ({}, {}) is shutdown"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|getBrokerVersion
argument_list|()
block|,
name|getBrokerName
argument_list|()
block|,
name|brokerId
block|}
argument_list|)
expr_stmt|;
synchronized|synchronized
init|(
name|shutdownHooks
init|)
block|{
for|for
control|(
name|Runnable
name|hook
range|:
name|shutdownHooks
control|)
block|{
try|try
block|{
name|hook
operator|.
name|run
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|stopper
operator|.
name|onException
argument_list|(
name|hook
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|MDC
operator|.
name|remove
argument_list|(
literal|"activemq.broker"
argument_list|)
expr_stmt|;
comment|// and clear start date
name|startDate
operator|=
literal|null
expr_stmt|;
name|stopper
operator|.
name|throwFirstException
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|checkQueueSize
parameter_list|(
name|String
name|queueName
parameter_list|)
block|{
name|long
name|count
init|=
literal|0
decl_stmt|;
name|long
name|queueSize
init|=
literal|0
decl_stmt|;
name|Map
argument_list|<
name|ActiveMQDestination
argument_list|,
name|Destination
argument_list|>
name|destinationMap
init|=
name|regionBroker
operator|.
name|getDestinationMap
argument_list|()
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|ActiveMQDestination
argument_list|,
name|Destination
argument_list|>
name|entry
range|:
name|destinationMap
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|isQueue
argument_list|()
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|getValue
argument_list|()
operator|.
name|getName
argument_list|()
operator|.
name|matches
argument_list|(
name|queueName
argument_list|)
condition|)
block|{
name|queueSize
operator|=
name|entry
operator|.
name|getValue
argument_list|()
operator|.
name|getDestinationStatistics
argument_list|()
operator|.
name|getMessages
argument_list|()
operator|.
name|getCount
argument_list|()
expr_stmt|;
name|count
operator|+=
name|queueSize
expr_stmt|;
if|if
condition|(
name|queueSize
operator|>
literal|0
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Queue has pending message: {} queueSize is: {}"
argument_list|,
name|entry
operator|.
name|getValue
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|,
name|queueSize
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|count
operator|==
literal|0
return|;
block|}
end_function

begin_comment
comment|/**      * This method (both connectorName and queueName are using regex to match)      * 1. stop the connector (supposed the user input the connector which the      * clients connect to) 2. to check whether there is any pending message on      * the queues defined by queueName 3. supposedly, after stop the connector,      * client should failover to other broker and pending messages should be      * forwarded. if no pending messages, the method finally call stop to stop      * the broker.      *      * @param connectorName      * @param queueName      * @param timeout      * @param pollInterval      * @throws Exception      */
end_comment

begin_function
specifier|public
name|void
name|stopGracefully
parameter_list|(
name|String
name|connectorName
parameter_list|,
name|String
name|queueName
parameter_list|,
name|long
name|timeout
parameter_list|,
name|long
name|pollInterval
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
if|if
condition|(
name|connectorName
operator|==
literal|null
operator|||
name|queueName
operator|==
literal|null
operator|||
name|timeout
operator|<=
literal|0
condition|)
block|{
throw|throw
operator|new
name|Exception
argument_list|(
literal|"connectorName and queueName cannot be null and timeout should be>0 for stopGracefully."
argument_list|)
throw|;
block|}
if|if
condition|(
name|pollInterval
operator|<=
literal|0
condition|)
block|{
name|pollInterval
operator|=
literal|30
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Stop gracefully with connectorName: {} queueName: {} timeout: {} pollInterval: {}"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|connectorName
block|,
name|queueName
block|,
name|timeout
block|,
name|pollInterval
block|}
argument_list|)
expr_stmt|;
name|TransportConnector
name|connector
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|transportConnectors
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|connector
operator|=
name|transportConnectors
operator|.
name|get
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|connector
operator|!=
literal|null
operator|&&
name|connector
operator|.
name|getName
argument_list|()
operator|!=
literal|null
operator|&&
name|connector
operator|.
name|getName
argument_list|()
operator|.
name|matches
argument_list|(
name|connectorName
argument_list|)
condition|)
block|{
name|connector
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
while|while
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|start
operator|<
name|timeout
operator|*
literal|1000
condition|)
block|{
comment|// check quesize until it gets zero
if|if
condition|(
name|checkQueueSize
argument_list|(
name|queueName
argument_list|)
condition|)
block|{
name|stop
argument_list|()
expr_stmt|;
break|break;
block|}
else|else
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|pollInterval
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|stopped
operator|.
name|get
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Successfully stop the broker."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"There is still pending message on the queue. Please check and stop the broker manually."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * A helper method to block the caller thread until the broker has been      * stopped      */
end_comment

begin_function
specifier|public
name|void
name|waitUntilStopped
parameter_list|()
block|{
while|while
condition|(
name|isStarted
argument_list|()
operator|&&
operator|!
name|stopped
operator|.
name|get
argument_list|()
condition|)
block|{
try|try
block|{
name|stoppedLatch
operator|.
name|await
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
comment|// ignore
block|}
block|}
block|}
end_function

begin_function
specifier|public
name|boolean
name|isStopped
parameter_list|()
block|{
return|return
name|stopped
operator|.
name|get
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**      * A helper method to block the caller thread until the broker has fully started      * @return boolean true if wait succeeded false if broker was not started or was stopped      */
end_comment

begin_function
specifier|public
name|boolean
name|waitUntilStarted
parameter_list|()
block|{
return|return
name|waitUntilStarted
argument_list|(
name|DEFAULT_START_TIMEOUT
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * A helper method to block the caller thread until the broker has fully started      *      * @param timeout      *        the amount of time to wait before giving up and returning false.      *      * @return boolean true if wait succeeded false if broker was not started or was stopped      */
end_comment

begin_function
specifier|public
name|boolean
name|waitUntilStarted
parameter_list|(
name|long
name|timeout
parameter_list|)
block|{
name|boolean
name|waitSucceeded
init|=
name|isStarted
argument_list|()
decl_stmt|;
name|long
name|expiration
init|=
name|Math
operator|.
name|max
argument_list|(
literal|0
argument_list|,
name|timeout
operator|+
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|isStarted
argument_list|()
operator|&&
operator|!
name|stopped
operator|.
name|get
argument_list|()
operator|&&
operator|!
name|waitSucceeded
operator|&&
name|expiration
operator|>
name|System
operator|.
name|currentTimeMillis
argument_list|()
condition|)
block|{
try|try
block|{
if|if
condition|(
name|getStartException
argument_list|()
operator|!=
literal|null
condition|)
block|{
return|return
name|waitSucceeded
return|;
block|}
name|waitSucceeded
operator|=
name|startedLatch
operator|.
name|await
argument_list|(
literal|100L
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ignore
parameter_list|)
block|{             }
block|}
return|return
name|waitSucceeded
return|;
block|}
end_function

begin_comment
comment|// Properties
end_comment

begin_comment
comment|// -------------------------------------------------------------------------
end_comment

begin_comment
comment|/**      * Returns the message broker      */
end_comment

begin_function
specifier|public
name|Broker
name|getBroker
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|broker
operator|==
literal|null
condition|)
block|{
name|checkStartException
argument_list|()
expr_stmt|;
name|broker
operator|=
name|createBroker
argument_list|()
expr_stmt|;
block|}
return|return
name|broker
return|;
block|}
end_function

begin_comment
comment|/**      * Returns the administration view of the broker; used to create and destroy      * resources such as queues and topics. Note this method returns null if JMX      * is disabled.      */
end_comment

begin_function
specifier|public
name|BrokerView
name|getAdminView
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|adminView
operator|==
literal|null
condition|)
block|{
comment|// force lazy creation
name|getBroker
argument_list|()
expr_stmt|;
block|}
return|return
name|adminView
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setAdminView
parameter_list|(
name|BrokerView
name|adminView
parameter_list|)
block|{
name|this
operator|.
name|adminView
operator|=
name|adminView
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|String
name|getBrokerName
parameter_list|()
block|{
return|return
name|brokerName
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the name of this broker; which must be unique in the network      *      * @param brokerName      */
end_comment

begin_decl_stmt
specifier|private
specifier|static
specifier|final
name|String
name|brokerNameReplacedCharsRegExp
init|=
literal|"[^a-zA-Z0-9\\.\\_\\-\\:]"
decl_stmt|;
end_decl_stmt

begin_function
specifier|public
name|void
name|setBrokerName
parameter_list|(
name|String
name|brokerName
parameter_list|)
block|{
if|if
condition|(
name|brokerName
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"The broker name cannot be null"
argument_list|)
throw|;
block|}
name|String
name|str
init|=
name|brokerName
operator|.
name|replaceAll
argument_list|(
name|brokerNameReplacedCharsRegExp
argument_list|,
literal|"_"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|str
operator|.
name|equals
argument_list|(
name|brokerName
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Broker Name: {} contained illegal characters matching regExp: {} - replaced with {}"
argument_list|,
name|brokerName
argument_list|,
name|brokerNameReplacedCharsRegExp
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|brokerName
operator|=
name|str
operator|.
name|trim
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|PersistenceAdapterFactory
name|getPersistenceFactory
parameter_list|()
block|{
return|return
name|persistenceFactory
return|;
block|}
end_function

begin_function
specifier|public
name|File
name|getDataDirectoryFile
parameter_list|()
block|{
if|if
condition|(
name|dataDirectoryFile
operator|==
literal|null
condition|)
block|{
name|dataDirectoryFile
operator|=
operator|new
name|File
argument_list|(
name|IOHelper
operator|.
name|getDefaultDataDirectory
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|dataDirectoryFile
return|;
block|}
end_function

begin_function
specifier|public
name|File
name|getBrokerDataDirectory
parameter_list|()
block|{
name|String
name|brokerDir
init|=
name|getBrokerName
argument_list|()
decl_stmt|;
return|return
operator|new
name|File
argument_list|(
name|getDataDirectoryFile
argument_list|()
argument_list|,
name|brokerDir
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the directory in which the data files will be stored by default for      * the JDBC and Journal persistence adaptors.      *      * @param dataDirectory      *            the directory to store data files      */
end_comment

begin_function
specifier|public
name|void
name|setDataDirectory
parameter_list|(
name|String
name|dataDirectory
parameter_list|)
block|{
name|setDataDirectoryFile
argument_list|(
operator|new
name|File
argument_list|(
name|dataDirectory
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Sets the directory in which the data files will be stored by default for      * the JDBC and Journal persistence adaptors.      *      * @param dataDirectoryFile      *            the directory to store data files      */
end_comment

begin_function
specifier|public
name|void
name|setDataDirectoryFile
parameter_list|(
name|File
name|dataDirectoryFile
parameter_list|)
block|{
name|this
operator|.
name|dataDirectoryFile
operator|=
name|dataDirectoryFile
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the tmpDataDirectory      */
end_comment

begin_function
specifier|public
name|File
name|getTmpDataDirectory
parameter_list|()
block|{
if|if
condition|(
name|tmpDataDirectory
operator|==
literal|null
condition|)
block|{
name|tmpDataDirectory
operator|=
operator|new
name|File
argument_list|(
name|getBrokerDataDirectory
argument_list|()
argument_list|,
literal|"tmp_storage"
argument_list|)
expr_stmt|;
block|}
return|return
name|tmpDataDirectory
return|;
block|}
end_function

begin_comment
comment|/**      * @param tmpDataDirectory      *            the tmpDataDirectory to set      */
end_comment

begin_function
specifier|public
name|void
name|setTmpDataDirectory
parameter_list|(
name|File
name|tmpDataDirectory
parameter_list|)
block|{
name|this
operator|.
name|tmpDataDirectory
operator|=
name|tmpDataDirectory
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|setPersistenceFactory
parameter_list|(
name|PersistenceAdapterFactory
name|persistenceFactory
parameter_list|)
block|{
name|this
operator|.
name|persistenceFactory
operator|=
name|persistenceFactory
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|setDestinationFactory
parameter_list|(
name|DestinationFactory
name|destinationFactory
parameter_list|)
block|{
name|this
operator|.
name|destinationFactory
operator|=
name|destinationFactory
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isPersistent
parameter_list|()
block|{
return|return
name|persistent
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not persistence is enabled or disabled.      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setPersistent
parameter_list|(
name|boolean
name|persistent
parameter_list|)
block|{
name|this
operator|.
name|persistent
operator|=
name|persistent
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isPopulateJMSXUserID
parameter_list|()
block|{
return|return
name|populateJMSXUserID
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not the broker should populate the JMSXUserID header.      */
end_comment

begin_function
specifier|public
name|void
name|setPopulateJMSXUserID
parameter_list|(
name|boolean
name|populateJMSXUserID
parameter_list|)
block|{
name|this
operator|.
name|populateJMSXUserID
operator|=
name|populateJMSXUserID
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|SystemUsage
name|getSystemUsage
parameter_list|()
block|{
try|try
block|{
if|if
condition|(
name|systemUsage
operator|==
literal|null
condition|)
block|{
name|systemUsage
operator|=
operator|new
name|SystemUsage
argument_list|(
literal|"Main"
argument_list|,
name|getPersistenceAdapter
argument_list|()
argument_list|,
name|getTempDataStore
argument_list|()
argument_list|,
name|getJobSchedulerStore
argument_list|()
argument_list|)
expr_stmt|;
name|systemUsage
operator|.
name|setExecutor
argument_list|(
name|getExecutor
argument_list|()
argument_list|)
expr_stmt|;
name|systemUsage
operator|.
name|getMemoryUsage
argument_list|()
operator|.
name|setLimit
argument_list|(
literal|1024L
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|1
argument_list|)
expr_stmt|;
comment|// 1 GB
name|systemUsage
operator|.
name|getTempUsage
argument_list|()
operator|.
name|setLimit
argument_list|(
literal|1024L
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|50
argument_list|)
expr_stmt|;
comment|// 50 GB
name|systemUsage
operator|.
name|getStoreUsage
argument_list|()
operator|.
name|setLimit
argument_list|(
literal|1024L
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|100
argument_list|)
expr_stmt|;
comment|// 100 GB
name|systemUsage
operator|.
name|getJobSchedulerUsage
argument_list|()
operator|.
name|setLimit
argument_list|(
literal|1024L
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|50
argument_list|)
expr_stmt|;
comment|// 50 GB
name|addService
argument_list|(
name|this
operator|.
name|systemUsage
argument_list|)
expr_stmt|;
block|}
return|return
name|systemUsage
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Cannot create SystemUsage"
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"Fatally failed to create SystemUsage"
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|public
name|void
name|setSystemUsage
parameter_list|(
name|SystemUsage
name|memoryManager
parameter_list|)
block|{
if|if
condition|(
name|this
operator|.
name|systemUsage
operator|!=
literal|null
condition|)
block|{
name|removeService
argument_list|(
name|this
operator|.
name|systemUsage
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|systemUsage
operator|=
name|memoryManager
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|systemUsage
operator|.
name|getExecutor
argument_list|()
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|systemUsage
operator|.
name|setExecutor
argument_list|(
name|getExecutor
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|addService
argument_list|(
name|this
operator|.
name|systemUsage
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the consumerUsageManager      * @throws IOException      */
end_comment

begin_function
specifier|public
name|SystemUsage
name|getConsumerSystemUsage
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|this
operator|.
name|consumerSystemUsage
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|splitSystemUsageForProducersConsumers
condition|)
block|{
name|this
operator|.
name|consumerSystemUsage
operator|=
operator|new
name|SystemUsage
argument_list|(
name|getSystemUsage
argument_list|()
argument_list|,
literal|"Consumer"
argument_list|)
expr_stmt|;
name|float
name|portion
init|=
name|consumerSystemUsagePortion
operator|/
literal|100f
decl_stmt|;
name|this
operator|.
name|consumerSystemUsage
operator|.
name|getMemoryUsage
argument_list|()
operator|.
name|setUsagePortion
argument_list|(
name|portion
argument_list|)
expr_stmt|;
name|addService
argument_list|(
name|this
operator|.
name|consumerSystemUsage
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|consumerSystemUsage
operator|=
name|getSystemUsage
argument_list|()
expr_stmt|;
block|}
block|}
return|return
name|this
operator|.
name|consumerSystemUsage
return|;
block|}
end_function

begin_comment
comment|/**      * @param consumerSystemUsage      *            the storeSystemUsage to set      */
end_comment

begin_function
specifier|public
name|void
name|setConsumerSystemUsage
parameter_list|(
name|SystemUsage
name|consumerSystemUsage
parameter_list|)
block|{
if|if
condition|(
name|this
operator|.
name|consumerSystemUsage
operator|!=
literal|null
condition|)
block|{
name|removeService
argument_list|(
name|this
operator|.
name|consumerSystemUsage
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|consumerSystemUsage
operator|=
name|consumerSystemUsage
expr_stmt|;
name|addService
argument_list|(
name|this
operator|.
name|consumerSystemUsage
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the producerUsageManager      * @throws IOException      */
end_comment

begin_function
specifier|public
name|SystemUsage
name|getProducerSystemUsage
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|producerSystemUsage
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|splitSystemUsageForProducersConsumers
condition|)
block|{
name|producerSystemUsage
operator|=
operator|new
name|SystemUsage
argument_list|(
name|getSystemUsage
argument_list|()
argument_list|,
literal|"Producer"
argument_list|)
expr_stmt|;
name|float
name|portion
init|=
name|producerSystemUsagePortion
operator|/
literal|100f
decl_stmt|;
name|producerSystemUsage
operator|.
name|getMemoryUsage
argument_list|()
operator|.
name|setUsagePortion
argument_list|(
name|portion
argument_list|)
expr_stmt|;
name|addService
argument_list|(
name|producerSystemUsage
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|producerSystemUsage
operator|=
name|getSystemUsage
argument_list|()
expr_stmt|;
block|}
block|}
return|return
name|producerSystemUsage
return|;
block|}
end_function

begin_comment
comment|/**      * @param producerUsageManager      *            the producerUsageManager to set      */
end_comment

begin_function
specifier|public
name|void
name|setProducerSystemUsage
parameter_list|(
name|SystemUsage
name|producerUsageManager
parameter_list|)
block|{
if|if
condition|(
name|this
operator|.
name|producerSystemUsage
operator|!=
literal|null
condition|)
block|{
name|removeService
argument_list|(
name|this
operator|.
name|producerSystemUsage
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|producerSystemUsage
operator|=
name|producerUsageManager
expr_stmt|;
name|addService
argument_list|(
name|this
operator|.
name|producerSystemUsage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
specifier|synchronized
name|PersistenceAdapter
name|getPersistenceAdapter
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|persistenceAdapter
operator|==
literal|null
operator|&&
operator|!
name|hasStartException
argument_list|()
condition|)
block|{
name|persistenceAdapter
operator|=
name|createPersistenceAdapter
argument_list|()
expr_stmt|;
name|configureService
argument_list|(
name|persistenceAdapter
argument_list|)
expr_stmt|;
name|this
operator|.
name|persistenceAdapter
operator|=
name|registerPersistenceAdapterMBean
argument_list|(
name|persistenceAdapter
argument_list|)
expr_stmt|;
block|}
return|return
name|persistenceAdapter
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the persistence adaptor implementation to use for this broker      *      * @throws IOException      */
end_comment

begin_function
specifier|public
name|void
name|setPersistenceAdapter
parameter_list|(
name|PersistenceAdapter
name|persistenceAdapter
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|isPersistent
argument_list|()
operator|&&
operator|!
operator|(
name|persistenceAdapter
operator|instanceof
name|MemoryPersistenceAdapter
operator|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"persistent=\"false\", ignoring configured persistenceAdapter: {}"
argument_list|,
name|persistenceAdapter
argument_list|)
expr_stmt|;
return|return;
block|}
name|this
operator|.
name|persistenceAdapter
operator|=
name|persistenceAdapter
expr_stmt|;
name|configureService
argument_list|(
name|this
operator|.
name|persistenceAdapter
argument_list|)
expr_stmt|;
name|this
operator|.
name|persistenceAdapter
operator|=
name|registerPersistenceAdapterMBean
argument_list|(
name|persistenceAdapter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|TaskRunnerFactory
name|getTaskRunnerFactory
parameter_list|()
block|{
if|if
condition|(
name|this
operator|.
name|taskRunnerFactory
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|taskRunnerFactory
operator|=
operator|new
name|TaskRunnerFactory
argument_list|(
literal|"ActiveMQ BrokerService["
operator|+
name|getBrokerName
argument_list|()
operator|+
literal|"] Task"
argument_list|,
name|getTaskRunnerPriority
argument_list|()
argument_list|,
literal|true
argument_list|,
literal|1000
argument_list|,
name|isDedicatedTaskRunner
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|taskRunnerFactory
operator|.
name|setThreadClassLoader
argument_list|(
name|this
operator|.
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|this
operator|.
name|taskRunnerFactory
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setTaskRunnerFactory
parameter_list|(
name|TaskRunnerFactory
name|taskRunnerFactory
parameter_list|)
block|{
name|this
operator|.
name|taskRunnerFactory
operator|=
name|taskRunnerFactory
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|TaskRunnerFactory
name|getPersistenceTaskRunnerFactory
parameter_list|()
block|{
if|if
condition|(
name|taskRunnerFactory
operator|==
literal|null
condition|)
block|{
name|persistenceTaskRunnerFactory
operator|=
operator|new
name|TaskRunnerFactory
argument_list|(
literal|"Persistence Adaptor Task"
argument_list|,
name|persistenceThreadPriority
argument_list|,
literal|true
argument_list|,
literal|1000
argument_list|,
name|isDedicatedTaskRunner
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|persistenceTaskRunnerFactory
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setPersistenceTaskRunnerFactory
parameter_list|(
name|TaskRunnerFactory
name|persistenceTaskRunnerFactory
parameter_list|)
block|{
name|this
operator|.
name|persistenceTaskRunnerFactory
operator|=
name|persistenceTaskRunnerFactory
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseJmx
parameter_list|()
block|{
return|return
name|useJmx
return|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isEnableStatistics
parameter_list|()
block|{
return|return
name|enableStatistics
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not the Broker's services enable statistics or not.      */
end_comment

begin_function
specifier|public
name|void
name|setEnableStatistics
parameter_list|(
name|boolean
name|enableStatistics
parameter_list|)
block|{
name|this
operator|.
name|enableStatistics
operator|=
name|enableStatistics
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not the Broker's services should be exposed into JMX or      * not.      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setUseJmx
parameter_list|(
name|boolean
name|useJmx
parameter_list|)
block|{
name|this
operator|.
name|useJmx
operator|=
name|useJmx
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|ObjectName
name|getBrokerObjectName
parameter_list|()
throws|throws
name|MalformedObjectNameException
block|{
if|if
condition|(
name|brokerObjectName
operator|==
literal|null
condition|)
block|{
name|brokerObjectName
operator|=
name|createBrokerObjectName
argument_list|()
expr_stmt|;
block|}
return|return
name|brokerObjectName
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the JMX ObjectName for this broker      */
end_comment

begin_function
specifier|public
name|void
name|setBrokerObjectName
parameter_list|(
name|ObjectName
name|brokerObjectName
parameter_list|)
block|{
name|this
operator|.
name|brokerObjectName
operator|=
name|brokerObjectName
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|ManagementContext
name|getManagementContext
parameter_list|()
block|{
if|if
condition|(
name|managementContext
operator|==
literal|null
condition|)
block|{
name|checkStartException
argument_list|()
expr_stmt|;
name|managementContext
operator|=
operator|new
name|ManagementContext
argument_list|()
expr_stmt|;
block|}
return|return
name|managementContext
return|;
block|}
end_function

begin_function
specifier|synchronized
specifier|private
name|void
name|checkStartException
parameter_list|()
block|{
if|if
condition|(
name|startException
operator|!=
literal|null
condition|)
block|{
throw|throw
operator|new
name|BrokerStoppedException
argument_list|(
name|startException
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|synchronized
specifier|private
name|boolean
name|hasStartException
parameter_list|()
block|{
return|return
name|startException
operator|!=
literal|null
return|;
block|}
end_function

begin_function
specifier|synchronized
specifier|private
name|void
name|setStartException
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|startException
operator|=
name|t
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|setManagementContext
parameter_list|(
name|ManagementContext
name|managementContext
parameter_list|)
block|{
name|this
operator|.
name|managementContext
operator|=
name|managementContext
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|NetworkConnector
name|getNetworkConnectorByName
parameter_list|(
name|String
name|connectorName
parameter_list|)
block|{
for|for
control|(
name|NetworkConnector
name|connector
range|:
name|networkConnectors
control|)
block|{
if|if
condition|(
name|connector
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|connectorName
argument_list|)
condition|)
block|{
return|return
name|connector
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
specifier|public
name|String
index|[]
name|getNetworkConnectorURIs
parameter_list|()
block|{
return|return
name|networkConnectorURIs
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setNetworkConnectorURIs
parameter_list|(
name|String
index|[]
name|networkConnectorURIs
parameter_list|)
block|{
name|this
operator|.
name|networkConnectorURIs
operator|=
name|networkConnectorURIs
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|TransportConnector
name|getConnectorByName
parameter_list|(
name|String
name|connectorName
parameter_list|)
block|{
for|for
control|(
name|TransportConnector
name|connector
range|:
name|transportConnectors
control|)
block|{
if|if
condition|(
name|connector
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|connectorName
argument_list|)
condition|)
block|{
return|return
name|connector
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|getTransportConnectorURIsAsMap
parameter_list|()
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|answer
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|TransportConnector
name|connector
range|:
name|transportConnectors
control|)
block|{
try|try
block|{
name|URI
name|uri
init|=
name|connector
operator|.
name|getConnectUri
argument_list|()
decl_stmt|;
if|if
condition|(
name|uri
operator|!=
literal|null
condition|)
block|{
name|String
name|scheme
init|=
name|uri
operator|.
name|getScheme
argument_list|()
decl_stmt|;
if|if
condition|(
name|scheme
operator|!=
literal|null
condition|)
block|{
name|answer
operator|.
name|put
argument_list|(
name|scheme
operator|.
name|toLowerCase
argument_list|(
name|Locale
operator|.
name|ENGLISH
argument_list|)
argument_list|,
name|uri
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Failed to read URI to build transportURIsAsMap"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|answer
return|;
block|}
end_function

begin_function
specifier|public
name|ProducerBrokerExchange
name|getProducerBrokerExchange
parameter_list|(
name|ProducerInfo
name|producerInfo
parameter_list|)
block|{
name|ProducerBrokerExchange
name|result
init|=
literal|null
decl_stmt|;
for|for
control|(
name|TransportConnector
name|connector
range|:
name|transportConnectors
control|)
block|{
for|for
control|(
name|TransportConnection
name|tc
range|:
name|connector
operator|.
name|getConnections
argument_list|()
control|)
block|{
name|result
operator|=
name|tc
operator|.
name|getProducerBrokerExchangeIfExists
argument_list|(
name|producerInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|null
condition|)
block|{
return|return
name|result
return|;
block|}
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|public
name|String
index|[]
name|getTransportConnectorURIs
parameter_list|()
block|{
return|return
name|transportConnectorURIs
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setTransportConnectorURIs
parameter_list|(
name|String
index|[]
name|transportConnectorURIs
parameter_list|)
block|{
name|this
operator|.
name|transportConnectorURIs
operator|=
name|transportConnectorURIs
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return Returns the jmsBridgeConnectors.      */
end_comment

begin_function
specifier|public
name|JmsConnector
index|[]
name|getJmsBridgeConnectors
parameter_list|()
block|{
return|return
name|jmsBridgeConnectors
return|;
block|}
end_function

begin_comment
comment|/**      * @param jmsConnectors      *            The jmsBridgeConnectors to set.      */
end_comment

begin_function
specifier|public
name|void
name|setJmsBridgeConnectors
parameter_list|(
name|JmsConnector
index|[]
name|jmsConnectors
parameter_list|)
block|{
name|this
operator|.
name|jmsBridgeConnectors
operator|=
name|jmsConnectors
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|Service
index|[]
name|getServices
parameter_list|()
block|{
return|return
name|services
operator|.
name|toArray
argument_list|(
operator|new
name|Service
index|[
literal|0
index|]
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the services associated with this broker.      */
end_comment

begin_function
specifier|public
name|void
name|setServices
parameter_list|(
name|Service
index|[]
name|services
parameter_list|)
block|{
name|this
operator|.
name|services
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|services
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|services
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|this
operator|.
name|services
operator|.
name|add
argument_list|(
name|services
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * Adds a new service so that it will be started as part of the broker      * lifecycle      */
end_comment

begin_function
specifier|public
name|void
name|addService
parameter_list|(
name|Service
name|service
parameter_list|)
block|{
name|services
operator|.
name|add
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|removeService
parameter_list|(
name|Service
name|service
parameter_list|)
block|{
name|services
operator|.
name|remove
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseLoggingForShutdownErrors
parameter_list|()
block|{
return|return
name|useLoggingForShutdownErrors
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not we should use commons-logging when reporting errors      * when shutting down the broker      */
end_comment

begin_function
specifier|public
name|void
name|setUseLoggingForShutdownErrors
parameter_list|(
name|boolean
name|useLoggingForShutdownErrors
parameter_list|)
block|{
name|this
operator|.
name|useLoggingForShutdownErrors
operator|=
name|useLoggingForShutdownErrors
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseShutdownHook
parameter_list|()
block|{
return|return
name|useShutdownHook
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not we should use a shutdown handler to close down the      * broker cleanly if the JVM is terminated. It is recommended you leave this      * enabled.      */
end_comment

begin_function
specifier|public
name|void
name|setUseShutdownHook
parameter_list|(
name|boolean
name|useShutdownHook
parameter_list|)
block|{
name|this
operator|.
name|useShutdownHook
operator|=
name|useShutdownHook
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isAdvisorySupport
parameter_list|()
block|{
return|return
name|advisorySupport
return|;
block|}
end_function

begin_comment
comment|/**      * Allows the support of advisory messages to be disabled for performance      * reasons.      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setAdvisorySupport
parameter_list|(
name|boolean
name|advisorySupport
parameter_list|)
block|{
name|this
operator|.
name|advisorySupport
operator|=
name|advisorySupport
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|List
argument_list|<
name|TransportConnector
argument_list|>
name|getTransportConnectors
parameter_list|()
block|{
return|return
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|transportConnectors
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the transport connectors which this broker will listen on for new      * clients      *      * @org.apache.xbean.Property      *                            nestedType="org.apache.activemq.broker.TransportConnector"      */
end_comment

begin_function
specifier|public
name|void
name|setTransportConnectors
parameter_list|(
name|List
argument_list|<
name|TransportConnector
argument_list|>
name|transportConnectors
parameter_list|)
throws|throws
name|Exception
block|{
for|for
control|(
name|TransportConnector
name|connector
range|:
name|transportConnectors
control|)
block|{
name|addConnector
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|TransportConnector
name|getTransportConnectorByName
parameter_list|(
name|String
name|name
parameter_list|)
block|{
for|for
control|(
name|TransportConnector
name|transportConnector
range|:
name|transportConnectors
control|)
block|{
if|if
condition|(
name|name
operator|.
name|equals
argument_list|(
name|transportConnector
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
return|return
name|transportConnector
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
specifier|public
name|TransportConnector
name|getTransportConnectorByScheme
parameter_list|(
name|String
name|scheme
parameter_list|)
block|{
for|for
control|(
name|TransportConnector
name|transportConnector
range|:
name|transportConnectors
control|)
block|{
if|if
condition|(
name|scheme
operator|.
name|equals
argument_list|(
name|transportConnector
operator|.
name|getUri
argument_list|()
operator|.
name|getScheme
argument_list|()
argument_list|)
condition|)
block|{
return|return
name|transportConnector
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
specifier|public
name|List
argument_list|<
name|NetworkConnector
argument_list|>
name|getNetworkConnectors
parameter_list|()
block|{
return|return
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|networkConnectors
argument_list|)
return|;
block|}
end_function

begin_function
specifier|public
name|List
argument_list|<
name|ProxyConnector
argument_list|>
name|getProxyConnectors
parameter_list|()
block|{
return|return
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|proxyConnectors
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the network connectors which this broker will use to connect to      * other brokers in a federated network      *      * @org.apache.xbean.Property      *                            nestedType="org.apache.activemq.network.NetworkConnector"      */
end_comment

begin_function
specifier|public
name|void
name|setNetworkConnectors
parameter_list|(
name|List
argument_list|<
name|?
argument_list|>
name|networkConnectors
parameter_list|)
throws|throws
name|Exception
block|{
for|for
control|(
name|Object
name|connector
range|:
name|networkConnectors
control|)
block|{
name|addNetworkConnector
argument_list|(
operator|(
name|NetworkConnector
operator|)
name|connector
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**      * Sets the network connectors which this broker will use to connect to      * other brokers in a federated network      */
end_comment

begin_function
specifier|public
name|void
name|setProxyConnectors
parameter_list|(
name|List
argument_list|<
name|?
argument_list|>
name|proxyConnectors
parameter_list|)
throws|throws
name|Exception
block|{
for|for
control|(
name|Object
name|connector
range|:
name|proxyConnectors
control|)
block|{
name|addProxyConnector
argument_list|(
operator|(
name|ProxyConnector
operator|)
name|connector
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|PolicyMap
name|getDestinationPolicy
parameter_list|()
block|{
return|return
name|destinationPolicy
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the destination specific policies available either for exact      * destinations or for wildcard areas of destinations.      */
end_comment

begin_function
specifier|public
name|void
name|setDestinationPolicy
parameter_list|(
name|PolicyMap
name|policyMap
parameter_list|)
block|{
name|this
operator|.
name|destinationPolicy
operator|=
name|policyMap
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|BrokerPlugin
index|[]
name|getPlugins
parameter_list|()
block|{
return|return
name|plugins
return|;
block|}
end_function

begin_comment
comment|/**      * Sets a number of broker plugins to install such as for security      * authentication or authorization      */
end_comment

begin_function
specifier|public
name|void
name|setPlugins
parameter_list|(
name|BrokerPlugin
index|[]
name|plugins
parameter_list|)
block|{
name|this
operator|.
name|plugins
operator|=
name|plugins
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|MessageAuthorizationPolicy
name|getMessageAuthorizationPolicy
parameter_list|()
block|{
return|return
name|messageAuthorizationPolicy
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the policy used to decide if the current connection is authorized to      * consume a given message      */
end_comment

begin_function
specifier|public
name|void
name|setMessageAuthorizationPolicy
parameter_list|(
name|MessageAuthorizationPolicy
name|messageAuthorizationPolicy
parameter_list|)
block|{
name|this
operator|.
name|messageAuthorizationPolicy
operator|=
name|messageAuthorizationPolicy
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Delete all messages from the persistent store      *      * @throws IOException      */
end_comment

begin_function
specifier|public
name|void
name|deleteAllMessages
parameter_list|()
throws|throws
name|IOException
block|{
name|getPersistenceAdapter
argument_list|()
operator|.
name|deleteAllMessages
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isDeleteAllMessagesOnStartup
parameter_list|()
block|{
return|return
name|deleteAllMessagesOnStartup
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not all messages are deleted on startup - mostly only      * useful for testing.      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setDeleteAllMessagesOnStartup
parameter_list|(
name|boolean
name|deletePersistentMessagesOnStartup
parameter_list|)
block|{
name|this
operator|.
name|deleteAllMessagesOnStartup
operator|=
name|deletePersistentMessagesOnStartup
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|URI
name|getVmConnectorURI
parameter_list|()
block|{
if|if
condition|(
name|vmConnectorURI
operator|==
literal|null
condition|)
block|{
try|try
block|{
name|vmConnectorURI
operator|=
operator|new
name|URI
argument_list|(
literal|"vm://"
operator|+
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Badly formed URI from {}"
argument_list|,
name|getBrokerName
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|vmConnectorURI
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setVmConnectorURI
parameter_list|(
name|URI
name|vmConnectorURI
parameter_list|)
block|{
name|this
operator|.
name|vmConnectorURI
operator|=
name|vmConnectorURI
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|String
name|getDefaultSocketURIString
parameter_list|()
block|{
if|if
condition|(
name|started
operator|.
name|get
argument_list|()
condition|)
block|{
if|if
condition|(
name|this
operator|.
name|defaultSocketURIString
operator|==
literal|null
condition|)
block|{
for|for
control|(
name|TransportConnector
name|tc
range|:
name|this
operator|.
name|transportConnectors
control|)
block|{
name|String
name|result
init|=
literal|null
decl_stmt|;
try|try
block|{
name|result
operator|=
name|tc
operator|.
name|getPublishableConnectString
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Failed to get the ConnectURI for {}"
argument_list|,
name|tc
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
literal|null
condition|)
block|{
comment|// find first publishable uri
if|if
condition|(
name|tc
operator|.
name|isUpdateClusterClients
argument_list|()
operator|||
name|tc
operator|.
name|isRebalanceClusterClients
argument_list|()
condition|)
block|{
name|this
operator|.
name|defaultSocketURIString
operator|=
name|result
expr_stmt|;
break|break;
block|}
else|else
block|{
comment|// or use the first defined
if|if
condition|(
name|this
operator|.
name|defaultSocketURIString
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|defaultSocketURIString
operator|=
name|result
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
return|return
name|this
operator|.
name|defaultSocketURIString
return|;
block|}
return|return
literal|null
return|;
block|}
end_function

begin_comment
comment|/**      * @return Returns the shutdownOnMasterFailure.      */
end_comment

begin_function
specifier|public
name|boolean
name|isShutdownOnMasterFailure
parameter_list|()
block|{
return|return
name|shutdownOnMasterFailure
return|;
block|}
end_function

begin_comment
comment|/**      * @param shutdownOnMasterFailure      *            The shutdownOnMasterFailure to set.      */
end_comment

begin_function
specifier|public
name|void
name|setShutdownOnMasterFailure
parameter_list|(
name|boolean
name|shutdownOnMasterFailure
parameter_list|)
block|{
name|this
operator|.
name|shutdownOnMasterFailure
operator|=
name|shutdownOnMasterFailure
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isKeepDurableSubsActive
parameter_list|()
block|{
return|return
name|keepDurableSubsActive
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setKeepDurableSubsActive
parameter_list|(
name|boolean
name|keepDurableSubsActive
parameter_list|)
block|{
name|this
operator|.
name|keepDurableSubsActive
operator|=
name|keepDurableSubsActive
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseVirtualTopics
parameter_list|()
block|{
return|return
name|useVirtualTopics
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not<a      * href="http://activemq.apache.org/virtual-destinations.html">Virtual      * Topics</a> should be supported by default if they have not been      * explicitly configured.      */
end_comment

begin_function
specifier|public
name|void
name|setUseVirtualTopics
parameter_list|(
name|boolean
name|useVirtualTopics
parameter_list|)
block|{
name|this
operator|.
name|useVirtualTopics
operator|=
name|useVirtualTopics
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|DestinationInterceptor
index|[]
name|getDestinationInterceptors
parameter_list|()
block|{
return|return
name|destinationInterceptors
return|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseMirroredQueues
parameter_list|()
block|{
return|return
name|useMirroredQueues
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether or not<a      * href="http://activemq.apache.org/mirrored-queues.html">Mirrored      * Queues</a> should be supported by default if they have not been      * explicitly configured.      */
end_comment

begin_function
specifier|public
name|void
name|setUseMirroredQueues
parameter_list|(
name|boolean
name|useMirroredQueues
parameter_list|)
block|{
name|this
operator|.
name|useMirroredQueues
operator|=
name|useMirroredQueues
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Sets the destination interceptors to use      */
end_comment

begin_function
specifier|public
name|void
name|setDestinationInterceptors
parameter_list|(
name|DestinationInterceptor
index|[]
name|destinationInterceptors
parameter_list|)
block|{
name|this
operator|.
name|destinationInterceptors
operator|=
name|destinationInterceptors
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|ActiveMQDestination
index|[]
name|getDestinations
parameter_list|()
block|{
return|return
name|destinations
return|;
block|}
end_function

begin_comment
comment|/**      * Sets the destinations which should be loaded/created on startup      */
end_comment

begin_function
specifier|public
name|void
name|setDestinations
parameter_list|(
name|ActiveMQDestination
index|[]
name|destinations
parameter_list|)
block|{
name|this
operator|.
name|destinations
operator|=
name|destinations
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the tempDataStore      */
end_comment

begin_function
specifier|public
specifier|synchronized
name|PListStore
name|getTempDataStore
parameter_list|()
block|{
if|if
condition|(
name|tempDataStore
operator|==
literal|null
operator|&&
operator|!
name|hasStartException
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|isPersistent
argument_list|()
condition|)
block|{
return|return
literal|null
return|;
block|}
try|try
block|{
name|PersistenceAdapter
name|pa
init|=
name|getPersistenceAdapter
argument_list|()
decl_stmt|;
if|if
condition|(
name|pa
operator|!=
literal|null
operator|&&
name|pa
operator|instanceof
name|PListStore
condition|)
block|{
return|return
operator|(
name|PListStore
operator|)
name|pa
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|String
name|clazz
init|=
literal|"org.apache.activemq.store.kahadb.plist.PListStoreImpl"
decl_stmt|;
name|this
operator|.
name|tempDataStore
operator|=
operator|(
name|PListStore
operator|)
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
operator|.
name|loadClass
argument_list|(
name|clazz
argument_list|)
operator|.
name|newInstance
argument_list|()
expr_stmt|;
name|this
operator|.
name|tempDataStore
operator|.
name|setDirectory
argument_list|(
name|getTmpDataDirectory
argument_list|()
argument_list|)
expr_stmt|;
name|configureService
argument_list|(
name|tempDataStore
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ClassNotFoundException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"Kahadb class PListStoreImpl not found. Add activemq-kahadb jar or set persistent to false on BrokerService."
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
return|return
name|tempDataStore
return|;
block|}
end_function

begin_comment
comment|/**      * @param tempDataStore      *            the tempDataStore to set      */
end_comment

begin_function
specifier|public
name|void
name|setTempDataStore
parameter_list|(
name|PListStore
name|tempDataStore
parameter_list|)
block|{
name|this
operator|.
name|tempDataStore
operator|=
name|tempDataStore
expr_stmt|;
if|if
condition|(
name|tempDataStore
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|tmpDataDirectory
operator|==
literal|null
condition|)
block|{
name|tmpDataDirectory
operator|=
name|tempDataStore
operator|.
name|getDirectory
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tempDataStore
operator|.
name|getDirectory
argument_list|()
operator|==
literal|null
condition|)
block|{
name|tempDataStore
operator|.
name|setDirectory
argument_list|(
name|tmpDataDirectory
argument_list|)
expr_stmt|;
block|}
block|}
name|configureService
argument_list|(
name|tempDataStore
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getPersistenceThreadPriority
parameter_list|()
block|{
return|return
name|persistenceThreadPriority
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setPersistenceThreadPriority
parameter_list|(
name|int
name|persistenceThreadPriority
parameter_list|)
block|{
name|this
operator|.
name|persistenceThreadPriority
operator|=
name|persistenceThreadPriority
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the useLocalHostBrokerName      */
end_comment

begin_function
specifier|public
name|boolean
name|isUseLocalHostBrokerName
parameter_list|()
block|{
return|return
name|this
operator|.
name|useLocalHostBrokerName
return|;
block|}
end_function

begin_comment
comment|/**      * @param useLocalHostBrokerName      *            the useLocalHostBrokerName to set      */
end_comment

begin_function
specifier|public
name|void
name|setUseLocalHostBrokerName
parameter_list|(
name|boolean
name|useLocalHostBrokerName
parameter_list|)
block|{
name|this
operator|.
name|useLocalHostBrokerName
operator|=
name|useLocalHostBrokerName
expr_stmt|;
if|if
condition|(
name|useLocalHostBrokerName
operator|&&
operator|!
name|started
operator|.
name|get
argument_list|()
operator|&&
name|brokerName
operator|==
literal|null
operator|||
name|brokerName
operator|==
name|DEFAULT_BROKER_NAME
condition|)
block|{
name|brokerName
operator|=
name|LOCAL_HOST_NAME
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**      * Looks up and lazily creates if necessary the destination for the given      * JMS name      */
end_comment

begin_function
specifier|public
name|Destination
name|getDestination
parameter_list|(
name|ActiveMQDestination
name|destination
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|getBroker
argument_list|()
operator|.
name|addDestination
argument_list|(
name|getAdminConnectionContext
argument_list|()
argument_list|,
name|destination
argument_list|,
literal|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|removeDestination
parameter_list|(
name|ActiveMQDestination
name|destination
parameter_list|)
throws|throws
name|Exception
block|{
name|getBroker
argument_list|()
operator|.
name|removeDestination
argument_list|(
name|getAdminConnectionContext
argument_list|()
argument_list|,
name|destination
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getProducerSystemUsagePortion
parameter_list|()
block|{
return|return
name|producerSystemUsagePortion
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setProducerSystemUsagePortion
parameter_list|(
name|int
name|producerSystemUsagePortion
parameter_list|)
block|{
name|this
operator|.
name|producerSystemUsagePortion
operator|=
name|producerSystemUsagePortion
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getConsumerSystemUsagePortion
parameter_list|()
block|{
return|return
name|consumerSystemUsagePortion
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setConsumerSystemUsagePortion
parameter_list|(
name|int
name|consumerSystemUsagePortion
parameter_list|)
block|{
name|this
operator|.
name|consumerSystemUsagePortion
operator|=
name|consumerSystemUsagePortion
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isSplitSystemUsageForProducersConsumers
parameter_list|()
block|{
return|return
name|splitSystemUsageForProducersConsumers
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setSplitSystemUsageForProducersConsumers
parameter_list|(
name|boolean
name|splitSystemUsageForProducersConsumers
parameter_list|)
block|{
name|this
operator|.
name|splitSystemUsageForProducersConsumers
operator|=
name|splitSystemUsageForProducersConsumers
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isMonitorConnectionSplits
parameter_list|()
block|{
return|return
name|monitorConnectionSplits
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setMonitorConnectionSplits
parameter_list|(
name|boolean
name|monitorConnectionSplits
parameter_list|)
block|{
name|this
operator|.
name|monitorConnectionSplits
operator|=
name|monitorConnectionSplits
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getTaskRunnerPriority
parameter_list|()
block|{
return|return
name|taskRunnerPriority
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setTaskRunnerPriority
parameter_list|(
name|int
name|taskRunnerPriority
parameter_list|)
block|{
name|this
operator|.
name|taskRunnerPriority
operator|=
name|taskRunnerPriority
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isDedicatedTaskRunner
parameter_list|()
block|{
return|return
name|dedicatedTaskRunner
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setDedicatedTaskRunner
parameter_list|(
name|boolean
name|dedicatedTaskRunner
parameter_list|)
block|{
name|this
operator|.
name|dedicatedTaskRunner
operator|=
name|dedicatedTaskRunner
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isCacheTempDestinations
parameter_list|()
block|{
return|return
name|cacheTempDestinations
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setCacheTempDestinations
parameter_list|(
name|boolean
name|cacheTempDestinations
parameter_list|)
block|{
name|this
operator|.
name|cacheTempDestinations
operator|=
name|cacheTempDestinations
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getTimeBeforePurgeTempDestinations
parameter_list|()
block|{
return|return
name|timeBeforePurgeTempDestinations
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setTimeBeforePurgeTempDestinations
parameter_list|(
name|int
name|timeBeforePurgeTempDestinations
parameter_list|)
block|{
name|this
operator|.
name|timeBeforePurgeTempDestinations
operator|=
name|timeBeforePurgeTempDestinations
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseTempMirroredQueues
parameter_list|()
block|{
return|return
name|useTempMirroredQueues
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setUseTempMirroredQueues
parameter_list|(
name|boolean
name|useTempMirroredQueues
parameter_list|)
block|{
name|this
operator|.
name|useTempMirroredQueues
operator|=
name|useTempMirroredQueues
expr_stmt|;
block|}
end_function

begin_function
specifier|public
specifier|synchronized
name|JobSchedulerStore
name|getJobSchedulerStore
parameter_list|()
block|{
comment|// If support is off don't allow any scheduler even is user configured their own.
if|if
condition|(
operator|!
name|isSchedulerSupport
argument_list|()
condition|)
block|{
return|return
literal|null
return|;
block|}
comment|// If the user configured their own we use it even if persistence is disabled since
comment|// we don't know anything about their implementation.
if|if
condition|(
name|jobSchedulerStore
operator|==
literal|null
operator|&&
operator|!
name|hasStartException
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|isPersistent
argument_list|()
condition|)
block|{
name|this
operator|.
name|jobSchedulerStore
operator|=
operator|new
name|InMemoryJobSchedulerStore
argument_list|()
expr_stmt|;
name|configureService
argument_list|(
name|jobSchedulerStore
argument_list|)
expr_stmt|;
return|return
name|this
operator|.
name|jobSchedulerStore
return|;
block|}
try|try
block|{
name|PersistenceAdapter
name|pa
init|=
name|getPersistenceAdapter
argument_list|()
decl_stmt|;
if|if
condition|(
name|pa
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|jobSchedulerStore
operator|=
name|pa
operator|.
name|createJobSchedulerStore
argument_list|()
expr_stmt|;
name|jobSchedulerStore
operator|.
name|setDirectory
argument_list|(
name|getSchedulerDirectoryFile
argument_list|()
argument_list|)
expr_stmt|;
name|configureService
argument_list|(
name|jobSchedulerStore
argument_list|)
expr_stmt|;
return|return
name|this
operator|.
name|jobSchedulerStore
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|UnsupportedOperationException
name|ex
parameter_list|)
block|{
comment|// It's ok if the store doesn't implement a scheduler.
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|PersistenceAdapter
name|pa
init|=
name|getPersistenceAdapter
argument_list|()
decl_stmt|;
if|if
condition|(
name|pa
operator|!=
literal|null
operator|&&
name|pa
operator|instanceof
name|JobSchedulerStore
condition|)
block|{
name|this
operator|.
name|jobSchedulerStore
operator|=
operator|(
name|JobSchedulerStore
operator|)
name|pa
expr_stmt|;
name|configureService
argument_list|(
name|jobSchedulerStore
argument_list|)
expr_stmt|;
return|return
name|this
operator|.
name|jobSchedulerStore
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
comment|// Load the KahaDB store as a last resort, this only works if KahaDB is
comment|// included at runtime, otherwise this will fail.  User should disable
comment|// scheduler support if this fails.
try|try
block|{
name|String
name|clazz
init|=
literal|"org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter"
decl_stmt|;
name|PersistenceAdapter
name|adaptor
init|=
operator|(
name|PersistenceAdapter
operator|)
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
operator|.
name|loadClass
argument_list|(
name|clazz
argument_list|)
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|jobSchedulerStore
operator|=
name|adaptor
operator|.
name|createJobSchedulerStore
argument_list|()
expr_stmt|;
name|jobSchedulerStore
operator|.
name|setDirectory
argument_list|(
name|getSchedulerDirectoryFile
argument_list|()
argument_list|)
expr_stmt|;
name|configureService
argument_list|(
name|jobSchedulerStore
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"JobScheduler using directory: {}"
argument_list|,
name|getSchedulerDirectoryFile
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
return|return
name|jobSchedulerStore
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setJobSchedulerStore
parameter_list|(
name|JobSchedulerStore
name|jobSchedulerStore
parameter_list|)
block|{
name|this
operator|.
name|jobSchedulerStore
operator|=
name|jobSchedulerStore
expr_stmt|;
name|configureService
argument_list|(
name|jobSchedulerStore
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//
end_comment

begin_comment
comment|// Implementation methods
end_comment

begin_comment
comment|// -------------------------------------------------------------------------
end_comment

begin_comment
comment|/**      * Handles any lazy-creation helper properties which are added to make      * things easier to configure inside environments such as Spring      *      * @throws Exception      */
end_comment

begin_function
specifier|protected
name|void
name|processHelperProperties
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|transportConnectorURIs
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|transportConnectorURIs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|uri
init|=
name|transportConnectorURIs
index|[
name|i
index|]
decl_stmt|;
name|addConnector
argument_list|(
name|uri
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|networkConnectorURIs
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|networkConnectorURIs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|uri
init|=
name|networkConnectorURIs
index|[
name|i
index|]
decl_stmt|;
name|addNetworkConnector
argument_list|(
name|uri
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|jmsBridgeConnectors
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|jmsBridgeConnectors
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|addJmsConnector
argument_list|(
name|jmsBridgeConnectors
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * Check that the store usage limit is not greater than max usable      * space and adjust if it is      */
end_comment

begin_function
specifier|protected
name|void
name|checkStoreUsageLimits
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|SystemUsage
name|usage
init|=
name|getSystemUsage
argument_list|()
decl_stmt|;
if|if
condition|(
name|getPersistenceAdapter
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|PersistenceAdapter
name|adapter
init|=
name|getPersistenceAdapter
argument_list|()
decl_stmt|;
name|checkUsageLimit
argument_list|(
name|adapter
operator|.
name|getDirectory
argument_list|()
argument_list|,
name|usage
operator|.
name|getStoreUsage
argument_list|()
argument_list|,
name|usage
operator|.
name|getStoreUsage
argument_list|()
operator|.
name|getPercentLimit
argument_list|()
argument_list|)
expr_stmt|;
name|long
name|maxJournalFileSize
init|=
literal|0
decl_stmt|;
name|long
name|storeLimit
init|=
name|usage
operator|.
name|getStoreUsage
argument_list|()
operator|.
name|getLimit
argument_list|()
decl_stmt|;
if|if
condition|(
name|adapter
operator|instanceof
name|JournaledStore
condition|)
block|{
name|maxJournalFileSize
operator|=
operator|(
operator|(
name|JournaledStore
operator|)
name|adapter
operator|)
operator|.
name|getJournalMaxFileLength
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|storeLimit
operator|>
literal|0
operator|&&
name|storeLimit
operator|<
name|maxJournalFileSize
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Store limit is "
operator|+
name|storeLimit
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb, whilst the max journal file size for the store is: "
operator|+
name|maxJournalFileSize
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb, "
operator|+
literal|"the store will not accept any data when used."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * Check that temporary usage limit is not greater than max usable      * space and adjust if it is      */
end_comment

begin_function
specifier|protected
name|void
name|checkTmpStoreUsageLimits
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|SystemUsage
name|usage
init|=
name|getSystemUsage
argument_list|()
decl_stmt|;
name|File
name|tmpDir
init|=
name|getTmpDataDirectory
argument_list|()
decl_stmt|;
if|if
condition|(
name|tmpDir
operator|!=
literal|null
condition|)
block|{
name|checkUsageLimit
argument_list|(
name|tmpDir
argument_list|,
name|usage
operator|.
name|getTempUsage
argument_list|()
argument_list|,
name|usage
operator|.
name|getTempUsage
argument_list|()
operator|.
name|getPercentLimit
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|isPersistent
argument_list|()
condition|)
block|{
name|long
name|maxJournalFileSize
decl_stmt|;
name|PListStore
name|store
init|=
name|usage
operator|.
name|getTempUsage
argument_list|()
operator|.
name|getStore
argument_list|()
decl_stmt|;
if|if
condition|(
name|store
operator|!=
literal|null
operator|&&
name|store
operator|instanceof
name|JournaledStore
condition|)
block|{
name|maxJournalFileSize
operator|=
operator|(
operator|(
name|JournaledStore
operator|)
name|store
operator|)
operator|.
name|getJournalMaxFileLength
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|maxJournalFileSize
operator|=
name|DEFAULT_MAX_FILE_LENGTH
expr_stmt|;
block|}
name|long
name|storeLimit
init|=
name|usage
operator|.
name|getTempUsage
argument_list|()
operator|.
name|getLimit
argument_list|()
decl_stmt|;
if|if
condition|(
name|storeLimit
operator|>
literal|0
operator|&&
name|storeLimit
operator|<
name|maxJournalFileSize
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Temporary Store limit is "
operator|+
name|storeLimit
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb, whilst the max journal file size for the temporary store is: "
operator|+
name|maxJournalFileSize
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb, "
operator|+
literal|"the temp store will not accept any data when used."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|checkUsageLimit
parameter_list|(
name|File
name|dir
parameter_list|,
name|PercentLimitUsage
argument_list|<
name|?
argument_list|>
name|storeUsage
parameter_list|,
name|int
name|percentLimit
parameter_list|)
throws|throws
name|ConfigurationException
block|{
if|if
condition|(
name|dir
operator|!=
literal|null
condition|)
block|{
name|dir
operator|=
name|StoreUtil
operator|.
name|findParentDirectory
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|String
name|storeName
init|=
name|storeUsage
operator|instanceof
name|StoreUsage
condition|?
literal|"Store"
else|:
literal|"Temporary Store"
decl_stmt|;
name|long
name|storeLimit
init|=
name|storeUsage
operator|.
name|getLimit
argument_list|()
decl_stmt|;
name|long
name|storeCurrent
init|=
name|storeUsage
operator|.
name|getUsage
argument_list|()
decl_stmt|;
name|long
name|totalSpace
init|=
name|storeUsage
operator|.
name|getTotal
argument_list|()
operator|>
literal|0
condition|?
name|storeUsage
operator|.
name|getTotal
argument_list|()
else|:
name|dir
operator|.
name|getTotalSpace
argument_list|()
decl_stmt|;
name|long
name|totalUsableSpace
init|=
operator|(
name|storeUsage
operator|.
name|getTotal
argument_list|()
operator|>
literal|0
condition|?
name|storeUsage
operator|.
name|getTotal
argument_list|()
else|:
name|dir
operator|.
name|getUsableSpace
argument_list|()
operator|)
operator|+
name|storeCurrent
decl_stmt|;
if|if
condition|(
name|totalUsableSpace
operator|<
literal|0
operator|||
name|totalSpace
operator|<
literal|0
condition|)
block|{
specifier|final
name|String
name|message
init|=
literal|"File system space reported by: "
operator|+
name|dir
operator|+
literal|" was negative, possibly a huge file system, set a sane usage.total to provide some guidance"
decl_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|message
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ConfigurationException
argument_list|(
name|message
argument_list|)
throw|;
block|}
comment|//compute byte value of the percent limit
name|long
name|bytePercentLimit
init|=
name|totalSpace
operator|*
name|percentLimit
operator|/
literal|100
decl_stmt|;
name|int
name|oneMeg
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
comment|//Check if the store limit is less than the percent Limit that was set and also
comment|//the usable space...this means we can grow the store larger
comment|//Changes in partition size (total space) as well as changes in usable space should
comment|//be detected here
if|if
condition|(
name|diskUsageCheckRegrowThreshold
operator|>
operator|-
literal|1
operator|&&
name|percentLimit
operator|>
literal|0
operator|&&
name|storeUsage
operator|.
name|getTotal
argument_list|()
operator|==
literal|0
operator|&&
name|storeLimit
operator|<
name|bytePercentLimit
operator|&&
name|storeLimit
operator|<
name|totalUsableSpace
condition|)
block|{
comment|// set the limit to be bytePercentLimit or usableSpace if
comment|// usableSpace is less than the percentLimit
name|long
name|newLimit
init|=
name|bytePercentLimit
operator|>
name|totalUsableSpace
condition|?
name|totalUsableSpace
else|:
name|bytePercentLimit
decl_stmt|;
comment|//To prevent changing too often, check threshold
if|if
condition|(
name|newLimit
operator|-
name|storeLimit
operator|>=
name|diskUsageCheckRegrowThreshold
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Usable disk space has been increased, attempting to regrow "
operator|+
name|storeName
operator|+
literal|" limit to "
operator|+
name|percentLimit
operator|+
literal|"% of the partition size."
argument_list|)
expr_stmt|;
name|storeUsage
operator|.
name|setLimit
argument_list|(
name|newLimit
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
name|storeName
operator|+
literal|" limit has been increased to "
operator|+
name|newLimit
operator|*
literal|100
operator|/
name|totalSpace
operator|+
literal|"% ("
operator|+
name|newLimit
operator|/
name|oneMeg
operator|+
literal|" mb) of the partition size."
argument_list|)
expr_stmt|;
block|}
comment|//check if the limit is too large for the amount of usable space
block|}
elseif|else
if|if
condition|(
name|storeLimit
operator|>
name|totalUsableSpace
condition|)
block|{
specifier|final
name|String
name|message
init|=
name|storeName
operator|+
literal|" limit is "
operator|+
name|storeLimit
operator|/
name|oneMeg
operator|+
literal|" mb (current store usage is "
operator|+
name|storeCurrent
operator|/
name|oneMeg
operator|+
literal|" mb). The data directory: "
operator|+
name|dir
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" only has "
operator|+
name|totalUsableSpace
operator|/
name|oneMeg
operator|+
literal|" mb of usable space."
decl_stmt|;
if|if
condition|(
operator|!
name|isAdjustUsageLimits
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
name|message
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ConfigurationException
argument_list|(
name|message
argument_list|)
throw|;
block|}
if|if
condition|(
name|percentLimit
operator|>
literal|0
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|storeName
operator|+
literal|" limit has been set to "
operator|+
name|percentLimit
operator|+
literal|"% ("
operator|+
name|bytePercentLimit
operator|/
name|oneMeg
operator|+
literal|" mb)"
operator|+
literal|" of the partition size but there is not enough usable space."
operator|+
literal|" The current store limit (which may have been adjusted by a"
operator|+
literal|" previous usage limit check) is set to ("
operator|+
name|storeLimit
operator|/
name|oneMeg
operator|+
literal|" mb)"
operator|+
literal|" but only "
operator|+
name|totalUsableSpace
operator|*
literal|100
operator|/
name|totalSpace
operator|+
literal|"% ("
operator|+
name|totalUsableSpace
operator|/
name|oneMeg
operator|+
literal|" mb)"
operator|+
literal|" is available - resetting limit"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|message
operator|+
literal|" - resetting to maximum available disk space: "
operator|+
name|totalUsableSpace
operator|/
name|oneMeg
operator|+
literal|" mb"
argument_list|)
expr_stmt|;
block|}
name|storeUsage
operator|.
name|setLimit
argument_list|(
name|totalUsableSpace
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * Schedules a periodic task based on schedulePeriodForDiskLimitCheck to      * update store and temporary store limits if the amount of available space      * plus current store size is less than the existin configured limit      */
end_comment

begin_function
specifier|protected
name|void
name|scheduleDiskUsageLimitsCheck
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|schedulePeriodForDiskUsageCheck
operator|>
literal|0
operator|&&
operator|(
name|getPersistenceAdapter
argument_list|()
operator|!=
literal|null
operator|||
name|getTmpDataDirectory
argument_list|()
operator|!=
literal|null
operator|)
condition|)
block|{
name|Runnable
name|diskLimitCheckTask
init|=
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|checkStoreUsageLimits
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to check persistent disk usage limits"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|checkTmpStoreUsageLimits
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to check temporary store usage limits"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
name|scheduler
operator|.
name|executePeriodically
argument_list|(
name|diskLimitCheckTask
argument_list|,
name|schedulePeriodForDiskUsageCheck
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|checkMemorySystemUsageLimits
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|SystemUsage
name|usage
init|=
name|getSystemUsage
argument_list|()
decl_stmt|;
name|long
name|memLimit
init|=
name|usage
operator|.
name|getMemoryUsage
argument_list|()
operator|.
name|getLimit
argument_list|()
decl_stmt|;
name|long
name|jvmLimit
init|=
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|maxMemory
argument_list|()
decl_stmt|;
if|if
condition|(
name|memLimit
operator|>
name|jvmLimit
condition|)
block|{
specifier|final
name|String
name|message
init|=
literal|"Memory Usage for the Broker ("
operator|+
name|memLimit
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|"mb) is more than the maximum available for the JVM: "
operator|+
name|jvmLimit
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
decl_stmt|;
if|if
condition|(
name|adjustUsageLimits
condition|)
block|{
name|usage
operator|.
name|getMemoryUsage
argument_list|()
operator|.
name|setPercentOfJvmHeap
argument_list|(
literal|70
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
name|message
operator|+
literal|" mb - resetting to 70% of maximum available: "
operator|+
operator|(
name|usage
operator|.
name|getMemoryUsage
argument_list|()
operator|.
name|getLimit
argument_list|()
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|)
operator|+
literal|" mb"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|error
argument_list|(
name|message
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ConfigurationException
argument_list|(
name|message
argument_list|)
throw|;
block|}
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|checkStoreSystemUsageLimits
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|SystemUsage
name|usage
init|=
name|getSystemUsage
argument_list|()
decl_stmt|;
comment|//Check the persistent store and temp store limits if they exist
comment|//and schedule a periodic check to update disk limits if
comment|//schedulePeriodForDiskLimitCheck is set
name|checkStoreUsageLimits
argument_list|()
expr_stmt|;
name|checkTmpStoreUsageLimits
argument_list|()
expr_stmt|;
name|scheduleDiskUsageLimitsCheck
argument_list|()
expr_stmt|;
if|if
condition|(
name|getJobSchedulerStore
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|JobSchedulerStore
name|scheduler
init|=
name|getJobSchedulerStore
argument_list|()
decl_stmt|;
name|File
name|schedulerDir
init|=
name|scheduler
operator|.
name|getDirectory
argument_list|()
decl_stmt|;
if|if
condition|(
name|schedulerDir
operator|!=
literal|null
condition|)
block|{
name|String
name|schedulerDirPath
init|=
name|schedulerDir
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|schedulerDir
operator|.
name|isAbsolute
argument_list|()
condition|)
block|{
name|schedulerDir
operator|=
operator|new
name|File
argument_list|(
name|schedulerDirPath
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|schedulerDir
operator|!=
literal|null
operator|&&
operator|!
name|schedulerDir
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|schedulerDir
operator|=
name|schedulerDir
operator|.
name|getParentFile
argument_list|()
expr_stmt|;
block|}
name|long
name|schedulerLimit
init|=
name|usage
operator|.
name|getJobSchedulerUsage
argument_list|()
operator|.
name|getLimit
argument_list|()
decl_stmt|;
name|long
name|dirFreeSpace
init|=
name|schedulerDir
operator|.
name|getUsableSpace
argument_list|()
decl_stmt|;
if|if
condition|(
name|schedulerLimit
operator|>
name|dirFreeSpace
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Job Scheduler Store limit is "
operator|+
name|schedulerLimit
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb, whilst the data directory: "
operator|+
name|schedulerDir
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" only has "
operator|+
name|dirFreeSpace
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb of usable space - resetting to "
operator|+
name|dirFreeSpace
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|+
literal|" mb."
argument_list|)
expr_stmt|;
name|usage
operator|.
name|getJobSchedulerUsage
argument_list|()
operator|.
name|setLimit
argument_list|(
name|dirFreeSpace
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|public
name|void
name|stopAllConnectors
parameter_list|(
name|ServiceStopper
name|stopper
parameter_list|)
block|{
for|for
control|(
name|Iterator
argument_list|<
name|NetworkConnector
argument_list|>
name|iter
init|=
name|getNetworkConnectors
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|NetworkConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|unregisterNetworkConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
name|stopper
operator|.
name|stop
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Iterator
argument_list|<
name|ProxyConnector
argument_list|>
name|iter
init|=
name|getProxyConnectors
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|ProxyConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|stopper
operator|.
name|stop
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Iterator
argument_list|<
name|JmsConnector
argument_list|>
name|iter
init|=
name|jmsConnectors
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|JmsConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|stopper
operator|.
name|stop
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Iterator
argument_list|<
name|TransportConnector
argument_list|>
name|iter
init|=
name|getTransportConnectors
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|TransportConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
try|try
block|{
name|unregisterConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{             }
name|stopper
operator|.
name|stop
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|TransportConnector
name|registerConnectorMBean
parameter_list|(
name|TransportConnector
name|connector
parameter_list|)
throws|throws
name|IOException
block|{
try|try
block|{
name|ObjectName
name|objectName
init|=
name|createConnectorObjectName
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|connector
operator|=
name|connector
operator|.
name|asManagedConnector
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
name|ConnectorViewMBean
name|view
init|=
operator|new
name|ConnectorView
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|view
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
return|return
name|connector
return|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"Transport Connector could not be registered in JMX: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|unregisterConnectorMBean
parameter_list|(
name|TransportConnector
name|connector
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
try|try
block|{
name|ObjectName
name|objectName
init|=
name|createConnectorObjectName
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|getManagementContext
argument_list|()
operator|.
name|unregisterMBean
argument_list|(
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"Transport Connector could not be unregistered in JMX: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
end_function

begin_function
specifier|protected
name|PersistenceAdapter
name|registerPersistenceAdapterMBean
parameter_list|(
name|PersistenceAdapter
name|adaptor
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|adaptor
return|;
block|}
end_function

begin_function
specifier|protected
name|void
name|unregisterPersistenceAdapterMBean
parameter_list|(
name|PersistenceAdapter
name|adaptor
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{}
block|}
end_function

begin_function
specifier|private
name|ObjectName
name|createConnectorObjectName
parameter_list|(
name|TransportConnector
name|connector
parameter_list|)
throws|throws
name|MalformedObjectNameException
block|{
return|return
name|BrokerMBeanSupport
operator|.
name|createConnectorName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|,
literal|"clientConnectors"
argument_list|,
name|connector
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|registerNetworkConnectorMBean
parameter_list|(
name|NetworkConnector
name|connector
parameter_list|)
throws|throws
name|IOException
block|{
name|NetworkConnectorViewMBean
name|view
init|=
operator|new
name|NetworkConnectorView
argument_list|(
name|connector
argument_list|)
decl_stmt|;
try|try
block|{
name|ObjectName
name|objectName
init|=
name|createNetworkConnectorObjectName
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|connector
operator|.
name|setObjectName
argument_list|(
name|objectName
argument_list|)
expr_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|view
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"Network Connector could not be registered in JMX: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|public
name|ObjectName
name|createNetworkConnectorObjectName
parameter_list|(
name|NetworkConnector
name|connector
parameter_list|)
throws|throws
name|MalformedObjectNameException
block|{
return|return
name|BrokerMBeanSupport
operator|.
name|createNetworkConnectorName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|,
literal|"networkConnectors"
argument_list|,
name|connector
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
end_function

begin_function
specifier|public
name|ObjectName
name|createDuplexNetworkConnectorObjectName
parameter_list|(
name|String
name|transport
parameter_list|)
throws|throws
name|MalformedObjectNameException
block|{
return|return
name|BrokerMBeanSupport
operator|.
name|createNetworkConnectorName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|,
literal|"duplexNetworkConnectors"
argument_list|,
name|transport
argument_list|)
return|;
block|}
end_function

begin_function
specifier|protected
name|void
name|unregisterNetworkConnectorMBean
parameter_list|(
name|NetworkConnector
name|connector
parameter_list|)
block|{
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
try|try
block|{
name|ObjectName
name|objectName
init|=
name|createNetworkConnectorObjectName
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|getManagementContext
argument_list|()
operator|.
name|unregisterMBean
argument_list|(
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Network Connector could not be unregistered from JMX due "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
operator|+
literal|". This exception is ignored."
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|registerProxyConnectorMBean
parameter_list|(
name|ProxyConnector
name|connector
parameter_list|)
throws|throws
name|IOException
block|{
name|ProxyConnectorView
name|view
init|=
operator|new
name|ProxyConnectorView
argument_list|(
name|connector
argument_list|)
decl_stmt|;
try|try
block|{
name|ObjectName
name|objectName
init|=
name|BrokerMBeanSupport
operator|.
name|createNetworkConnectorName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|,
literal|"proxyConnectors"
argument_list|,
name|connector
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|view
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"Broker could not be registered in JMX: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|registerJmsConnectorMBean
parameter_list|(
name|JmsConnector
name|connector
parameter_list|)
throws|throws
name|IOException
block|{
name|JmsConnectorView
name|view
init|=
operator|new
name|JmsConnectorView
argument_list|(
name|connector
argument_list|)
decl_stmt|;
try|try
block|{
name|ObjectName
name|objectName
init|=
name|BrokerMBeanSupport
operator|.
name|createNetworkConnectorName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|,
literal|"jmsConnectors"
argument_list|,
name|connector
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|view
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"Broker could not be registered in JMX: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_comment
comment|/**      * Factory method to create a new broker      *      * @throws Exception      */
end_comment

begin_function
specifier|protected
name|Broker
name|createBroker
parameter_list|()
throws|throws
name|Exception
block|{
name|regionBroker
operator|=
name|createRegionBroker
argument_list|()
expr_stmt|;
name|Broker
name|broker
init|=
name|addInterceptors
argument_list|(
name|regionBroker
argument_list|)
decl_stmt|;
comment|// Add a filter that will stop access to the broker once stopped
name|broker
operator|=
operator|new
name|MutableBrokerFilter
argument_list|(
name|broker
argument_list|)
block|{
name|Broker
name|old
decl_stmt|;
annotation|@
name|Override
specifier|public
name|void
name|stop
parameter_list|()
throws|throws
name|Exception
block|{
name|old
operator|=
name|this
operator|.
name|next
operator|.
name|getAndSet
argument_list|(
operator|new
name|ErrorBroker
argument_list|(
literal|"Broker has been stopped: "
operator|+
name|this
argument_list|)
block|{
comment|// Just ignore additional stop actions.
annotation|@
name|Override
specifier|public
name|void
name|stop
parameter_list|()
throws|throws
name|Exception
block|{                     }
block|}
argument_list|)
expr_stmt|;
name|old
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|start
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|forceStart
operator|&&
name|old
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|next
operator|.
name|set
argument_list|(
name|old
argument_list|)
expr_stmt|;
block|}
name|getNext
argument_list|()
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
block|}
expr_stmt|;
return|return
name|broker
return|;
block|}
end_function

begin_comment
comment|/**      * Factory method to create the core region broker onto which interceptors      * are added      *      * @throws Exception      */
end_comment

begin_function
specifier|protected
name|Broker
name|createRegionBroker
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|destinationInterceptors
operator|==
literal|null
condition|)
block|{
name|destinationInterceptors
operator|=
name|createDefaultDestinationInterceptor
argument_list|()
expr_stmt|;
block|}
name|configureServices
argument_list|(
name|destinationInterceptors
argument_list|)
expr_stmt|;
name|DestinationInterceptor
name|destinationInterceptor
init|=
operator|new
name|CompositeDestinationInterceptor
argument_list|(
name|destinationInterceptors
argument_list|)
decl_stmt|;
if|if
condition|(
name|destinationFactory
operator|==
literal|null
condition|)
block|{
name|destinationFactory
operator|=
operator|new
name|DestinationFactoryImpl
argument_list|(
name|this
argument_list|,
name|getTaskRunnerFactory
argument_list|()
argument_list|,
name|getPersistenceAdapter
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|createRegionBroker
argument_list|(
name|destinationInterceptor
argument_list|)
return|;
block|}
end_function

begin_function
specifier|protected
name|Broker
name|createRegionBroker
parameter_list|(
name|DestinationInterceptor
name|destinationInterceptor
parameter_list|)
throws|throws
name|IOException
block|{
name|RegionBroker
name|regionBroker
decl_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
try|try
block|{
name|regionBroker
operator|=
operator|new
name|ManagedRegionBroker
argument_list|(
name|this
argument_list|,
name|getManagementContext
argument_list|()
argument_list|,
name|getBrokerObjectName
argument_list|()
argument_list|,
name|getTaskRunnerFactory
argument_list|()
argument_list|,
name|getConsumerSystemUsage
argument_list|()
argument_list|,
name|destinationFactory
argument_list|,
name|destinationInterceptor
argument_list|,
name|getScheduler
argument_list|()
argument_list|,
name|getExecutor
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|MalformedObjectNameException
name|me
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Cannot create ManagedRegionBroker due "
operator|+
name|me
operator|.
name|getMessage
argument_list|()
argument_list|,
name|me
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|me
argument_list|)
throw|;
block|}
block|}
else|else
block|{
name|regionBroker
operator|=
operator|new
name|RegionBroker
argument_list|(
name|this
argument_list|,
name|getTaskRunnerFactory
argument_list|()
argument_list|,
name|getConsumerSystemUsage
argument_list|()
argument_list|,
name|destinationFactory
argument_list|,
name|destinationInterceptor
argument_list|,
name|getScheduler
argument_list|()
argument_list|,
name|getExecutor
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|destinationFactory
operator|.
name|setRegionBroker
argument_list|(
name|regionBroker
argument_list|)
expr_stmt|;
name|regionBroker
operator|.
name|setKeepDurableSubsActive
argument_list|(
name|keepDurableSubsActive
argument_list|)
expr_stmt|;
name|regionBroker
operator|.
name|setBrokerName
argument_list|(
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
name|regionBroker
operator|.
name|getDestinationStatistics
argument_list|()
operator|.
name|setEnabled
argument_list|(
name|enableStatistics
argument_list|)
expr_stmt|;
name|regionBroker
operator|.
name|setAllowTempAutoCreationOnSend
argument_list|(
name|isAllowTempAutoCreationOnSend
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|brokerId
operator|!=
literal|null
condition|)
block|{
name|regionBroker
operator|.
name|setBrokerId
argument_list|(
name|brokerId
argument_list|)
expr_stmt|;
block|}
return|return
name|regionBroker
return|;
block|}
end_function

begin_comment
comment|/**      * Create the default destination interceptor      */
end_comment

begin_function
specifier|protected
name|DestinationInterceptor
index|[]
name|createDefaultDestinationInterceptor
parameter_list|()
block|{
name|List
argument_list|<
name|DestinationInterceptor
argument_list|>
name|answer
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|isUseVirtualTopics
argument_list|()
condition|)
block|{
name|VirtualDestinationInterceptor
name|interceptor
init|=
operator|new
name|VirtualDestinationInterceptor
argument_list|()
decl_stmt|;
name|VirtualTopic
name|virtualTopic
init|=
operator|new
name|VirtualTopic
argument_list|()
decl_stmt|;
name|virtualTopic
operator|.
name|setName
argument_list|(
literal|"VirtualTopic.>"
argument_list|)
expr_stmt|;
name|VirtualDestination
index|[]
name|virtualDestinations
init|=
block|{
name|virtualTopic
block|}
decl_stmt|;
name|interceptor
operator|.
name|setVirtualDestinations
argument_list|(
name|virtualDestinations
argument_list|)
expr_stmt|;
name|answer
operator|.
name|add
argument_list|(
name|interceptor
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isUseMirroredQueues
argument_list|()
condition|)
block|{
name|MirroredQueue
name|interceptor
init|=
operator|new
name|MirroredQueue
argument_list|()
decl_stmt|;
name|answer
operator|.
name|add
argument_list|(
name|interceptor
argument_list|)
expr_stmt|;
block|}
name|DestinationInterceptor
index|[]
name|array
init|=
operator|new
name|DestinationInterceptor
index|[
name|answer
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
name|answer
operator|.
name|toArray
argument_list|(
name|array
argument_list|)
expr_stmt|;
return|return
name|array
return|;
block|}
end_function

begin_comment
comment|/**      * Strategy method to add interceptors to the broker      *      * @throws IOException      */
end_comment

begin_function
specifier|protected
name|Broker
name|addInterceptors
parameter_list|(
name|Broker
name|broker
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|isSchedulerSupport
argument_list|()
condition|)
block|{
name|SchedulerBroker
name|sb
init|=
operator|new
name|SchedulerBroker
argument_list|(
name|this
argument_list|,
name|broker
argument_list|,
name|getJobSchedulerStore
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|JobSchedulerViewMBean
name|view
init|=
operator|new
name|JobSchedulerView
argument_list|(
name|sb
operator|.
name|getJobScheduler
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|ObjectName
name|objectName
init|=
name|BrokerMBeanSupport
operator|.
name|createJobSchedulerServiceName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|)
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|view
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
name|this
operator|.
name|adminView
operator|.
name|setJMSJobScheduler
argument_list|(
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"JobScheduler could not be registered in JMX: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
name|broker
operator|=
name|sb
expr_stmt|;
block|}
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|HealthViewMBean
name|statusView
init|=
operator|new
name|HealthView
argument_list|(
operator|(
name|ManagedRegionBroker
operator|)
name|getRegionBroker
argument_list|()
argument_list|)
decl_stmt|;
try|try
block|{
name|ObjectName
name|objectName
init|=
name|BrokerMBeanSupport
operator|.
name|createHealthServiceName
argument_list|(
name|getBrokerObjectName
argument_list|()
argument_list|)
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|statusView
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
literal|"Status MBean could not be registered in JMX: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
if|if
condition|(
name|isAdvisorySupport
argument_list|()
condition|)
block|{
name|broker
operator|=
operator|new
name|AdvisoryBroker
argument_list|(
name|broker
argument_list|)
expr_stmt|;
block|}
name|broker
operator|=
operator|new
name|CompositeDestinationBroker
argument_list|(
name|broker
argument_list|)
expr_stmt|;
name|broker
operator|=
operator|new
name|TransactionBroker
argument_list|(
name|broker
argument_list|,
name|getPersistenceAdapter
argument_list|()
operator|.
name|createTransactionStore
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|isPopulateJMSXUserID
argument_list|()
condition|)
block|{
name|UserIDBroker
name|userIDBroker
init|=
operator|new
name|UserIDBroker
argument_list|(
name|broker
argument_list|)
decl_stmt|;
name|userIDBroker
operator|.
name|setUseAuthenticatePrincipal
argument_list|(
name|isUseAuthenticatedPrincipalForJMSXUserID
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|=
name|userIDBroker
expr_stmt|;
block|}
if|if
condition|(
name|isMonitorConnectionSplits
argument_list|()
condition|)
block|{
name|broker
operator|=
operator|new
name|ConnectionSplitBroker
argument_list|(
name|broker
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|plugins
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|plugins
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|BrokerPlugin
name|plugin
init|=
name|plugins
index|[
name|i
index|]
decl_stmt|;
name|broker
operator|=
name|plugin
operator|.
name|installPlugin
argument_list|(
name|broker
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|broker
return|;
block|}
end_function

begin_function
specifier|protected
name|PersistenceAdapter
name|createPersistenceAdapter
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|isPersistent
argument_list|()
condition|)
block|{
name|PersistenceAdapterFactory
name|fac
init|=
name|getPersistenceFactory
argument_list|()
decl_stmt|;
if|if
condition|(
name|fac
operator|!=
literal|null
condition|)
block|{
return|return
name|fac
operator|.
name|createPersistenceAdapter
argument_list|()
return|;
block|}
else|else
block|{
try|try
block|{
name|String
name|clazz
init|=
literal|"org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter"
decl_stmt|;
name|PersistenceAdapter
name|adaptor
init|=
operator|(
name|PersistenceAdapter
operator|)
name|getClass
argument_list|()
operator|.
name|getClassLoader
argument_list|()
operator|.
name|loadClass
argument_list|(
name|clazz
argument_list|)
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|File
name|dir
init|=
operator|new
name|File
argument_list|(
name|getBrokerDataDirectory
argument_list|()
argument_list|,
literal|"KahaDB"
argument_list|)
decl_stmt|;
name|adaptor
operator|.
name|setDirectory
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
name|adaptor
return|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|IOExceptionSupport
operator|.
name|create
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
else|else
block|{
return|return
operator|new
name|MemoryPersistenceAdapter
argument_list|()
return|;
block|}
block|}
end_function

begin_function
specifier|protected
name|ObjectName
name|createBrokerObjectName
parameter_list|()
throws|throws
name|MalformedObjectNameException
block|{
return|return
name|BrokerMBeanSupport
operator|.
name|createBrokerObjectName
argument_list|(
name|getManagementContext
argument_list|()
operator|.
name|getJmxDomainName
argument_list|()
argument_list|,
name|getBrokerName
argument_list|()
argument_list|)
return|;
block|}
end_function

begin_function
specifier|protected
name|TransportConnector
name|createTransportConnector
parameter_list|(
name|URI
name|brokerURI
parameter_list|)
throws|throws
name|Exception
block|{
name|TransportServer
name|transport
init|=
name|TransportFactorySupport
operator|.
name|bind
argument_list|(
name|this
argument_list|,
name|brokerURI
argument_list|)
decl_stmt|;
return|return
operator|new
name|TransportConnector
argument_list|(
name|transport
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**      * Extracts the port from the options      */
end_comment

begin_function
specifier|protected
name|Object
name|getPort
parameter_list|(
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
name|options
parameter_list|)
block|{
name|Object
name|port
init|=
name|options
operator|.
name|get
argument_list|(
literal|"port"
argument_list|)
decl_stmt|;
if|if
condition|(
name|port
operator|==
literal|null
condition|)
block|{
name|port
operator|=
name|DEFAULT_PORT
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"No port specified so defaulting to: {}"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
return|return
name|port
return|;
block|}
end_function

begin_function
specifier|protected
name|void
name|addShutdownHook
parameter_list|()
block|{
if|if
condition|(
name|useShutdownHook
condition|)
block|{
name|shutdownHook
operator|=
operator|new
name|Thread
argument_list|(
literal|"ActiveMQ ShutdownHook"
argument_list|)
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|containerShutdown
argument_list|()
expr_stmt|;
block|}
block|}
expr_stmt|;
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|addShutdownHook
argument_list|(
name|shutdownHook
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|removeShutdownHook
parameter_list|()
block|{
if|if
condition|(
name|shutdownHook
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|removeShutdownHook
argument_list|(
name|shutdownHook
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Caught exception, must be shutting down. This exception is ignored."
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * Sets hooks to be executed when broker shut down      *      * @org.apache.xbean.Property      */
end_comment

begin_function
specifier|public
name|void
name|setShutdownHooks
parameter_list|(
name|List
argument_list|<
name|Runnable
argument_list|>
name|hooks
parameter_list|)
throws|throws
name|Exception
block|{
for|for
control|(
name|Runnable
name|hook
range|:
name|hooks
control|)
block|{
name|addShutdownHook
argument_list|(
name|hook
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**      * Causes a clean shutdown of the container when the VM is being shut down      */
end_comment

begin_function
specifier|protected
name|void
name|containerShutdown
parameter_list|()
block|{
try|try
block|{
name|stop
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|Throwable
name|linkedException
init|=
name|e
operator|.
name|getCause
argument_list|()
decl_stmt|;
if|if
condition|(
name|linkedException
operator|!=
literal|null
condition|)
block|{
name|logError
argument_list|(
literal|"Failed to shut down: "
operator|+
name|e
operator|+
literal|". Reason: "
operator|+
name|linkedException
argument_list|,
name|linkedException
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|logError
argument_list|(
literal|"Failed to shut down: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|useLoggingForShutdownErrors
condition|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|(
name|System
operator|.
name|err
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logError
argument_list|(
literal|"Failed to shut down: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|logError
parameter_list|(
name|String
name|message
parameter_list|,
name|Throwable
name|e
parameter_list|)
block|{
if|if
condition|(
name|useLoggingForShutdownErrors
condition|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to shut down: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Failed to shut down: "
operator|+
name|e
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**      * Starts any configured destinations on startup      */
end_comment

begin_function
specifier|protected
name|void
name|startDestinations
parameter_list|()
throws|throws
name|Exception
block|{
if|if
condition|(
name|destinations
operator|!=
literal|null
condition|)
block|{
name|ConnectionContext
name|adminConnectionContext
init|=
name|getAdminConnectionContext
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|destinations
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|ActiveMQDestination
name|destination
init|=
name|destinations
index|[
name|i
index|]
decl_stmt|;
name|getBroker
argument_list|()
operator|.
name|addDestination
argument_list|(
name|adminConnectionContext
argument_list|,
name|destination
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isUseVirtualTopics
argument_list|()
condition|)
block|{
name|startVirtualConsumerDestinations
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**      * Returns the broker's administration connection context used for      * configuring the broker at startup      */
end_comment

begin_function
specifier|public
name|ConnectionContext
name|getAdminConnectionContext
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|BrokerSupport
operator|.
name|getConnectionContext
argument_list|(
name|getBroker
argument_list|()
argument_list|)
return|;
block|}
end_function

begin_function
specifier|protected
name|void
name|startManagementContext
parameter_list|()
throws|throws
name|Exception
block|{
name|getManagementContext
argument_list|()
operator|.
name|setBrokerName
argument_list|(
name|brokerName
argument_list|)
expr_stmt|;
name|getManagementContext
argument_list|()
operator|.
name|start
argument_list|()
expr_stmt|;
name|adminView
operator|=
operator|new
name|BrokerView
argument_list|(
name|this
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|ObjectName
name|objectName
init|=
name|getBrokerObjectName
argument_list|()
decl_stmt|;
name|AnnotatedMBean
operator|.
name|registerMBean
argument_list|(
name|getManagementContext
argument_list|()
argument_list|,
name|adminView
argument_list|,
name|objectName
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Start all transport and network connections, proxies and bridges      *      * @throws Exception      */
end_comment

begin_function
specifier|public
name|void
name|startAllConnectors
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|Set
argument_list|<
name|ActiveMQDestination
argument_list|>
name|durableDestinations
init|=
name|getBroker
argument_list|()
operator|.
name|getDurableDestinations
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|TransportConnector
argument_list|>
name|al
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
argument_list|<
name|TransportConnector
argument_list|>
name|iter
init|=
name|getTransportConnectors
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|TransportConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|al
operator|.
name|add
argument_list|(
name|startTransportConnector
argument_list|(
name|connector
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|al
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
comment|// let's clear the transportConnectors list and replace it with
comment|// the started transportConnector instances
name|this
operator|.
name|transportConnectors
operator|.
name|clear
argument_list|()
expr_stmt|;
name|setTransportConnectors
argument_list|(
name|al
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|slave
operator|=
literal|false
expr_stmt|;
if|if
condition|(
operator|!
name|stopped
operator|.
name|get
argument_list|()
condition|)
block|{
name|ThreadPoolExecutor
name|networkConnectorStartExecutor
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|isNetworkConnectorStartAsync
argument_list|()
condition|)
block|{
comment|// spin up as many threads as needed
name|networkConnectorStartExecutor
operator|=
operator|new
name|ThreadPoolExecutor
argument_list|(
literal|0
argument_list|,
name|Integer
operator|.
name|MAX_VALUE
argument_list|,
literal|10
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|,
operator|new
name|SynchronousQueue
argument_list|<
name|Runnable
argument_list|>
argument_list|()
argument_list|,
operator|new
name|ThreadFactory
argument_list|()
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
annotation|@
name|Override
specifier|public
name|Thread
name|newThread
parameter_list|(
name|Runnable
name|runnable
parameter_list|)
block|{
name|Thread
name|thread
init|=
operator|new
name|Thread
argument_list|(
name|runnable
argument_list|,
literal|"NetworkConnector Start Thread-"
operator|+
operator|(
name|count
operator|++
operator|)
argument_list|)
decl_stmt|;
name|thread
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
name|thread
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Iterator
argument_list|<
name|NetworkConnector
argument_list|>
name|iter
init|=
name|getNetworkConnectors
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
specifier|final
name|NetworkConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|connector
operator|.
name|setLocalUri
argument_list|(
name|getVmConnectorURI
argument_list|()
argument_list|)
expr_stmt|;
name|startNetworkConnector
argument_list|(
name|connector
argument_list|,
name|durableDestinations
argument_list|,
name|networkConnectorStartExecutor
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|networkConnectorStartExecutor
operator|!=
literal|null
condition|)
block|{
comment|// executor done when enqueued tasks are complete
name|ThreadPoolUtils
operator|.
name|shutdown
argument_list|(
name|networkConnectorStartExecutor
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Iterator
argument_list|<
name|ProxyConnector
argument_list|>
name|iter
init|=
name|getProxyConnectors
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|ProxyConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|connector
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
for|for
control|(
name|Iterator
argument_list|<
name|JmsConnector
argument_list|>
name|iter
init|=
name|jmsConnectors
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|JmsConnector
name|connector
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|connector
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
for|for
control|(
name|Service
name|service
range|:
name|services
control|)
block|{
name|configureService
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|service
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|public
name|void
name|startNetworkConnector
parameter_list|(
specifier|final
name|NetworkConnector
name|connector
parameter_list|,
specifier|final
name|ThreadPoolExecutor
name|networkConnectorStartExecutor
parameter_list|)
throws|throws
name|Exception
block|{
name|startNetworkConnector
argument_list|(
name|connector
argument_list|,
name|getBroker
argument_list|()
operator|.
name|getDurableDestinations
argument_list|()
argument_list|,
name|networkConnectorStartExecutor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|startNetworkConnector
parameter_list|(
specifier|final
name|NetworkConnector
name|connector
parameter_list|,
specifier|final
name|Set
argument_list|<
name|ActiveMQDestination
argument_list|>
name|durableDestinations
parameter_list|,
specifier|final
name|ThreadPoolExecutor
name|networkConnectorStartExecutor
parameter_list|)
throws|throws
name|Exception
block|{
name|connector
operator|.
name|setBrokerName
argument_list|(
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
comment|//set the durable destinations to match the broker if not set on the connector
if|if
condition|(
name|connector
operator|.
name|getDurableDestinations
argument_list|()
operator|==
literal|null
condition|)
block|{
name|connector
operator|.
name|setDurableDestinations
argument_list|(
name|durableDestinations
argument_list|)
expr_stmt|;
block|}
name|String
name|defaultSocketURI
init|=
name|getDefaultSocketURIString
argument_list|()
decl_stmt|;
if|if
condition|(
name|defaultSocketURI
operator|!=
literal|null
condition|)
block|{
name|connector
operator|.
name|setBrokerURL
argument_list|(
name|defaultSocketURI
argument_list|)
expr_stmt|;
block|}
comment|//If using the runtime plugin to start a network connector then the mbean needs
comment|//to be added, under normal start it will already exist so check for InstanceNotFoundException
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|ObjectName
name|networkMbean
init|=
name|createNetworkConnectorObjectName
argument_list|(
name|connector
argument_list|)
decl_stmt|;
try|try
block|{
name|getManagementContext
argument_list|()
operator|.
name|getObjectInstance
argument_list|(
name|networkMbean
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InstanceNotFoundException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Network connector MBean {} not found, registering"
argument_list|,
name|networkMbean
argument_list|)
expr_stmt|;
name|registerNetworkConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|networkConnectorStartExecutor
operator|!=
literal|null
condition|)
block|{
name|networkConnectorStartExecutor
operator|.
name|execute
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Async start of {}"
argument_list|,
name|connector
argument_list|)
expr_stmt|;
name|connector
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Async start of network connector: {} failed"
argument_list|,
name|connector
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|connector
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|TransportConnector
name|startTransportConnector
parameter_list|(
name|TransportConnector
name|connector
parameter_list|)
throws|throws
name|Exception
block|{
name|connector
operator|.
name|setBrokerService
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|connector
operator|.
name|setTaskRunnerFactory
argument_list|(
name|getTaskRunnerFactory
argument_list|()
argument_list|)
expr_stmt|;
name|MessageAuthorizationPolicy
name|policy
init|=
name|getMessageAuthorizationPolicy
argument_list|()
decl_stmt|;
if|if
condition|(
name|policy
operator|!=
literal|null
condition|)
block|{
name|connector
operator|.
name|setMessageAuthorizationPolicy
argument_list|(
name|policy
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isUseJmx
argument_list|()
condition|)
block|{
name|connector
operator|=
name|registerConnectorMBean
argument_list|(
name|connector
argument_list|)
expr_stmt|;
block|}
name|connector
operator|.
name|getStatistics
argument_list|()
operator|.
name|setEnabled
argument_list|(
name|enableStatistics
argument_list|)
expr_stmt|;
name|connector
operator|.
name|start
argument_list|()
expr_stmt|;
return|return
name|connector
return|;
block|}
end_function

begin_comment
comment|/**      * Perform any custom dependency injection      */
end_comment

begin_function
specifier|protected
name|void
name|configureServices
parameter_list|(
name|Object
index|[]
name|services
parameter_list|)
block|{
for|for
control|(
name|Object
name|service
range|:
name|services
control|)
block|{
name|configureService
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**      * Perform any custom dependency injection      */
end_comment

begin_function
specifier|protected
name|void
name|configureService
parameter_list|(
name|Object
name|service
parameter_list|)
block|{
if|if
condition|(
name|service
operator|instanceof
name|BrokerServiceAware
condition|)
block|{
name|BrokerServiceAware
name|serviceAware
init|=
operator|(
name|BrokerServiceAware
operator|)
name|service
decl_stmt|;
name|serviceAware
operator|.
name|setBrokerService
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|void
name|handleIOException
parameter_list|(
name|IOException
name|exception
parameter_list|)
block|{
if|if
condition|(
name|ioExceptionHandler
operator|!=
literal|null
condition|)
block|{
name|ioExceptionHandler
operator|.
name|handle
argument_list|(
name|exception
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"No IOExceptionHandler registered, ignoring IO exception"
argument_list|,
name|exception
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|startVirtualConsumerDestinations
parameter_list|()
throws|throws
name|Exception
block|{
name|checkStartException
argument_list|()
expr_stmt|;
name|ConnectionContext
name|adminConnectionContext
init|=
name|getAdminConnectionContext
argument_list|()
decl_stmt|;
name|Set
argument_list|<
name|ActiveMQDestination
argument_list|>
name|destinations
init|=
name|destinationFactory
operator|.
name|getDestinations
argument_list|()
decl_stmt|;
name|DestinationFilter
name|filter
init|=
name|getVirtualTopicConsumerDestinationFilter
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|destinations
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|ActiveMQDestination
name|destination
range|:
name|destinations
control|)
block|{
if|if
condition|(
name|filter
operator|.
name|matches
argument_list|(
name|destination
argument_list|)
operator|==
literal|true
condition|)
block|{
name|broker
operator|.
name|addDestination
argument_list|(
name|adminConnectionContext
argument_list|,
name|destination
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|private
name|DestinationFilter
name|getVirtualTopicConsumerDestinationFilter
parameter_list|()
block|{
comment|// created at startup, so no sync needed
if|if
condition|(
name|virtualConsumerDestinationFilter
operator|==
literal|null
condition|)
block|{
name|Set
argument_list|<
name|ActiveMQQueue
argument_list|>
name|consumerDestinations
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|destinationInterceptors
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|DestinationInterceptor
name|interceptor
range|:
name|destinationInterceptors
control|)
block|{
if|if
condition|(
name|interceptor
operator|instanceof
name|VirtualDestinationInterceptor
condition|)
block|{
name|VirtualDestinationInterceptor
name|virtualDestinationInterceptor
init|=
operator|(
name|VirtualDestinationInterceptor
operator|)
name|interceptor
decl_stmt|;
for|for
control|(
name|VirtualDestination
name|virtualDestination
range|:
name|virtualDestinationInterceptor
operator|.
name|getVirtualDestinations
argument_list|()
control|)
block|{
if|if
condition|(
name|virtualDestination
operator|instanceof
name|VirtualTopic
condition|)
block|{
name|consumerDestinations
operator|.
name|add
argument_list|(
operator|new
name|ActiveMQQueue
argument_list|(
operator|(
operator|(
name|VirtualTopic
operator|)
name|virtualDestination
operator|)
operator|.
name|getPrefix
argument_list|()
operator|+
name|DestinationFilter
operator|.
name|ANY_DESCENDENT
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isUseVirtualDestSubs
argument_list|()
condition|)
block|{
try|try
block|{
name|broker
operator|.
name|virtualDestinationAdded
argument_list|(
name|getAdminConnectionContext
argument_list|()
argument_list|,
name|virtualDestination
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Adding virtual destination: {}"
argument_list|,
name|virtualDestination
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Could not fire virtual destination consumer advisory"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
name|ActiveMQQueue
name|filter
init|=
operator|new
name|ActiveMQQueue
argument_list|()
decl_stmt|;
name|filter
operator|.
name|setCompositeDestinations
argument_list|(
name|consumerDestinations
operator|.
name|toArray
argument_list|(
operator|new
name|ActiveMQDestination
index|[]
block|{}
argument_list|)
argument_list|)
expr_stmt|;
name|virtualConsumerDestinationFilter
operator|=
name|DestinationFilter
operator|.
name|parseFilter
argument_list|(
name|filter
argument_list|)
expr_stmt|;
block|}
return|return
name|virtualConsumerDestinationFilter
return|;
block|}
end_function

begin_function
specifier|protected
specifier|synchronized
name|ThreadPoolExecutor
name|getExecutor
parameter_list|()
block|{
if|if
condition|(
name|this
operator|.
name|executor
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|executor
operator|=
operator|new
name|ThreadPoolExecutor
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|60
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|,
operator|new
name|LinkedBlockingQueue
argument_list|<
name|Runnable
argument_list|>
argument_list|()
argument_list|,
operator|new
name|ThreadFactory
argument_list|()
block|{
specifier|private
name|long
name|i
init|=
literal|0
decl_stmt|;
annotation|@
name|Override
specifier|public
name|Thread
name|newThread
parameter_list|(
name|Runnable
name|runnable
parameter_list|)
block|{
name|this
operator|.
name|i
operator|++
expr_stmt|;
name|Thread
name|thread
init|=
operator|new
name|Thread
argument_list|(
name|runnable
argument_list|,
literal|"ActiveMQ BrokerService.worker."
operator|+
name|this
operator|.
name|i
argument_list|)
decl_stmt|;
name|thread
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|thread
operator|.
name|setUncaughtExceptionHandler
argument_list|(
operator|new
name|Thread
operator|.
name|UncaughtExceptionHandler
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|uncaughtException
parameter_list|(
specifier|final
name|Thread
name|t
parameter_list|,
specifier|final
name|Throwable
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error in thread '{}'"
argument_list|,
name|t
operator|.
name|getName
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
return|return
name|thread
return|;
block|}
block|}
argument_list|,
operator|new
name|RejectedExecutionHandler
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|rejectedExecution
parameter_list|(
specifier|final
name|Runnable
name|r
parameter_list|,
specifier|final
name|ThreadPoolExecutor
name|executor
parameter_list|)
block|{
try|try
block|{
name|executor
operator|.
name|getQueue
argument_list|()
operator|.
name|offer
argument_list|(
name|r
argument_list|,
literal|60
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RejectedExecutionException
argument_list|(
literal|"Interrupted waiting for BrokerService.worker"
argument_list|)
throw|;
block|}
throw|throw
operator|new
name|RejectedExecutionException
argument_list|(
literal|"Timed Out while attempting to enqueue Task."
argument_list|)
throw|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
return|return
name|this
operator|.
name|executor
return|;
block|}
end_function

begin_function
specifier|public
specifier|synchronized
name|Scheduler
name|getScheduler
parameter_list|()
block|{
if|if
condition|(
name|this
operator|.
name|scheduler
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|scheduler
operator|=
operator|new
name|Scheduler
argument_list|(
literal|"ActiveMQ Broker["
operator|+
name|getBrokerName
argument_list|()
operator|+
literal|"] Scheduler"
argument_list|)
expr_stmt|;
try|try
block|{
name|this
operator|.
name|scheduler
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to start Scheduler"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|this
operator|.
name|scheduler
return|;
block|}
end_function

begin_function
specifier|public
name|Broker
name|getRegionBroker
parameter_list|()
block|{
return|return
name|regionBroker
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setRegionBroker
parameter_list|(
name|Broker
name|regionBroker
parameter_list|)
block|{
name|this
operator|.
name|regionBroker
operator|=
name|regionBroker
expr_stmt|;
block|}
end_function

begin_function
specifier|public
specifier|final
name|void
name|removePreShutdownHook
parameter_list|(
specifier|final
name|Runnable
name|hook
parameter_list|)
block|{
name|preShutdownHooks
operator|.
name|remove
argument_list|(
name|hook
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|addShutdownHook
parameter_list|(
name|Runnable
name|hook
parameter_list|)
block|{
synchronized|synchronized
init|(
name|shutdownHooks
init|)
block|{
name|shutdownHooks
operator|.
name|add
argument_list|(
name|hook
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|void
name|removeShutdownHook
parameter_list|(
name|Runnable
name|hook
parameter_list|)
block|{
synchronized|synchronized
init|(
name|shutdownHooks
init|)
block|{
name|shutdownHooks
operator|.
name|remove
argument_list|(
name|hook
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|boolean
name|isSystemExitOnShutdown
parameter_list|()
block|{
return|return
name|systemExitOnShutdown
return|;
block|}
end_function

begin_comment
comment|/**      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setSystemExitOnShutdown
parameter_list|(
name|boolean
name|systemExitOnShutdown
parameter_list|)
block|{
name|this
operator|.
name|systemExitOnShutdown
operator|=
name|systemExitOnShutdown
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getSystemExitOnShutdownExitCode
parameter_list|()
block|{
return|return
name|systemExitOnShutdownExitCode
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setSystemExitOnShutdownExitCode
parameter_list|(
name|int
name|systemExitOnShutdownExitCode
parameter_list|)
block|{
name|this
operator|.
name|systemExitOnShutdownExitCode
operator|=
name|systemExitOnShutdownExitCode
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|SslContext
name|getSslContext
parameter_list|()
block|{
return|return
name|sslContext
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setSslContext
parameter_list|(
name|SslContext
name|sslContext
parameter_list|)
block|{
name|this
operator|.
name|sslContext
operator|=
name|sslContext
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isShutdownOnSlaveFailure
parameter_list|()
block|{
return|return
name|shutdownOnSlaveFailure
return|;
block|}
end_function

begin_comment
comment|/**      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setShutdownOnSlaveFailure
parameter_list|(
name|boolean
name|shutdownOnSlaveFailure
parameter_list|)
block|{
name|this
operator|.
name|shutdownOnSlaveFailure
operator|=
name|shutdownOnSlaveFailure
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isWaitForSlave
parameter_list|()
block|{
return|return
name|waitForSlave
return|;
block|}
end_function

begin_comment
comment|/**      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setWaitForSlave
parameter_list|(
name|boolean
name|waitForSlave
parameter_list|)
block|{
name|this
operator|.
name|waitForSlave
operator|=
name|waitForSlave
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|long
name|getWaitForSlaveTimeout
parameter_list|()
block|{
return|return
name|this
operator|.
name|waitForSlaveTimeout
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setWaitForSlaveTimeout
parameter_list|(
name|long
name|waitForSlaveTimeout
parameter_list|)
block|{
name|this
operator|.
name|waitForSlaveTimeout
operator|=
name|waitForSlaveTimeout
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Get the passiveSlave      * @return the passiveSlave      */
end_comment

begin_function
specifier|public
name|boolean
name|isPassiveSlave
parameter_list|()
block|{
return|return
name|this
operator|.
name|passiveSlave
return|;
block|}
end_function

begin_comment
comment|/**      * Set the passiveSlave      * @param passiveSlave the passiveSlave to set      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setPassiveSlave
parameter_list|(
name|boolean
name|passiveSlave
parameter_list|)
block|{
name|this
operator|.
name|passiveSlave
operator|=
name|passiveSlave
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * override the Default IOException handler, called when persistence adapter      * has experiences File or JDBC I/O Exceptions      *      * @param ioExceptionHandler      */
end_comment

begin_function
specifier|public
name|void
name|setIoExceptionHandler
parameter_list|(
name|IOExceptionHandler
name|ioExceptionHandler
parameter_list|)
block|{
name|configureService
argument_list|(
name|ioExceptionHandler
argument_list|)
expr_stmt|;
name|this
operator|.
name|ioExceptionHandler
operator|=
name|ioExceptionHandler
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|IOExceptionHandler
name|getIoExceptionHandler
parameter_list|()
block|{
return|return
name|ioExceptionHandler
return|;
block|}
end_function

begin_comment
comment|/**      * @return the schedulerSupport      */
end_comment

begin_function
specifier|public
name|boolean
name|isSchedulerSupport
parameter_list|()
block|{
return|return
name|this
operator|.
name|schedulerSupport
return|;
block|}
end_function

begin_comment
comment|/**      * @param schedulerSupport the schedulerSupport to set      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.BooleanEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setSchedulerSupport
parameter_list|(
name|boolean
name|schedulerSupport
parameter_list|)
block|{
name|this
operator|.
name|schedulerSupport
operator|=
name|schedulerSupport
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the schedulerDirectory      */
end_comment

begin_function
specifier|public
name|File
name|getSchedulerDirectoryFile
parameter_list|()
block|{
if|if
condition|(
name|this
operator|.
name|schedulerDirectoryFile
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|schedulerDirectoryFile
operator|=
operator|new
name|File
argument_list|(
name|getBrokerDataDirectory
argument_list|()
argument_list|,
literal|"scheduler"
argument_list|)
expr_stmt|;
block|}
return|return
name|schedulerDirectoryFile
return|;
block|}
end_function

begin_comment
comment|/**      * @param schedulerDirectory the schedulerDirectory to set      */
end_comment

begin_function
specifier|public
name|void
name|setSchedulerDirectoryFile
parameter_list|(
name|File
name|schedulerDirectory
parameter_list|)
block|{
name|this
operator|.
name|schedulerDirectoryFile
operator|=
name|schedulerDirectory
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|setSchedulerDirectory
parameter_list|(
name|String
name|schedulerDirectory
parameter_list|)
block|{
name|setSchedulerDirectoryFile
argument_list|(
operator|new
name|File
argument_list|(
name|schedulerDirectory
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getSchedulePeriodForDestinationPurge
parameter_list|()
block|{
return|return
name|this
operator|.
name|schedulePeriodForDestinationPurge
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setSchedulePeriodForDestinationPurge
parameter_list|(
name|int
name|schedulePeriodForDestinationPurge
parameter_list|)
block|{
name|this
operator|.
name|schedulePeriodForDestinationPurge
operator|=
name|schedulePeriodForDestinationPurge
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @param schedulePeriodForDiskUsageCheck      */
end_comment

begin_function
specifier|public
name|void
name|setSchedulePeriodForDiskUsageCheck
parameter_list|(
name|int
name|schedulePeriodForDiskUsageCheck
parameter_list|)
block|{
name|this
operator|.
name|schedulePeriodForDiskUsageCheck
operator|=
name|schedulePeriodForDiskUsageCheck
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getDiskUsageCheckRegrowThreshold
parameter_list|()
block|{
return|return
name|diskUsageCheckRegrowThreshold
return|;
block|}
end_function

begin_comment
comment|/**      * @param diskUsageCheckRegrowThreshold      * @org.apache.xbean.Property propertyEditor="org.apache.activemq.util.MemoryPropertyEditor"      */
end_comment

begin_function
specifier|public
name|void
name|setDiskUsageCheckRegrowThreshold
parameter_list|(
name|int
name|diskUsageCheckRegrowThreshold
parameter_list|)
block|{
name|this
operator|.
name|diskUsageCheckRegrowThreshold
operator|=
name|diskUsageCheckRegrowThreshold
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getMaxPurgedDestinationsPerSweep
parameter_list|()
block|{
return|return
name|this
operator|.
name|maxPurgedDestinationsPerSweep
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setMaxPurgedDestinationsPerSweep
parameter_list|(
name|int
name|maxPurgedDestinationsPerSweep
parameter_list|)
block|{
name|this
operator|.
name|maxPurgedDestinationsPerSweep
operator|=
name|maxPurgedDestinationsPerSweep
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|BrokerContext
name|getBrokerContext
parameter_list|()
block|{
return|return
name|brokerContext
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setBrokerContext
parameter_list|(
name|BrokerContext
name|brokerContext
parameter_list|)
block|{
name|this
operator|.
name|brokerContext
operator|=
name|brokerContext
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|setBrokerId
parameter_list|(
name|String
name|brokerId
parameter_list|)
block|{
name|this
operator|.
name|brokerId
operator|=
operator|new
name|BrokerId
argument_list|(
name|brokerId
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseAuthenticatedPrincipalForJMSXUserID
parameter_list|()
block|{
return|return
name|useAuthenticatedPrincipalForJMSXUserID
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setUseAuthenticatedPrincipalForJMSXUserID
parameter_list|(
name|boolean
name|useAuthenticatedPrincipalForJMSXUserID
parameter_list|)
block|{
name|this
operator|.
name|useAuthenticatedPrincipalForJMSXUserID
operator|=
name|useAuthenticatedPrincipalForJMSXUserID
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Should MBeans that support showing the Authenticated User Name information have this      * value filled in or not.      *      * @return true if user names should be exposed in MBeans      */
end_comment

begin_function
specifier|public
name|boolean
name|isPopulateUserNameInMBeans
parameter_list|()
block|{
return|return
name|this
operator|.
name|populateUserNameInMBeans
return|;
block|}
end_function

begin_comment
comment|/**      * Sets whether Authenticated User Name information is shown in MBeans that support this field.      * @param value if MBeans should expose user name information.      */
end_comment

begin_function
specifier|public
name|void
name|setPopulateUserNameInMBeans
parameter_list|(
name|boolean
name|value
parameter_list|)
block|{
name|this
operator|.
name|populateUserNameInMBeans
operator|=
name|value
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * Gets the time in Milliseconds that an invocation of an MBean method will wait before      * failing.  The default value is to wait forever (zero).      *      * @return timeout in milliseconds before MBean calls fail, (default is 0 or no timeout).      */
end_comment

begin_function
specifier|public
name|long
name|getMbeanInvocationTimeout
parameter_list|()
block|{
return|return
name|mbeanInvocationTimeout
return|;
block|}
end_function

begin_comment
comment|/**      * Gets the time in Milliseconds that an invocation of an MBean method will wait before      * failing. The default value is to wait forever (zero).      *      * @param mbeanInvocationTimeout      *      timeout in milliseconds before MBean calls fail, (default is 0 or no timeout).      */
end_comment

begin_function
specifier|public
name|void
name|setMbeanInvocationTimeout
parameter_list|(
name|long
name|mbeanInvocationTimeout
parameter_list|)
block|{
name|this
operator|.
name|mbeanInvocationTimeout
operator|=
name|mbeanInvocationTimeout
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isNetworkConnectorStartAsync
parameter_list|()
block|{
return|return
name|networkConnectorStartAsync
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setNetworkConnectorStartAsync
parameter_list|(
name|boolean
name|networkConnectorStartAsync
parameter_list|)
block|{
name|this
operator|.
name|networkConnectorStartAsync
operator|=
name|networkConnectorStartAsync
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isAllowTempAutoCreationOnSend
parameter_list|()
block|{
return|return
name|allowTempAutoCreationOnSend
return|;
block|}
end_function

begin_comment
comment|/**      * enable if temp destinations need to be propagated through a network when      * advisorySupport==false. This is used in conjunction with the policy      * gcInactiveDestinations for matching temps so they can get removed      * when inactive      *      * @param allowTempAutoCreationOnSend      */
end_comment

begin_function
specifier|public
name|void
name|setAllowTempAutoCreationOnSend
parameter_list|(
name|boolean
name|allowTempAutoCreationOnSend
parameter_list|)
block|{
name|this
operator|.
name|allowTempAutoCreationOnSend
operator|=
name|allowTempAutoCreationOnSend
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|long
name|getOfflineDurableSubscriberTimeout
parameter_list|()
block|{
return|return
name|offlineDurableSubscriberTimeout
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setOfflineDurableSubscriberTimeout
parameter_list|(
name|long
name|offlineDurableSubscriberTimeout
parameter_list|)
block|{
name|this
operator|.
name|offlineDurableSubscriberTimeout
operator|=
name|offlineDurableSubscriberTimeout
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|long
name|getOfflineDurableSubscriberTaskSchedule
parameter_list|()
block|{
return|return
name|offlineDurableSubscriberTaskSchedule
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setOfflineDurableSubscriberTaskSchedule
parameter_list|(
name|long
name|offlineDurableSubscriberTaskSchedule
parameter_list|)
block|{
name|this
operator|.
name|offlineDurableSubscriberTaskSchedule
operator|=
name|offlineDurableSubscriberTaskSchedule
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|shouldRecordVirtualDestination
parameter_list|(
name|ActiveMQDestination
name|destination
parameter_list|)
block|{
return|return
name|isUseVirtualTopics
argument_list|()
operator|&&
name|destination
operator|.
name|isQueue
argument_list|()
operator|&&
name|getVirtualTopicConsumerDestinationFilter
argument_list|()
operator|.
name|matches
argument_list|(
name|destination
argument_list|)
return|;
block|}
end_function

begin_function
specifier|synchronized
specifier|public
name|Throwable
name|getStartException
parameter_list|()
block|{
return|return
name|startException
return|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isStartAsync
parameter_list|()
block|{
return|return
name|startAsync
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setStartAsync
parameter_list|(
name|boolean
name|startAsync
parameter_list|)
block|{
name|this
operator|.
name|startAsync
operator|=
name|startAsync
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isSlave
parameter_list|()
block|{
return|return
name|this
operator|.
name|slave
return|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isStopping
parameter_list|()
block|{
return|return
name|this
operator|.
name|stopping
operator|.
name|get
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**      * @return true if the broker allowed to restart on shutdown.      */
end_comment

begin_function
specifier|public
name|boolean
name|isRestartAllowed
parameter_list|()
block|{
return|return
name|restartAllowed
return|;
block|}
end_function

begin_comment
comment|/**      * Sets if the broker allowed to restart on shutdown.      */
end_comment

begin_function
specifier|public
name|void
name|setRestartAllowed
parameter_list|(
name|boolean
name|restartAllowed
parameter_list|)
block|{
name|this
operator|.
name|restartAllowed
operator|=
name|restartAllowed
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * A lifecycle manager of the BrokerService should      * inspect this property after a broker shutdown has occurred      * to find out if the broker needs to be re-created and started      * again.      *      * @return true if the broker wants to be restarted after it shuts down.      */
end_comment

begin_function
specifier|public
name|boolean
name|isRestartRequested
parameter_list|()
block|{
return|return
name|restartRequested
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|requestRestart
parameter_list|()
block|{
name|this
operator|.
name|restartRequested
operator|=
literal|true
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|int
name|getStoreOpenWireVersion
parameter_list|()
block|{
return|return
name|storeOpenWireVersion
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setStoreOpenWireVersion
parameter_list|(
name|int
name|storeOpenWireVersion
parameter_list|)
block|{
name|this
operator|.
name|storeOpenWireVersion
operator|=
name|storeOpenWireVersion
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the current number of connections on this Broker.      */
end_comment

begin_function
specifier|public
name|int
name|getCurrentConnections
parameter_list|()
block|{
return|return
name|this
operator|.
name|currentConnections
operator|.
name|get
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**      * @return the total number of connections this broker has handled since startup.      */
end_comment

begin_function
specifier|public
name|long
name|getTotalConnections
parameter_list|()
block|{
return|return
name|this
operator|.
name|totalConnections
operator|.
name|get
argument_list|()
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|incrementCurrentConnections
parameter_list|()
block|{
name|this
operator|.
name|currentConnections
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|decrementCurrentConnections
parameter_list|()
block|{
name|this
operator|.
name|currentConnections
operator|.
name|decrementAndGet
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|incrementTotalConnections
parameter_list|()
block|{
name|this
operator|.
name|totalConnections
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isRejectDurableConsumers
parameter_list|()
block|{
return|return
name|rejectDurableConsumers
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setRejectDurableConsumers
parameter_list|(
name|boolean
name|rejectDurableConsumers
parameter_list|)
block|{
name|this
operator|.
name|rejectDurableConsumers
operator|=
name|rejectDurableConsumers
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseVirtualDestSubs
parameter_list|()
block|{
return|return
name|useVirtualDestSubs
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setUseVirtualDestSubs
parameter_list|(
name|boolean
name|useVirtualDestSubs
parameter_list|)
block|{
name|this
operator|.
name|useVirtualDestSubs
operator|=
name|useVirtualDestSubs
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isUseVirtualDestSubsOnCreation
parameter_list|()
block|{
return|return
name|useVirtualDestSubsOnCreation
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setUseVirtualDestSubsOnCreation
parameter_list|(
name|boolean
name|useVirtualDestSubsOnCreation
parameter_list|)
block|{
name|this
operator|.
name|useVirtualDestSubsOnCreation
operator|=
name|useVirtualDestSubsOnCreation
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isAdjustUsageLimits
parameter_list|()
block|{
return|return
name|adjustUsageLimits
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setAdjustUsageLimits
parameter_list|(
name|boolean
name|adjustUsageLimits
parameter_list|)
block|{
name|this
operator|.
name|adjustUsageLimits
operator|=
name|adjustUsageLimits
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|void
name|setRollbackOnlyOnAsyncException
parameter_list|(
name|boolean
name|rollbackOnlyOnAsyncException
parameter_list|)
block|{
name|this
operator|.
name|rollbackOnlyOnAsyncException
operator|=
name|rollbackOnlyOnAsyncException
expr_stmt|;
block|}
end_function

begin_function
specifier|public
name|boolean
name|isRollbackOnlyOnAsyncException
parameter_list|()
block|{
return|return
name|rollbackOnlyOnAsyncException
return|;
block|}
end_function

unit|}
end_unit

