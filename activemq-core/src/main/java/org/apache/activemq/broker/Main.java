begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  *  * Copyright 2004 The Apache Software Foundation  *  * Licensed under the Apache License, Version 2.0 (the "License");  * you may not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  * http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Field
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|InvocationTargetException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Method
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|JarURLConnection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|MalformedURLException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URLClassLoader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Enumeration
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|StringTokenizer
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|MBeanAttributeInfo
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|MBeanServerConnection
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|ObjectInstance
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|ObjectName
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|remote
operator|.
name|JMXConnector
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|remote
operator|.
name|JMXConnectorFactory
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|management
operator|.
name|remote
operator|.
name|JMXServiceURL
import|;
end_import

begin_comment
comment|/**  * Main class that can bootstrap a ActiveMQ Broker. Handles command line  * argument parsing to set up the broker classpath and System properties.  *  * @version $Revision$  */
end_comment

begin_class
specifier|public
class|class
name|Main
block|{
specifier|public
specifier|static
specifier|final
name|int
name|HELP_MAIN_APP
init|=
literal|0
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|HELP_START_BROKER
init|=
literal|1
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|HELP_STOP_BROKER
init|=
literal|2
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|HELP_LIST_BROKER
init|=
literal|3
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|HELP_STAT_BROKER
init|=
literal|4
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|HELP_QUERY_BROKER
init|=
literal|5
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_NONE
init|=
literal|0
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_START_BROKER
init|=
literal|1
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_STOP_BROKER
init|=
literal|2
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_LIST_BROKER
init|=
literal|3
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_STAT_BROKER
init|=
literal|4
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_QUERY_BROKER
init|=
literal|5
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_MAIN_HELP
init|=
literal|6
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_START_HELP
init|=
literal|7
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_STOP_HELP
init|=
literal|8
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_LIST_HELP
init|=
literal|9
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_STAT_HELP
init|=
literal|10
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_QUERY_HELP
init|=
literal|11
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_ALL_HELP
init|=
literal|12
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|int
name|TASK_PRINT_VER
init|=
literal|13
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|BROKER_FACTORY_CLASS
init|=
literal|"org.apache.activemq.broker.BrokerFactory"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_CONFIG_URI
init|=
literal|"xbean:activemq.xml"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_JMX_URL
init|=
literal|"service:jmx:rmi:///jndi/rmi://localhost:1099/jmxconnector"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|DEFAULT_JMX_DOMAIN
init|=
literal|"org.apache.activemq"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|DEFAULT_KEY_BROKER_NAME
init|=
literal|"BrokerName"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|DEFAULT_METHOD_BROKER_STOP
init|=
literal|"terminateJVM"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Object
index|[]
name|DEFAULT_PARAM_BROKER_STOP
init|=
operator|new
name|Object
index|[]
block|{
operator|new
name|Integer
argument_list|(
literal|0
argument_list|)
block|}
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
index|[]
name|DEFAULT_SIGN_BROKER_STOP
init|=
operator|new
name|String
index|[]
block|{
literal|"int"
block|}
decl_stmt|;
comment|// Stat retrieve flags
specifier|private
specifier|static
specifier|final
name|int
name|STAT_BROKER
init|=
name|Integer
operator|.
name|parseInt
argument_list|(
literal|"0001"
argument_list|,
literal|2
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|int
name|STAT_ALL
init|=
name|Integer
operator|.
name|parseInt
argument_list|(
literal|"1111"
argument_list|,
literal|2
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
index|[]
name|STAT_BROKER_MAP
init|=
operator|new
name|String
index|[]
block|{
literal|"TotalEnqueueCount"
block|,
literal|"TotalDequeueCount"
block|,
literal|"TotalConsumerCount"
block|,
literal|"TotalMessages"
block|,
literal|"TotalMessagesCached"
block|,
literal|"MemoryPercentageUsed"
block|,
literal|"MemoryLimit"
block|}
decl_stmt|;
comment|// Stat display flags
specifier|private
specifier|static
specifier|final
name|int
name|STAT_DISP_BROKER
init|=
name|Integer
operator|.
name|parseInt
argument_list|(
literal|"0001"
argument_list|,
literal|2
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|int
name|STAT_DISP_ALL
init|=
name|Integer
operator|.
name|parseInt
argument_list|(
literal|"1111"
argument_list|,
literal|2
argument_list|)
decl_stmt|;
comment|// Query object type to id mapping
specifier|private
specifier|static
specifier|final
name|Properties
name|QUERY_TYPE_ID_MAP
init|=
operator|new
name|Properties
argument_list|()
decl_stmt|;
static|static
block|{
name|QUERY_TYPE_ID_MAP
operator|.
name|setProperty
argument_list|(
literal|"Broker"
argument_list|,
literal|"BrokerName"
argument_list|)
expr_stmt|;
name|QUERY_TYPE_ID_MAP
operator|.
name|setProperty
argument_list|(
literal|"Connection"
argument_list|,
literal|"Connection"
argument_list|)
expr_stmt|;
name|QUERY_TYPE_ID_MAP
operator|.
name|setProperty
argument_list|(
literal|"Connector"
argument_list|,
literal|"ConnectorName"
argument_list|)
expr_stmt|;
name|QUERY_TYPE_ID_MAP
operator|.
name|setProperty
argument_list|(
literal|"NetworkConnector"
argument_list|,
literal|"BrokerName"
argument_list|)
expr_stmt|;
name|QUERY_TYPE_ID_MAP
operator|.
name|setProperty
argument_list|(
literal|"Queue"
argument_list|,
literal|"Destination"
argument_list|)
expr_stmt|;
name|QUERY_TYPE_ID_MAP
operator|.
name|setProperty
argument_list|(
literal|"Topic"
argument_list|,
literal|"Destination"
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
specifier|private
specifier|final
name|ArrayList
name|extensions
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|Map
name|queryObjects
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|List
name|queryViews
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
specifier|private
name|int
name|taskType
init|=
name|TASK_NONE
decl_stmt|;
specifier|private
name|boolean
name|stopAll
init|=
literal|false
decl_stmt|;
specifier|private
name|JMXServiceURL
name|jmxUrl
decl_stmt|;
specifier|private
name|URI
name|configURI
decl_stmt|;
specifier|private
name|File
name|activeMQHome
decl_stmt|;
specifier|private
name|ClassLoader
name|classLoader
decl_stmt|;
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
name|Main
name|app
init|=
operator|new
name|Main
argument_list|()
decl_stmt|;
comment|// Convert arguments to collection for easier management
name|ArrayList
name|tokens
init|=
operator|new
name|ArrayList
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|args
argument_list|)
argument_list|)
decl_stmt|;
comment|// First token should be task type (start|stop|list|-h|-?|--help|--version)
name|app
operator|.
name|setTaskType
argument_list|(
name|app
operator|.
name|parseTask
argument_list|(
name|tokens
argument_list|)
argument_list|)
expr_stmt|;
comment|// Succeeding tokens should be task specific options identified by "-" at the start
name|app
operator|.
name|parseOptions
argument_list|(
name|tokens
argument_list|)
expr_stmt|;
comment|// Succeeding tokens should be the task data
switch|switch
condition|(
name|app
operator|.
name|getTaskType
argument_list|()
condition|)
block|{
case|case
name|TASK_START_BROKER
case|:
try|try
block|{
name|app
operator|.
name|taskStartBrokers
argument_list|(
name|tokens
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Failed to start broker. Reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TASK_STOP_BROKER
case|:
try|try
block|{
name|app
operator|.
name|taskStopBrokers
argument_list|(
name|tokens
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Failed to stop broker(s). Reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TASK_LIST_BROKER
case|:
try|try
block|{
name|app
operator|.
name|taskListBrokers
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Failed to list broker(s). Reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TASK_STAT_BROKER
case|:
try|try
block|{
name|app
operator|.
name|taskStatBrokers
argument_list|(
name|tokens
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Failed to print broker statistics. Reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TASK_QUERY_BROKER
case|:
try|try
block|{
name|app
operator|.
name|taskQueryBrokers
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Failed to query broker. Reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TASK_PRINT_MAIN_HELP
case|:
name|app
operator|.
name|printHelp
argument_list|(
name|HELP_MAIN_APP
argument_list|)
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_START_HELP
case|:
name|app
operator|.
name|printHelp
argument_list|(
name|HELP_START_BROKER
argument_list|)
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_STOP_HELP
case|:
name|app
operator|.
name|printHelp
argument_list|(
name|HELP_STOP_BROKER
argument_list|)
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_LIST_HELP
case|:
name|app
operator|.
name|printHelp
argument_list|(
name|HELP_LIST_BROKER
argument_list|)
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_STAT_HELP
case|:
name|app
operator|.
name|printHelp
argument_list|(
name|HELP_STAT_BROKER
argument_list|)
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_QUERY_HELP
case|:
name|app
operator|.
name|printHelp
argument_list|(
name|HELP_QUERY_BROKER
argument_list|)
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_VER
case|:
name|app
operator|.
name|printVersion
argument_list|()
expr_stmt|;
break|break;
case|case
name|TASK_PRINT_ALL_HELP
case|:
name|app
operator|.
name|printAllHelp
argument_list|()
expr_stmt|;
break|break;
case|case
name|TASK_NONE
case|:
default|default:
break|break;
block|}
block|}
specifier|public
name|int
name|parseTask
parameter_list|(
name|List
name|tokens
parameter_list|)
block|{
if|if
condition|(
name|tokens
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// If no defined arguments, assume start task and default uri
return|return
name|TASK_START_BROKER
return|;
block|}
comment|// Process task token
name|String
name|taskToken
init|=
operator|(
name|String
operator|)
name|tokens
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"start"
argument_list|)
condition|)
block|{
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|TASK_START_BROKER
return|;
block|}
elseif|else
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"stop"
argument_list|)
condition|)
block|{
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|TASK_STOP_BROKER
return|;
block|}
elseif|else
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"list"
argument_list|)
condition|)
block|{
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|TASK_LIST_BROKER
return|;
block|}
elseif|else
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"stat"
argument_list|)
condition|)
block|{
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|TASK_STAT_BROKER
return|;
block|}
elseif|else
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"query"
argument_list|)
condition|)
block|{
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|TASK_QUERY_BROKER
return|;
block|}
elseif|else
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"-h"
argument_list|)
operator|||
name|taskToken
operator|.
name|equals
argument_list|(
literal|"-?"
argument_list|)
operator|||
name|taskToken
operator|.
name|equals
argument_list|(
literal|"--help"
argument_list|)
condition|)
block|{
comment|// No need to parse other tokens
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return
name|TASK_PRINT_MAIN_HELP
return|;
block|}
elseif|else
if|if
condition|(
name|taskToken
operator|.
name|equals
argument_list|(
literal|"--version"
argument_list|)
condition|)
block|{
comment|// No need to parse other tokens
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return
name|TASK_PRINT_VER
return|;
block|}
else|else
block|{
comment|// If not a valid task, assume start task and succeeding args are options
return|return
name|TASK_START_BROKER
return|;
block|}
block|}
specifier|public
name|void
name|parseOptions
parameter_list|(
name|List
name|tokens
parameter_list|)
block|{
name|String
name|token
decl_stmt|;
while|while
condition|(
operator|!
name|tokens
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|token
operator|=
operator|(
name|String
operator|)
name|tokens
operator|.
name|get
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// If token is an option
if|if
condition|(
name|token
operator|.
name|startsWith
argument_list|(
literal|"-"
argument_list|)
condition|)
block|{
comment|// Consider token to be processed
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// If token is a help option
if|if
condition|(
name|token
operator|.
name|equals
argument_list|(
literal|"-h"
argument_list|)
operator|||
name|token
operator|.
name|equals
argument_list|(
literal|"-?"
argument_list|)
operator|||
name|token
operator|.
name|equals
argument_list|(
literal|"--help"
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|this
operator|.
name|getTaskType
argument_list|()
condition|)
block|{
case|case
name|TASK_STOP_BROKER
case|:
name|this
operator|.
name|setTaskType
argument_list|(
name|TASK_PRINT_STOP_HELP
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
case|case
name|TASK_LIST_BROKER
case|:
name|this
operator|.
name|setTaskType
argument_list|(
name|TASK_PRINT_LIST_HELP
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
case|case
name|TASK_STAT_BROKER
case|:
name|this
operator|.
name|setTaskType
argument_list|(
name|TASK_PRINT_STAT_HELP
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
case|case
name|TASK_QUERY_BROKER
case|:
name|this
operator|.
name|setTaskType
argument_list|(
name|TASK_PRINT_QUERY_HELP
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
case|case
name|TASK_START_BROKER
case|:
default|default:
name|this
operator|.
name|setTaskType
argument_list|(
name|TASK_PRINT_START_HELP
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// If token is a version option
block|}
elseif|else
if|if
condition|(
name|token
operator|.
name|equals
argument_list|(
literal|"--version"
argument_list|)
condition|)
block|{
name|this
operator|.
name|setTaskType
argument_list|(
name|TASK_PRINT_VER
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
comment|// If token is an extension dir option
block|}
elseif|else
if|if
condition|(
name|token
operator|.
name|equals
argument_list|(
literal|"--extdir"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|canUseExtdir
argument_list|()
condition|)
block|{
name|printError
argument_list|(
literal|"Extension directory feature not available due to the system classpath being able to load: "
operator|+
name|BROKER_FACTORY_CLASS
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// If no extension directory is specified, or next token is another option
if|if
condition|(
name|tokens
operator|.
name|isEmpty
argument_list|()
operator|||
operator|(
operator|(
name|String
operator|)
name|tokens
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|)
operator|.
name|startsWith
argument_list|(
literal|"-"
argument_list|)
condition|)
block|{
name|printError
argument_list|(
literal|"Extension directory not specified."
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// Process extension dir token
name|File
name|extDir
init|=
operator|new
name|File
argument_list|(
operator|(
name|String
operator|)
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|extDir
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|printError
argument_list|(
literal|"Extension directory specified is not valid directory: "
operator|+
name|extDir
argument_list|)
expr_stmt|;
return|return;
block|}
name|this
operator|.
name|addExtensionDirectory
argument_list|(
name|extDir
argument_list|)
expr_stmt|;
block|}
comment|// If token is a system property define option
elseif|else
if|if
condition|(
name|token
operator|.
name|startsWith
argument_list|(
literal|"-D"
argument_list|)
condition|)
block|{
name|String
name|key
init|=
name|token
operator|.
name|substring
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|String
name|value
init|=
literal|""
decl_stmt|;
name|int
name|pos
init|=
name|key
operator|.
name|indexOf
argument_list|(
literal|"="
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
operator|>=
literal|0
condition|)
block|{
name|value
operator|=
name|key
operator|.
name|substring
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|key
operator|=
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|setProperty
argument_list|(
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
comment|// If token is a query define option
elseif|else
if|if
condition|(
name|token
operator|.
name|startsWith
argument_list|(
literal|"-Q"
argument_list|)
condition|)
block|{
name|String
name|key
init|=
name|token
operator|.
name|substring
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|String
name|value
init|=
literal|""
decl_stmt|;
name|int
name|pos
init|=
name|key
operator|.
name|indexOf
argument_list|(
literal|"="
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
operator|>=
literal|0
condition|)
block|{
name|value
operator|=
name|key
operator|.
name|substring
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|key
operator|=
name|key
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
name|queryObjects
operator|.
name|put
argument_list|(
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
comment|// If token is a view option
elseif|else
if|if
condition|(
name|token
operator|.
name|startsWith
argument_list|(
literal|"--view"
argument_list|)
condition|)
block|{
comment|// If no view specified, or next token is a new option
if|if
condition|(
name|tokens
operator|.
name|isEmpty
argument_list|()
operator|||
operator|(
operator|(
name|String
operator|)
name|tokens
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|)
operator|.
name|startsWith
argument_list|(
literal|"-"
argument_list|)
condition|)
block|{
name|printError
argument_list|(
literal|"Attributes to view not specified"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// Add the attributes to view
name|Enumeration
name|viewTokens
init|=
operator|new
name|StringTokenizer
argument_list|(
operator|(
name|String
operator|)
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|","
argument_list|,
literal|false
argument_list|)
decl_stmt|;
while|while
condition|(
name|viewTokens
operator|.
name|hasMoreElements
argument_list|()
condition|)
block|{
name|queryViews
operator|.
name|add
argument_list|(
name|viewTokens
operator|.
name|nextElement
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|// If token is a JMX URL option
elseif|else
if|if
condition|(
name|token
operator|.
name|startsWith
argument_list|(
literal|"--jmxurl"
argument_list|)
condition|)
block|{
comment|// If no jmx url specified, or next token is a new option
if|if
condition|(
name|tokens
operator|.
name|isEmpty
argument_list|()
operator|||
operator|(
operator|(
name|String
operator|)
name|tokens
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|)
operator|.
name|startsWith
argument_list|(
literal|"-"
argument_list|)
condition|)
block|{
name|printError
argument_list|(
literal|"JMX URL not specified."
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// If jmx url already specified
if|if
condition|(
name|getJmxUrl
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|printError
argument_list|(
literal|"Multiple JMX URL cannot be specified."
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
block|}
name|String
name|strJmxUrl
init|=
operator|(
name|String
operator|)
name|tokens
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
decl_stmt|;
try|try
block|{
name|this
operator|.
name|setJmxUrl
argument_list|(
operator|new
name|JMXServiceURL
argument_list|(
name|strJmxUrl
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|MalformedURLException
name|e
parameter_list|)
block|{
name|printError
argument_list|(
literal|"Invalid JMX URL format: "
operator|+
name|strJmxUrl
argument_list|)
expr_stmt|;
name|tokens
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// If token is stop all broker option
block|}
elseif|else
if|if
condition|(
name|token
operator|.
name|equals
argument_list|(
literal|"--all"
argument_list|)
condition|)
block|{
name|this
operator|.
name|setStopAllBrokers
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Ignoring unrecognized option: "
operator|+
name|token
argument_list|)
expr_stmt|;
block|}
comment|// Finish parsing options
block|}
else|else
block|{
return|return;
block|}
block|}
block|}
specifier|protected
name|void
name|taskStartBrokers
parameter_list|(
name|List
name|brokerURIs
parameter_list|)
throws|throws
name|Throwable
block|{
comment|// Flag an error if there are multiple configuration uris
if|if
condition|(
name|brokerURIs
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
block|{
name|printError
argument_list|(
literal|"Multiple configuration uris or broker names cannot be specified."
argument_list|)
expr_stmt|;
name|brokerURIs
operator|.
name|clear
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// Add the default directories.
if|if
condition|(
name|canUseExtdir
argument_list|()
condition|)
block|{
name|this
operator|.
name|addExtensionDirectory
argument_list|(
operator|new
name|File
argument_list|(
name|this
operator|.
name|getActiveMQHome
argument_list|()
argument_list|,
literal|"conf"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|addExtensionDirectory
argument_list|(
operator|new
name|File
argument_list|(
name|this
operator|.
name|getActiveMQHome
argument_list|()
argument_list|,
literal|"lib"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|addExtensionDirectory
argument_list|(
operator|new
name|File
argument_list|(
operator|new
name|File
argument_list|(
name|this
operator|.
name|getActiveMQHome
argument_list|()
argument_list|,
literal|"lib"
argument_list|)
argument_list|,
literal|"optional"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// If no config uri, use default setting
if|if
condition|(
name|brokerURIs
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|this
operator|.
name|setConfigUri
argument_list|(
name|this
operator|.
name|getDefaultUri
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|startBroker
argument_list|(
name|this
operator|.
name|getConfigUri
argument_list|()
argument_list|)
expr_stmt|;
comment|// Set configuration data, if available, which in this case would be the config URI
block|}
else|else
block|{
name|String
name|strConfigURI
decl_stmt|;
comment|//            while (!brokerURIs.isEmpty()) {
name|strConfigURI
operator|=
operator|(
name|String
operator|)
name|brokerURIs
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
try|try
block|{
name|this
operator|.
name|setConfigUri
argument_list|(
operator|new
name|URI
argument_list|(
name|strConfigURI
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
name|printError
argument_list|(
literal|"Invalid broker configuration URI: "
operator|+
name|strConfigURI
operator|+
literal|", reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
name|this
operator|.
name|startBroker
argument_list|(
name|this
operator|.
name|getConfigUri
argument_list|()
argument_list|)
expr_stmt|;
comment|//            }
block|}
block|}
specifier|protected
name|void
name|taskStopBrokers
parameter_list|(
name|List
name|brokerNames
parameter_list|)
throws|throws
name|Throwable
block|{
comment|// Check if there is a user-specified JMX URL
if|if
condition|(
name|this
operator|.
name|getJmxUrl
argument_list|()
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|setJmxUrl
argument_list|(
name|this
operator|.
name|getDefaultJmxUrl
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Stop all brokers
if|if
condition|(
name|this
operator|.
name|isStopAllBrokers
argument_list|()
condition|)
block|{
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
name|ObjectName
name|brokerObjName
init|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":Type=Broker,*"
argument_list|)
decl_stmt|;
name|this
operator|.
name|stopBroker
argument_list|(
name|server
argument_list|,
name|brokerObjName
argument_list|)
expr_stmt|;
name|brokerNames
operator|.
name|clear
argument_list|()
expr_stmt|;
comment|// Maybe no need to close, since context is already closed by broker
comment|//jmxConnector.close();
return|return;
block|}
comment|// Stop the default broker
if|if
condition|(
name|brokerNames
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Set
name|brokerList
init|=
name|this
operator|.
name|getBrokerList
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
comment|// If there is no broker to stop
if|if
condition|(
name|brokerList
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"There are no brokers to stop."
argument_list|)
expr_stmt|;
return|return;
comment|// There should only be one broker to stop
block|}
elseif|else
if|if
condition|(
name|brokerList
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"There are multiple brokers to stop. Please select the broker(s) to stop or use --all to stop all brokers."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|printHelp
argument_list|(
name|HELP_STOP_BROKER
argument_list|)
expr_stmt|;
name|printBrokerList
argument_list|(
name|brokerList
argument_list|)
expr_stmt|;
return|return;
comment|// Stop the only running broker
block|}
else|else
block|{
name|Iterator
name|brokerIter
init|=
name|brokerList
operator|.
name|iterator
argument_list|()
decl_stmt|;
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
name|this
operator|.
name|stopBroker
argument_list|(
name|server
argument_list|,
operator|(
operator|(
name|ObjectInstance
operator|)
name|brokerIter
operator|.
name|next
argument_list|()
operator|)
operator|.
name|getObjectName
argument_list|()
argument_list|)
expr_stmt|;
comment|// Maybe no need to close, since context is already closed by broker
comment|//jmxConnector.close();
return|return;
block|}
block|}
comment|// Stop each specified broker
name|String
name|brokerName
decl_stmt|;
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
while|while
condition|(
operator|!
name|brokerNames
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|brokerName
operator|=
operator|(
name|String
operator|)
name|brokerNames
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|stopBroker
argument_list|(
name|server
argument_list|,
name|brokerName
argument_list|)
expr_stmt|;
block|}
comment|// Maybe be no need to close, since context is already closed by broker
comment|//jmxConnector.close();
block|}
specifier|protected
name|void
name|taskListBrokers
parameter_list|()
throws|throws
name|Throwable
block|{
comment|// Check if there is a user-specified JMX URL
if|if
condition|(
name|this
operator|.
name|getJmxUrl
argument_list|()
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|setJmxUrl
argument_list|(
name|this
operator|.
name|getDefaultJmxUrl
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|printBrokerList
argument_list|(
name|this
operator|.
name|getBrokerList
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|void
name|taskStatBrokers
parameter_list|(
name|List
name|brokerNames
parameter_list|)
throws|throws
name|Throwable
block|{
comment|// Check if there is a user-specified JMX URL
if|if
condition|(
name|this
operator|.
name|getJmxUrl
argument_list|()
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|setJmxUrl
argument_list|(
name|this
operator|.
name|getDefaultJmxUrl
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Print the statistics for the default broker
if|if
condition|(
name|brokerNames
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Set
name|brokerList
init|=
name|this
operator|.
name|getBrokerList
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
comment|// If there is no broker to stop
if|if
condition|(
name|brokerList
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"There are no brokers running."
argument_list|)
expr_stmt|;
return|return;
comment|// There should only be one broker to stop
block|}
elseif|else
if|if
condition|(
name|brokerList
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"There are multiple brokers running. Please select the broker to display the statistics for."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|printHelp
argument_list|(
name|HELP_STAT_BROKER
argument_list|)
expr_stmt|;
name|printBrokerList
argument_list|(
name|brokerList
argument_list|)
expr_stmt|;
return|return;
comment|// Print the statistics for the only running broker
block|}
else|else
block|{
name|Iterator
name|brokerIter
init|=
name|brokerList
operator|.
name|iterator
argument_list|()
decl_stmt|;
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
name|ObjectName
name|brokerObjName
init|=
operator|(
operator|(
name|ObjectInstance
operator|)
name|brokerIter
operator|.
name|next
argument_list|()
operator|)
operator|.
name|getObjectName
argument_list|()
decl_stmt|;
name|this
operator|.
name|printBrokerStat
argument_list|(
name|brokerObjName
operator|.
name|getKeyProperty
argument_list|(
name|DEFAULT_KEY_BROKER_NAME
argument_list|)
argument_list|,
name|this
operator|.
name|getBrokerStat
argument_list|(
name|server
argument_list|,
name|brokerObjName
argument_list|)
argument_list|)
expr_stmt|;
name|jmxConnector
operator|.
name|close
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
comment|// Print the statistics for each specified broker
name|String
name|brokerName
decl_stmt|;
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
while|while
condition|(
operator|!
name|brokerNames
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|brokerName
operator|=
operator|(
name|String
operator|)
name|brokerNames
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"-----------------------------------------------------"
argument_list|)
expr_stmt|;
name|this
operator|.
name|printBrokerStat
argument_list|(
name|brokerName
argument_list|,
name|this
operator|.
name|getBrokerStat
argument_list|(
name|server
argument_list|,
name|brokerName
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
block|}
name|jmxConnector
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
specifier|protected
name|void
name|taskQueryBrokers
parameter_list|()
throws|throws
name|Throwable
block|{
comment|// Check if there is a user-specified JMX URL
if|if
condition|(
name|this
operator|.
name|getJmxUrl
argument_list|()
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|setJmxUrl
argument_list|(
name|this
operator|.
name|getDefaultJmxUrl
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|this
operator|.
name|getJmxUrl
argument_list|()
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
name|Set
name|mbeans
decl_stmt|;
comment|// If there is no query defined get all mbeans
if|if
condition|(
name|this
operator|.
name|getQueryObjects
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ObjectName
name|queryName
init|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":*"
argument_list|)
decl_stmt|;
name|mbeans
operator|=
name|server
operator|.
name|queryMBeans
argument_list|(
name|queryName
argument_list|,
literal|null
argument_list|)
expr_stmt|;
comment|// Construct the object name based on the query
block|}
else|else
block|{
name|mbeans
operator|=
operator|new
name|HashSet
argument_list|()
expr_stmt|;
name|Set
name|queryKeys
init|=
name|queryObjects
operator|.
name|keySet
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
name|i
init|=
name|queryKeys
operator|.
name|iterator
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|String
name|objType
init|=
operator|(
name|String
operator|)
name|i
operator|.
name|next
argument_list|()
decl_stmt|;
name|String
name|objName
init|=
operator|(
name|String
operator|)
name|queryObjects
operator|.
name|get
argument_list|(
name|objType
argument_list|)
decl_stmt|;
comment|// If select all type
name|ObjectName
name|queryName
decl_stmt|;
if|if
condition|(
name|objName
operator|.
name|equals
argument_list|(
literal|"*"
argument_list|)
condition|)
block|{
name|queryName
operator|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":Type="
operator|+
name|objType
operator|+
literal|",*"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|queryName
operator|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":Type="
operator|+
name|objType
operator|+
literal|","
operator|+
name|QUERY_TYPE_ID_MAP
operator|.
name|getProperty
argument_list|(
name|objType
argument_list|)
operator|+
literal|"="
operator|+
name|objName
operator|+
literal|",*"
argument_list|)
expr_stmt|;
block|}
name|mbeans
operator|.
name|addAll
argument_list|(
name|server
operator|.
name|queryMBeans
argument_list|(
name|queryName
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|Iterator
name|i
init|=
name|mbeans
operator|.
name|iterator
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|printMBeanAttr
argument_list|(
name|server
argument_list|,
operator|(
name|ObjectInstance
operator|)
name|i
operator|.
name|next
argument_list|()
argument_list|,
name|this
operator|.
name|getQueryViews
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|jmxConnector
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
specifier|public
name|void
name|addExtensionDirectory
parameter_list|(
name|File
name|directory
parameter_list|)
block|{
name|extensions
operator|.
name|add
argument_list|(
name|directory
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|startBroker
parameter_list|(
name|URI
name|configURI
parameter_list|)
throws|throws
name|Throwable
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Loading Message Broker from: "
operator|+
name|configURI
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"ACTIVEMQ_HOME: "
operator|+
name|getActiveMQHome
argument_list|()
argument_list|)
expr_stmt|;
name|ClassLoader
name|cl
init|=
name|getClassLoader
argument_list|()
decl_stmt|;
comment|// Use reflection to start the broker up.
name|Object
name|broker
decl_stmt|;
try|try
block|{
name|Class
name|brokerFactory
init|=
name|cl
operator|.
name|loadClass
argument_list|(
name|BROKER_FACTORY_CLASS
argument_list|)
decl_stmt|;
name|Method
name|createBroker
init|=
name|brokerFactory
operator|.
name|getMethod
argument_list|(
literal|"createBroker"
argument_list|,
operator|new
name|Class
index|[]
block|{
name|URI
operator|.
name|class
block|}
argument_list|)
decl_stmt|;
name|broker
operator|=
name|createBroker
operator|.
name|invoke
argument_list|(
literal|null
argument_list|,
operator|new
name|Object
index|[]
block|{
name|configURI
block|}
argument_list|)
expr_stmt|;
name|Method
name|start
init|=
name|broker
operator|.
name|getClass
argument_list|()
operator|.
name|getMethod
argument_list|(
literal|"start"
argument_list|,
operator|new
name|Class
index|[]
block|{}
argument_list|)
decl_stmt|;
name|start
operator|.
name|invoke
argument_list|(
name|broker
argument_list|,
operator|new
name|Object
index|[]
block|{}
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InvocationTargetException
name|e
parameter_list|)
block|{
throw|throw
name|e
operator|.
name|getCause
argument_list|()
throw|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|e
throw|;
block|}
block|}
specifier|public
name|void
name|stopBroker
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|String
name|brokerName
parameter_list|)
block|{
name|ObjectName
name|brokerObjName
init|=
literal|null
decl_stmt|;
try|try
block|{
name|brokerObjName
operator|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":Type=Broker,"
operator|+
name|DEFAULT_KEY_BROKER_NAME
operator|+
literal|"="
operator|+
name|brokerName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Invalid broker name: "
operator|+
name|brokerName
argument_list|)
expr_stmt|;
return|return;
block|}
name|stopBroker
argument_list|(
name|server
argument_list|,
name|brokerObjName
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|stopBroker
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|ObjectName
name|brokerObjName
parameter_list|)
block|{
name|String
name|brokerName
init|=
name|brokerObjName
operator|.
name|getKeyProperty
argument_list|(
name|DEFAULT_KEY_BROKER_NAME
argument_list|)
decl_stmt|;
try|try
block|{
name|server
operator|.
name|invoke
argument_list|(
name|brokerObjName
argument_list|,
name|DEFAULT_METHOD_BROKER_STOP
argument_list|,
name|DEFAULT_PARAM_BROKER_STOP
argument_list|,
name|DEFAULT_SIGN_BROKER_STOP
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Succesfully stopped broker: "
operator|+
name|brokerName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
comment|// TODO: Check the exceptions thrown
comment|// System.out.println("Failed to stop broker: [ " + brokerName + " ]. Reason: " + e.getMessage());
return|return;
block|}
block|}
comment|/**      * The extension directory feature will not work if the broker factory is already in the classpath      * since we have to load him from a child ClassLoader we build for it to work correctly.      *      * @return      */
specifier|public
name|boolean
name|canUseExtdir
parameter_list|()
block|{
try|try
block|{
name|Main
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
operator|.
name|loadClass
argument_list|(
name|BROKER_FACTORY_CLASS
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
catch|catch
parameter_list|(
name|ClassNotFoundException
name|e
parameter_list|)
block|{
return|return
literal|true
return|;
block|}
block|}
specifier|public
name|void
name|printHelp
parameter_list|(
name|int
name|helpIndex
parameter_list|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|taskHelp
index|[
name|helpIndex
index|]
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|taskHelp
index|[
name|helpIndex
index|]
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|printAllHelp
parameter_list|()
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|taskHelp
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|printHelp
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|printError
parameter_list|(
name|String
name|message
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|setTaskType
argument_list|(
name|TASK_NONE
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|printVersion
parameter_list|()
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
try|try
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"ActiveMQ "
operator|+
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"ActiveMQ<unknown version>"
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"For help or more information please see: http://www.logicblaze.com"
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
block|}
specifier|public
name|void
name|printBrokerList
parameter_list|(
name|Set
name|brokerList
parameter_list|)
block|{
name|Object
index|[]
name|brokerArray
init|=
name|brokerList
operator|.
name|toArray
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"List of available brokers:"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|brokerArray
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|brokerName
init|=
operator|(
operator|(
name|ObjectInstance
operator|)
name|brokerArray
index|[
name|i
index|]
operator|)
operator|.
name|getObjectName
argument_list|()
operator|.
name|getKeyProperty
argument_list|(
literal|"BrokerName"
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    "
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|+
literal|".) "
operator|+
name|brokerName
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|printMBeanAttr
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|ObjectInstance
name|mbean
parameter_list|,
name|List
name|attrView
parameter_list|)
block|{
name|ObjectName
name|mbeanObjName
init|=
name|mbean
operator|.
name|getObjectName
argument_list|()
decl_stmt|;
name|String
name|mbeanType
init|=
name|mbeanObjName
operator|.
name|getKeyProperty
argument_list|(
literal|"Type"
argument_list|)
decl_stmt|;
name|String
name|mbeanName
init|=
name|mbeanObjName
operator|.
name|getKeyProperty
argument_list|(
name|QUERY_TYPE_ID_MAP
operator|.
name|getProperty
argument_list|(
name|mbeanType
argument_list|)
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"MBean Type: "
operator|+
name|mbeanType
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"MBean Name: "
operator|+
name|mbeanName
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"MBean Attributes:"
argument_list|)
expr_stmt|;
try|try
block|{
name|MBeanAttributeInfo
index|[]
name|attrs
init|=
name|server
operator|.
name|getMBeanInfo
argument_list|(
name|mbeanObjName
argument_list|)
operator|.
name|getAttributes
argument_list|()
decl_stmt|;
comment|// If there mbean has no attribute, print a no attribute message
if|if
condition|(
name|attrs
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    MBean has no attributes."
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// If there is no view specified, print all attributes
if|if
condition|(
name|attrView
operator|==
literal|null
operator|||
name|attrView
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|attrs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|Object
name|attrVal
init|=
name|server
operator|.
name|getAttribute
argument_list|(
name|mbeanObjName
argument_list|,
name|attrs
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    "
operator|+
name|attrs
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
operator|+
literal|" = "
operator|+
name|attrVal
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// Print attributes specified by view
name|boolean
name|matchedAttr
init|=
literal|false
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|attrs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|attrView
operator|.
name|contains
argument_list|(
name|attrs
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
name|matchedAttr
operator|=
literal|true
expr_stmt|;
name|Object
name|attrVal
init|=
name|server
operator|.
name|getAttribute
argument_list|(
name|mbeanObjName
argument_list|,
name|attrs
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    "
operator|+
name|attrs
index|[
name|i
index|]
operator|.
name|getName
argument_list|()
operator|+
literal|" = "
operator|+
name|attrVal
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|// If the mbean's attributes did not match any of the view, display a message
if|if
condition|(
operator|!
name|matchedAttr
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    View did not match any of the mbean's attributes."
argument_list|)
expr_stmt|;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Failed to print mbean attributes. Reason: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|printBrokerStat
parameter_list|(
name|String
name|brokerName
parameter_list|,
name|Map
name|brokerStat
parameter_list|)
block|{
name|printBrokerStat
argument_list|(
name|brokerName
argument_list|,
name|brokerStat
argument_list|,
name|STAT_DISP_ALL
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|printBrokerStat
parameter_list|(
name|String
name|brokerName
parameter_list|,
name|Map
name|brokerStat
parameter_list|,
name|int
name|dispFlags
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Displaying usage statistics for broker: "
operator|+
name|brokerName
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dispFlags
operator|&
name|STAT_DISP_BROKER
operator|)
operator|!=
literal|0
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Enqueue Count: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Dequeue Count: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Consumer Count: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Message Count: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Cached Message Count: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Memory Percent Used: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"    Broker Memory Limit: "
operator|+
name|brokerStat
operator|.
name|get
argument_list|(
name|STAT_BROKER_MAP
index|[
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
block|}
block|}
comment|// Property setters and getters
specifier|public
name|void
name|setTaskType
parameter_list|(
name|int
name|taskType
parameter_list|)
block|{
name|this
operator|.
name|taskType
operator|=
name|taskType
expr_stmt|;
block|}
specifier|public
name|int
name|getTaskType
parameter_list|()
block|{
return|return
name|taskType
return|;
block|}
specifier|public
name|void
name|setJmxUrl
parameter_list|(
name|JMXServiceURL
name|url
parameter_list|)
block|{
name|jmxUrl
operator|=
name|url
expr_stmt|;
block|}
specifier|public
name|JMXServiceURL
name|getJmxUrl
parameter_list|()
block|{
return|return
name|jmxUrl
return|;
block|}
specifier|public
name|JMXServiceURL
name|getDefaultJmxUrl
parameter_list|()
throws|throws
name|MalformedURLException
block|{
return|return
operator|new
name|JMXServiceURL
argument_list|(
name|DEFAULT_JMX_URL
argument_list|)
return|;
block|}
specifier|public
name|String
name|getVersion
parameter_list|()
throws|throws
name|Throwable
block|{
comment|// TODO: Why is version returned invalid?
name|ClassLoader
name|cl
init|=
name|getClassLoader
argument_list|()
decl_stmt|;
comment|// Use reflection to get the version
try|try
block|{
name|Class
name|activeMQConnectionMetaData
init|=
name|cl
operator|.
name|loadClass
argument_list|(
literal|"org.apache.activemq.ActiveMQConnectionMetaData"
argument_list|)
decl_stmt|;
name|Field
name|field
init|=
name|activeMQConnectionMetaData
operator|.
name|getField
argument_list|(
literal|"PROVIDER_VERSION"
argument_list|)
decl_stmt|;
return|return
operator|(
name|String
operator|)
name|field
operator|.
name|get
argument_list|(
literal|null
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
name|e
throw|;
block|}
block|}
specifier|public
name|URI
name|getDefaultUri
parameter_list|()
throws|throws
name|URISyntaxException
block|{
return|return
operator|new
name|URI
argument_list|(
name|DEFAULT_CONFIG_URI
argument_list|)
return|;
block|}
specifier|public
name|void
name|setConfigUri
parameter_list|(
name|URI
name|uri
parameter_list|)
block|{
name|configURI
operator|=
name|uri
expr_stmt|;
block|}
specifier|public
name|URI
name|getConfigUri
parameter_list|()
block|{
return|return
name|configURI
return|;
block|}
specifier|public
name|void
name|setStopAllBrokers
parameter_list|(
name|boolean
name|stopAll
parameter_list|)
block|{
name|this
operator|.
name|stopAll
operator|=
name|stopAll
expr_stmt|;
block|}
specifier|public
name|boolean
name|isStopAllBrokers
parameter_list|()
block|{
return|return
name|stopAll
return|;
block|}
specifier|public
name|Map
name|getQueryObjects
parameter_list|()
block|{
return|return
name|queryObjects
return|;
block|}
specifier|public
name|List
name|getQueryViews
parameter_list|()
block|{
return|return
name|queryViews
return|;
block|}
specifier|public
name|ClassLoader
name|getClassLoader
parameter_list|()
throws|throws
name|MalformedURLException
block|{
if|if
condition|(
name|classLoader
operator|==
literal|null
condition|)
block|{
comment|//
comment|// Setup the ClassLoader
comment|//
name|classLoader
operator|=
name|Main
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|extensions
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|ArrayList
name|urls
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
name|iter
init|=
name|extensions
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|File
name|dir
init|=
operator|(
name|File
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|urls
operator|.
name|add
argument_list|(
name|dir
operator|.
name|toURL
argument_list|()
argument_list|)
expr_stmt|;
name|File
index|[]
name|files
init|=
name|dir
operator|.
name|listFiles
argument_list|()
decl_stmt|;
if|if
condition|(
name|files
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|files
operator|.
name|length
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|files
index|[
name|j
index|]
operator|.
name|getName
argument_list|()
operator|.
name|endsWith
argument_list|(
literal|".zip"
argument_list|)
operator|||
name|files
index|[
name|j
index|]
operator|.
name|getName
argument_list|()
operator|.
name|endsWith
argument_list|(
literal|".jar"
argument_list|)
condition|)
block|{
name|urls
operator|.
name|add
argument_list|(
name|files
index|[
name|j
index|]
operator|.
name|toURL
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|URL
name|u
index|[]
init|=
operator|new
name|URL
index|[
name|urls
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
name|urls
operator|.
name|toArray
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|classLoader
operator|=
operator|new
name|URLClassLoader
argument_list|(
name|u
argument_list|,
name|classLoader
argument_list|)
expr_stmt|;
block|}
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|setContextClassLoader
argument_list|(
name|classLoader
argument_list|)
expr_stmt|;
block|}
return|return
name|classLoader
return|;
block|}
specifier|public
name|void
name|setActiveMQHome
parameter_list|(
name|File
name|activeMQHome
parameter_list|)
block|{
name|this
operator|.
name|activeMQHome
operator|=
name|activeMQHome
expr_stmt|;
block|}
specifier|public
name|File
name|getActiveMQHome
parameter_list|()
block|{
if|if
condition|(
name|activeMQHome
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"activemq.home"
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|activeMQHome
operator|=
operator|new
name|File
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"activemq.home"
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|activeMQHome
operator|==
literal|null
condition|)
block|{
comment|// guess from the location of the jar
name|URL
name|url
init|=
name|Main
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
operator|.
name|getResource
argument_list|(
literal|"org/apache/activemq/broker/Main.class"
argument_list|)
decl_stmt|;
if|if
condition|(
name|url
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|JarURLConnection
name|jarConnection
init|=
operator|(
name|JarURLConnection
operator|)
name|url
operator|.
name|openConnection
argument_list|()
decl_stmt|;
name|url
operator|=
name|jarConnection
operator|.
name|getJarFileURL
argument_list|()
expr_stmt|;
name|URI
name|baseURI
init|=
operator|new
name|URI
argument_list|(
name|url
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|resolve
argument_list|(
literal|".."
argument_list|)
decl_stmt|;
name|activeMQHome
operator|=
operator|new
name|File
argument_list|(
name|baseURI
argument_list|)
operator|.
name|getCanonicalFile
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ignored
parameter_list|)
block|{                     }
block|}
block|}
if|if
condition|(
name|activeMQHome
operator|==
literal|null
condition|)
block|{
name|activeMQHome
operator|=
operator|new
name|File
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|activeMQHome
return|;
block|}
specifier|public
name|Set
name|getBrokerList
parameter_list|(
name|JMXServiceURL
name|jmxUrl
parameter_list|)
throws|throws
name|Throwable
block|{
name|JMXConnector
name|jmxConnector
init|=
name|JMXConnectorFactory
operator|.
name|connect
argument_list|(
name|jmxUrl
argument_list|)
decl_stmt|;
name|MBeanServerConnection
name|server
init|=
name|jmxConnector
operator|.
name|getMBeanServerConnection
argument_list|()
decl_stmt|;
name|ObjectName
name|brokerObjName
init|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":Type=Broker,*"
argument_list|)
decl_stmt|;
name|Set
name|brokerMBeans
init|=
name|server
operator|.
name|queryMBeans
argument_list|(
name|brokerObjName
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|jmxConnector
operator|.
name|close
argument_list|()
expr_stmt|;
return|return
name|brokerMBeans
return|;
block|}
specifier|public
name|Map
name|getBrokerStat
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|String
name|brokerName
parameter_list|)
throws|throws
name|Throwable
block|{
return|return
name|getBrokerStat
argument_list|(
name|server
argument_list|,
name|brokerName
argument_list|,
name|STAT_ALL
argument_list|)
return|;
block|}
specifier|public
name|Map
name|getBrokerStat
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|ObjectName
name|brokerObjName
parameter_list|)
block|{
return|return
name|getBrokerStat
argument_list|(
name|server
argument_list|,
name|brokerObjName
argument_list|,
name|STAT_ALL
argument_list|)
return|;
block|}
specifier|public
name|Map
name|getBrokerStat
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|String
name|brokerName
parameter_list|,
name|int
name|statFlags
parameter_list|)
throws|throws
name|Throwable
block|{
name|ObjectName
name|brokerObjName
init|=
literal|null
decl_stmt|;
try|try
block|{
name|brokerObjName
operator|=
operator|new
name|ObjectName
argument_list|(
name|DEFAULT_JMX_DOMAIN
operator|+
literal|":Type=Broker,"
operator|+
name|DEFAULT_KEY_BROKER_NAME
operator|+
literal|"="
operator|+
name|brokerName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Invalid broker name: "
operator|+
name|brokerName
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
return|return
name|getBrokerStat
argument_list|(
name|server
argument_list|,
name|brokerObjName
argument_list|,
name|statFlags
argument_list|)
return|;
block|}
specifier|public
name|Map
name|getBrokerStat
parameter_list|(
name|MBeanServerConnection
name|server
parameter_list|,
name|ObjectName
name|brokerObjName
parameter_list|,
name|int
name|statFlags
parameter_list|)
block|{
name|Map
name|brokerStat
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
operator|(
name|statFlags
operator|&
name|STAT_BROKER
operator|)
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|STAT_BROKER_MAP
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|brokerStat
operator|.
name|put
argument_list|(
name|STAT_BROKER_MAP
index|[
name|i
index|]
argument_list|,
comment|// key name of statistic
name|server
operator|.
name|getAttribute
argument_list|(
name|brokerObjName
argument_list|,
operator|(
name|String
operator|)
name|STAT_BROKER_MAP
index|[
name|i
index|]
argument_list|)
comment|// attribute to get)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
return|return
literal|null
return|;
block|}
return|return
name|brokerStat
return|;
block|}
comment|// This section contains an array of the help notes of the different tasks
specifier|private
specifier|static
specifier|final
name|String
index|[]
index|[]
name|taskHelp
init|=
block|{
comment|// Main task help
block|{
literal|"Usage: Main [task] [task-options] [task data]"
block|,
literal|""
block|,
literal|"Tasks (default task is start):"
block|,
literal|"    start        - Creates and starts a broker using a configuration file, or a broker URI."
block|,
literal|"    stop         - Stops a running broker specified by the broker name."
block|,
literal|"    list         - Lists all available broker in the specified JMX context."
block|,
literal|"    --version    - Display the version information."
block|,
literal|"    -h,-?,--help - Display this help information. To display task specific help, use Main [task] -h,-?,--help"
block|,
literal|""
block|,
literal|"Task Options:"
block|,
literal|"    - Properties specific to each task."
block|,
literal|""
block|,
literal|"Task Data:"
block|,
literal|"    - Information needed by each specific task."
block|,
literal|""
block|}
block|,
comment|// Start broker task help
block|{
literal|"Task Usage: Main start [start-options] [uri]"
block|,
literal|""
block|,
literal|"Start Options:"
block|,
literal|"    --extdir<dir>        Add the jar files in the directory to the classpath."
block|,
literal|"    -D<name>=<value>      Define a system property."
block|,
literal|"    --version             Display the version information."
block|,
literal|"    -h,-?,--help          Display the start broker help information."
block|,
literal|""
block|,
literal|"URI:"
block|,
literal|""
block|,
literal|"    XBean based broker configuration:"
block|,
literal|""
block|,
literal|"        Example: Main xbean:file:activemq.xml"
block|,
literal|"            Loads the xbean configuration file from the current working directory"
block|,
literal|"        Example: Main xbean:activemq.xml"
block|,
literal|"            Loads the xbean configuration file from the classpath"
block|,
literal|""
block|,
literal|"    URI Parameter based broker configuration:"
block|,
literal|""
block|,
literal|"        Example: Main broker:(tcp://localhost:61616, tcp://localhost:5000)?useJmx=true"
block|,
literal|"            Configures the broker with 2 transport connectors and jmx enabled"
block|,
literal|"        Example: Main broker:(tcp://localhost:61616, network:tcp://localhost:5000)?persistent=false"
block|,
literal|"            Configures the broker with 1 transport connector, and 1 network connector and persistence disabled"
block|,
literal|""
block|}
block|,
comment|// Stop broker task help
block|{
literal|"Task Usage: Main stop [stop-options] [broker-name1] [broker-name2] ..."
block|,
literal|""
block|,
literal|"Stop Options:"
block|,
literal|"    --jmxurl<url>      Set the JMX URL to connect to."
block|,
literal|"    --all               Stop all brokers."
block|,
literal|"    --version           Display the version information."
block|,
literal|"    -h,-?,--help        Display the stop broker help information."
block|,
literal|""
block|,
literal|"Broker Names:"
block|,
literal|"    Name of the brokers that will be stopped."
block|,
literal|"    If omitted, it is assumed that there is only one broker running, and it will be stopped."
block|,
literal|"    Use -all to stop all running brokers."
block|,
literal|""
block|}
block|,
comment|// List brokers task help
block|{
literal|"Task Usage: Main list [list-options]"
block|,
literal|""
block|,
literal|"List Options:"
block|,
literal|"    --jmxurl<url>      Set the JMX URL to connect to."
block|,
literal|"    --version           Display the version information."
block|,
literal|"    -h,-?,--help        Display the stop broker help information."
block|,
literal|""
block|,         }
block|,
comment|// Stat brokers task help
block|{
literal|"Task Usage: Main stat [stat-options] [broker-name1] [broker-name2] ..."
block|,
literal|""
block|,
literal|"Stat Options:"
block|,
literal|"    --jmxurl<url>      Set the JMX URL to connect to."
block|,
literal|"    --version           Display the version information."
block|,
literal|"    -h,-?,--help        Display the stat broker help information."
block|,
literal|""
block|,         }
block|,
comment|// Query brokers task help
block|{
literal|"Task Usage: Main query [query-options]"
block|,
literal|""
block|,
literal|"Query Options:"
block|,
literal|"    -Q<type>=<name>               Filter the specific object type using the defined object identifier."
block|,
literal|"    --view<attr1>,<attr2>,...    Select the specific attribute of the object to view. By default all attributes will be displayed."
block|,
literal|"    --jmxurl<url>                Set the JMX URL to connect to."
block|,
literal|"    --version                     Display the version information."
block|,
literal|"    -h,-?,--help                  Display the query broker help information."
block|,
literal|""
block|,
literal|"Examples:"
block|,
literal|"    Main query"
block|,
literal|"        - Print all the attributes of all registered objects (queues, topics, connections, etc)."
block|,
literal|""
block|,
literal|"    Main query -QQueue=TEST.FOO"
block|,
literal|"        - Print all the attributes of the queue with destination name TEST.FOO."
block|,
literal|""
block|,
literal|"    Main query -QTopic=*"
block|,
literal|"        - Print all the attributes of all registered topics."
block|,
literal|""
block|,
literal|"    Main query --view EnqueueCount,DequeueCount"
block|,
literal|"        - Print the attributes EnqueueCount and DequeueCount of all registered objects."
block|,
literal|""
block|,
literal|"    Main -QTopic=* --view EnqueueCount,DequeueCount"
block|,
literal|"        - Print the attributes EnqueueCount and DequeueCount of all registered topics."
block|,
literal|""
block|,
literal|"    Main -QTopic=* -QQueue=* --view EnqueueCount,DequeueCount"
block|,
literal|"        - Print the attributes EnqueueCount and DequeueCount of all registered topics and queues."
block|,
literal|""
block|}
block|}
decl_stmt|;
block|}
end_class

end_unit

