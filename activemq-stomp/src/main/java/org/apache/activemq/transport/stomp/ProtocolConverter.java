begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|transport
operator|.
name|stomp
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStreamWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicBoolean
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|jms
operator|.
name|JMSException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|ActiveMQPrefetchPolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|advisory
operator|.
name|AdvisorySupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|BrokerContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|BrokerContextAware
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ActiveMQDestination
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ActiveMQMessage
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ActiveMQTempQueue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ActiveMQTempTopic
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|Command
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|CommandTypes
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionError
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConsumerControl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConsumerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConsumerInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|DestinationInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ExceptionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|LocalTransactionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessageAck
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessageDispatch
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessageId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ProducerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ProducerInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|RemoveSubscriptionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|Response
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|SessionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|SessionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ShutdownInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|TransactionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|TransactionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|ByteArrayOutputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|FactoryFinder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|IOExceptionSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|IdGenerator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|IntrospectionSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|LongSequenceGenerator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * @author<a href="http://hiramchirino.com">chirino</a>  */
end_comment

begin_class
specifier|public
class|class
name|ProtocolConverter
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|ProtocolConverter
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|IdGenerator
name|CONNECTION_ID_GENERATOR
init|=
operator|new
name|IdGenerator
argument_list|()
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|BROKER_VERSION
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|StompFrame
name|ping
init|=
operator|new
name|StompFrame
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|KEEPALIVE
argument_list|)
decl_stmt|;
static|static
block|{
name|String
name|version
init|=
literal|"5.6.0"
decl_stmt|;
try|try
init|(
name|InputStream
name|in
init|=
name|ProtocolConverter
operator|.
name|class
operator|.
name|getResourceAsStream
argument_list|(
literal|"/org/apache/activemq/version.txt"
argument_list|)
init|)
block|{
if|if
condition|(
name|in
operator|!=
literal|null
condition|)
block|{
try|try
init|(
name|InputStreamReader
name|isr
init|=
operator|new
name|InputStreamReader
argument_list|(
name|in
argument_list|)
init|;                     BufferedReader reader = new BufferedReader(isr)
block|)
block|{
name|version
operator|=
name|reader
operator|.
name|readLine
argument_list|()
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{         }
name|BROKER_VERSION
operator|=
name|version
expr_stmt|;
block|}
end_class

begin_decl_stmt
specifier|private
specifier|final
name|ConnectionId
name|connectionId
init|=
operator|new
name|ConnectionId
argument_list|(
name|CONNECTION_ID_GENERATOR
operator|.
name|generateId
argument_list|()
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|SessionId
name|sessionId
init|=
operator|new
name|SessionId
argument_list|(
name|connectionId
argument_list|,
operator|-
literal|1
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ProducerId
name|producerId
init|=
operator|new
name|ProducerId
argument_list|(
name|sessionId
argument_list|,
literal|1
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|LongSequenceGenerator
name|consumerIdGenerator
init|=
operator|new
name|LongSequenceGenerator
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|LongSequenceGenerator
name|messageIdGenerator
init|=
operator|new
name|LongSequenceGenerator
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|LongSequenceGenerator
name|transactionIdGenerator
init|=
operator|new
name|LongSequenceGenerator
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|LongSequenceGenerator
name|tempDestinationGenerator
init|=
operator|new
name|LongSequenceGenerator
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|Integer
argument_list|,
name|ResponseHandler
argument_list|>
name|resposeHandlers
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|Integer
argument_list|,
name|ResponseHandler
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|ConsumerId
argument_list|,
name|StompSubscription
argument_list|>
name|subscriptionsByConsumerId
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|ConsumerId
argument_list|,
name|StompSubscription
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|String
argument_list|,
name|StompSubscription
argument_list|>
name|subscriptions
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|StompSubscription
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|String
argument_list|,
name|ActiveMQDestination
argument_list|>
name|tempDestinations
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|ActiveMQDestination
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|tempDestinationAmqToStompMap
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|LocalTransactionId
argument_list|>
name|transactions
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|LocalTransactionId
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|StompTransport
name|stompTransport
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|String
argument_list|,
name|AckEntry
argument_list|>
name|pedingAcks
init|=
operator|new
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|AckEntry
argument_list|>
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|IdGenerator
name|ACK_ID_GENERATOR
init|=
operator|new
name|IdGenerator
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|Object
name|commnadIdMutex
init|=
operator|new
name|Object
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
name|int
name|lastCommandId
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|AtomicBoolean
name|connected
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|FrameTranslator
name|frameTranslator
init|=
operator|new
name|LegacyFrameTranslator
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|FactoryFinder
name|FRAME_TRANSLATOR_FINDER
init|=
operator|new
name|FactoryFinder
argument_list|(
literal|"META-INF/services/org/apache/activemq/transport/frametranslator/"
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
specifier|final
name|BrokerContext
name|brokerContext
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
name|String
name|version
init|=
literal|"1.0"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
name|long
name|hbReadInterval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
name|long
name|hbWriteInterval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
name|float
name|hbGracePeriodMultiplier
init|=
literal|1.0f
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|private
name|String
name|defaultHeartBeat
init|=
name|Stomp
operator|.
name|DEFAULT_HEART_BEAT
decl_stmt|;
end_decl_stmt

begin_class
specifier|private
specifier|static
class|class
name|AckEntry
block|{
specifier|private
specifier|final
name|String
name|messageId
decl_stmt|;
specifier|private
specifier|final
name|StompSubscription
name|subscription
decl_stmt|;
specifier|public
name|AckEntry
parameter_list|(
name|String
name|messageId
parameter_list|,
name|StompSubscription
name|subscription
parameter_list|)
block|{
name|this
operator|.
name|messageId
operator|=
name|messageId
expr_stmt|;
name|this
operator|.
name|subscription
operator|=
name|subscription
expr_stmt|;
block|}
specifier|public
name|MessageAck
name|onMessageAck
parameter_list|(
name|TransactionId
name|transactionId
parameter_list|)
block|{
return|return
name|subscription
operator|.
name|onStompMessageAck
argument_list|(
name|messageId
argument_list|,
name|transactionId
argument_list|)
return|;
block|}
specifier|public
name|MessageAck
name|onMessageNack
parameter_list|(
name|TransactionId
name|transactionId
parameter_list|)
throws|throws
name|ProtocolException
block|{
return|return
name|subscription
operator|.
name|onStompMessageNack
argument_list|(
name|messageId
argument_list|,
name|transactionId
argument_list|)
return|;
block|}
specifier|public
name|String
name|getMessageId
parameter_list|()
block|{
return|return
name|this
operator|.
name|messageId
return|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unused"
argument_list|)
specifier|public
name|StompSubscription
name|getSubscription
parameter_list|()
block|{
return|return
name|this
operator|.
name|subscription
return|;
block|}
block|}
end_class

begin_constructor
specifier|public
name|ProtocolConverter
parameter_list|(
name|StompTransport
name|stompTransport
parameter_list|,
name|BrokerContext
name|brokerContext
parameter_list|)
block|{
name|this
operator|.
name|stompTransport
operator|=
name|stompTransport
expr_stmt|;
name|this
operator|.
name|brokerContext
operator|=
name|brokerContext
expr_stmt|;
block|}
end_constructor

begin_function
specifier|protected
name|int
name|generateCommandId
parameter_list|()
block|{
synchronized|synchronized
init|(
name|commnadIdMutex
init|)
block|{
return|return
name|lastCommandId
operator|++
return|;
block|}
block|}
end_function

begin_function
specifier|protected
name|ResponseHandler
name|createResponseHandler
parameter_list|(
specifier|final
name|StompFrame
name|command
parameter_list|)
block|{
specifier|final
name|String
name|receiptId
init|=
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|RECEIPT_REQUESTED
argument_list|)
decl_stmt|;
if|if
condition|(
name|receiptId
operator|!=
literal|null
condition|)
block|{
return|return
operator|new
name|ResponseHandler
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|ProtocolConverter
name|converter
parameter_list|,
name|Response
name|response
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|response
operator|.
name|isException
argument_list|()
condition|)
block|{
comment|// Generally a command can fail.. but that does not invalidate the connection.
comment|// We report back the failure but we don't close the connection.
name|Throwable
name|exception
init|=
operator|(
operator|(
name|ExceptionResponse
operator|)
name|response
operator|)
operator|.
name|getException
argument_list|()
decl_stmt|;
name|handleException
argument_list|(
name|exception
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StompFrame
name|sc
init|=
operator|new
name|StompFrame
argument_list|()
decl_stmt|;
name|sc
operator|.
name|setAction
argument_list|(
name|Stomp
operator|.
name|Responses
operator|.
name|RECEIPT
argument_list|)
expr_stmt|;
name|sc
operator|.
name|setHeaders
argument_list|(
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|getHeaders
argument_list|()
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Response
operator|.
name|RECEIPT_ID
argument_list|,
name|receiptId
argument_list|)
expr_stmt|;
name|stompTransport
operator|.
name|sendToStomp
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|;
block|}
return|return
literal|null
return|;
block|}
end_function

begin_function
specifier|protected
name|void
name|sendToActiveMQ
parameter_list|(
name|Command
name|command
parameter_list|,
name|ResponseHandler
name|handler
parameter_list|)
block|{
name|command
operator|.
name|setCommandId
argument_list|(
name|generateCommandId
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|handler
operator|!=
literal|null
condition|)
block|{
name|command
operator|.
name|setResponseRequired
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|resposeHandlers
operator|.
name|put
argument_list|(
name|Integer
operator|.
name|valueOf
argument_list|(
name|command
operator|.
name|getCommandId
argument_list|()
argument_list|)
argument_list|,
name|handler
argument_list|)
expr_stmt|;
block|}
name|stompTransport
operator|.
name|sendToActiveMQ
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|sendToStomp
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|IOException
block|{
name|stompTransport
operator|.
name|sendToStomp
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|FrameTranslator
name|findTranslator
parameter_list|(
name|String
name|header
parameter_list|)
block|{
return|return
name|findTranslator
argument_list|(
name|header
argument_list|,
literal|null
argument_list|,
literal|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|protected
name|FrameTranslator
name|findTranslator
parameter_list|(
name|String
name|header
parameter_list|,
name|ActiveMQDestination
name|destination
parameter_list|,
name|boolean
name|advisory
parameter_list|)
block|{
name|FrameTranslator
name|translator
init|=
name|frameTranslator
decl_stmt|;
try|try
block|{
if|if
condition|(
name|header
operator|!=
literal|null
condition|)
block|{
name|translator
operator|=
operator|(
name|FrameTranslator
operator|)
name|FRAME_TRANSLATOR_FINDER
operator|.
name|newInstance
argument_list|(
name|header
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|destination
operator|!=
literal|null
operator|&&
operator|(
name|advisory
operator|||
name|AdvisorySupport
operator|.
name|isAdvisoryTopic
argument_list|(
name|destination
argument_list|)
operator|)
condition|)
block|{
name|translator
operator|=
operator|new
name|JmsFrameTranslator
argument_list|()
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|ignore
parameter_list|)
block|{
comment|// if anything goes wrong use the default translator
block|}
if|if
condition|(
name|translator
operator|instanceof
name|BrokerContextAware
condition|)
block|{
operator|(
operator|(
name|BrokerContextAware
operator|)
name|translator
operator|)
operator|.
name|setBrokerContext
argument_list|(
name|brokerContext
argument_list|)
expr_stmt|;
block|}
return|return
name|translator
return|;
block|}
end_function

begin_comment
comment|/**      * Convert a STOMP command      *      * @param command      */
end_comment

begin_function
specifier|public
name|void
name|onStompCommand
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|IOException
throws|,
name|JMSException
block|{
try|try
block|{
if|if
condition|(
name|command
operator|.
name|getClass
argument_list|()
operator|==
name|StompFrameError
operator|.
name|class
condition|)
block|{
throw|throw
operator|(
operator|(
name|StompFrameError
operator|)
name|command
operator|)
operator|.
name|getException
argument_list|()
throw|;
block|}
name|String
name|action
init|=
name|command
operator|.
name|getAction
argument_list|()
decl_stmt|;
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|SEND
argument_list|)
condition|)
block|{
name|onStompSend
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|ACK
argument_list|)
condition|)
block|{
name|onStompAck
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|NACK
argument_list|)
condition|)
block|{
name|onStompNack
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|BEGIN
argument_list|)
condition|)
block|{
name|onStompBegin
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|COMMIT
argument_list|)
condition|)
block|{
name|onStompCommit
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|ABORT
argument_list|)
condition|)
block|{
name|onStompAbort
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|SUBSCRIBE
argument_list|)
condition|)
block|{
name|onStompSubscribe
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|UNSUBSCRIBE
argument_list|)
condition|)
block|{
name|onStompUnsubscribe
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|CONNECT
argument_list|)
operator|||
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|STOMP
argument_list|)
condition|)
block|{
name|onStompConnect
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|startsWith
argument_list|(
name|Stomp
operator|.
name|Commands
operator|.
name|DISCONNECT
argument_list|)
condition|)
block|{
name|onStompDisconnect
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Unknown STOMP action: "
operator|+
name|action
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|ProtocolException
name|e
parameter_list|)
block|{
name|handleException
argument_list|(
name|e
argument_list|,
name|command
argument_list|)
expr_stmt|;
comment|// Some protocol errors can cause the connection to get closed.
if|if
condition|(
name|e
operator|.
name|isFatal
argument_list|()
condition|)
block|{
name|getStompTransport
argument_list|()
operator|.
name|onException
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|handleException
parameter_list|(
name|Throwable
name|exception
parameter_list|,
name|StompFrame
name|command
parameter_list|)
throws|throws
name|IOException
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception occurred processing: \n"
operator|+
name|command
operator|+
literal|": "
operator|+
name|exception
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Exception detail"
argument_list|,
name|exception
argument_list|)
expr_stmt|;
block|}
comment|// Let the stomp client know about any protocol errors.
name|ByteArrayOutputStream
name|baos
init|=
operator|new
name|ByteArrayOutputStream
argument_list|()
decl_stmt|;
name|PrintWriter
name|stream
init|=
operator|new
name|PrintWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|baos
argument_list|,
literal|"UTF-8"
argument_list|)
argument_list|)
decl_stmt|;
name|exception
operator|.
name|printStackTrace
argument_list|(
name|stream
argument_list|)
expr_stmt|;
name|stream
operator|.
name|close
argument_list|()
expr_stmt|;
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|headers
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Error
operator|.
name|MESSAGE
argument_list|,
name|exception
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|headers
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|CONTENT_TYPE
argument_list|,
literal|"text/plain"
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
operator|!=
literal|null
condition|)
block|{
specifier|final
name|String
name|receiptId
init|=
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|RECEIPT_REQUESTED
argument_list|)
decl_stmt|;
if|if
condition|(
name|receiptId
operator|!=
literal|null
condition|)
block|{
name|headers
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Response
operator|.
name|RECEIPT_ID
argument_list|,
name|receiptId
argument_list|)
expr_stmt|;
block|}
block|}
name|StompFrame
name|errorMessage
init|=
operator|new
name|StompFrame
argument_list|(
name|Stomp
operator|.
name|Responses
operator|.
name|ERROR
argument_list|,
name|headers
argument_list|,
name|baos
operator|.
name|toByteArray
argument_list|()
argument_list|)
decl_stmt|;
name|sendToStomp
argument_list|(
name|errorMessage
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompSend
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|IOException
throws|,
name|JMSException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|destination
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Send
operator|.
name|DESTINATION
argument_list|)
decl_stmt|;
if|if
condition|(
name|destination
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"SEND received without a Destination specified!"
argument_list|)
throw|;
block|}
name|String
name|stompTx
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
decl_stmt|;
name|headers
operator|.
name|remove
argument_list|(
literal|"transaction"
argument_list|)
expr_stmt|;
name|ActiveMQMessage
name|message
init|=
name|convertMessage
argument_list|(
name|command
argument_list|)
decl_stmt|;
name|message
operator|.
name|setProducerId
argument_list|(
name|producerId
argument_list|)
expr_stmt|;
name|MessageId
name|id
init|=
operator|new
name|MessageId
argument_list|(
name|producerId
argument_list|,
name|messageIdGenerator
operator|.
name|getNextSequenceId
argument_list|()
argument_list|)
decl_stmt|;
name|message
operator|.
name|setMessageId
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|stompTx
operator|!=
literal|null
condition|)
block|{
name|TransactionId
name|activemqTx
init|=
name|transactions
operator|.
name|get
argument_list|(
name|stompTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|activemqTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid transaction id: "
operator|+
name|stompTx
argument_list|)
throw|;
block|}
name|message
operator|.
name|setTransactionId
argument_list|(
name|activemqTx
argument_list|)
expr_stmt|;
block|}
name|message
operator|.
name|onSend
argument_list|()
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|message
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompNack
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_0
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"NACK received but connection is in v1.0 mode."
argument_list|)
throw|;
block|}
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|subscriptionId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Ack
operator|.
name|SUBSCRIPTION
argument_list|)
decl_stmt|;
if|if
condition|(
name|subscriptionId
operator|==
literal|null
operator|&&
operator|!
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_2
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"NACK received without a subscription id for acknowledge!"
argument_list|)
throw|;
block|}
name|String
name|messageId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Ack
operator|.
name|MESSAGE_ID
argument_list|)
decl_stmt|;
if|if
condition|(
name|messageId
operator|==
literal|null
operator|&&
operator|!
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_2
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"NACK received without a message-id to acknowledge!"
argument_list|)
throw|;
block|}
name|String
name|ackId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Ack
operator|.
name|ACK_ID
argument_list|)
decl_stmt|;
if|if
condition|(
name|ackId
operator|==
literal|null
operator|&&
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_2
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"NACK received without an ack header to acknowledge!"
argument_list|)
throw|;
block|}
name|TransactionId
name|activemqTx
init|=
literal|null
decl_stmt|;
name|String
name|stompTx
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
decl_stmt|;
if|if
condition|(
name|stompTx
operator|!=
literal|null
condition|)
block|{
name|activemqTx
operator|=
name|transactions
operator|.
name|get
argument_list|(
name|stompTx
argument_list|)
expr_stmt|;
if|if
condition|(
name|activemqTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid transaction id: "
operator|+
name|stompTx
argument_list|)
throw|;
block|}
block|}
name|boolean
name|nacked
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|ackId
operator|!=
literal|null
condition|)
block|{
name|AckEntry
name|pendingAck
init|=
name|this
operator|.
name|pedingAcks
operator|.
name|remove
argument_list|(
name|ackId
argument_list|)
decl_stmt|;
if|if
condition|(
name|pendingAck
operator|!=
literal|null
condition|)
block|{
name|messageId
operator|=
name|pendingAck
operator|.
name|getMessageId
argument_list|()
expr_stmt|;
name|MessageAck
name|ack
init|=
name|pendingAck
operator|.
name|onMessageNack
argument_list|(
name|activemqTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|ack
operator|!=
literal|null
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|ack
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|nacked
operator|=
literal|true
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|subscriptionId
operator|!=
literal|null
condition|)
block|{
name|StompSubscription
name|sub
init|=
name|this
operator|.
name|subscriptions
operator|.
name|get
argument_list|(
name|subscriptionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|sub
operator|!=
literal|null
condition|)
block|{
name|MessageAck
name|ack
init|=
name|sub
operator|.
name|onStompMessageNack
argument_list|(
name|messageId
argument_list|,
name|activemqTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|ack
operator|!=
literal|null
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|ack
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|nacked
operator|=
literal|true
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|nacked
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Unexpected NACK received for message-id ["
operator|+
name|messageId
operator|+
literal|"]"
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompAck
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|messageId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Ack
operator|.
name|MESSAGE_ID
argument_list|)
decl_stmt|;
if|if
condition|(
name|messageId
operator|==
literal|null
operator|&&
operator|!
operator|(
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_2
argument_list|)
operator|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"ACK received without a message-id to acknowledge!"
argument_list|)
throw|;
block|}
name|String
name|subscriptionId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Ack
operator|.
name|SUBSCRIPTION
argument_list|)
decl_stmt|;
if|if
condition|(
name|subscriptionId
operator|==
literal|null
operator|&&
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_1
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"ACK received without a subscription id for acknowledge!"
argument_list|)
throw|;
block|}
name|String
name|ackId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Ack
operator|.
name|ACK_ID
argument_list|)
decl_stmt|;
if|if
condition|(
name|ackId
operator|==
literal|null
operator|&&
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_2
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"ACK received without a ack id for acknowledge!"
argument_list|)
throw|;
block|}
name|TransactionId
name|activemqTx
init|=
literal|null
decl_stmt|;
name|String
name|stompTx
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
decl_stmt|;
if|if
condition|(
name|stompTx
operator|!=
literal|null
condition|)
block|{
name|activemqTx
operator|=
name|transactions
operator|.
name|get
argument_list|(
name|stompTx
argument_list|)
expr_stmt|;
if|if
condition|(
name|activemqTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid transaction id: "
operator|+
name|stompTx
argument_list|)
throw|;
block|}
block|}
name|boolean
name|acked
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|ackId
operator|!=
literal|null
condition|)
block|{
name|AckEntry
name|pendingAck
init|=
name|this
operator|.
name|pedingAcks
operator|.
name|remove
argument_list|(
name|ackId
argument_list|)
decl_stmt|;
if|if
condition|(
name|pendingAck
operator|!=
literal|null
condition|)
block|{
name|messageId
operator|=
name|pendingAck
operator|.
name|getMessageId
argument_list|()
expr_stmt|;
name|MessageAck
name|ack
init|=
name|pendingAck
operator|.
name|onMessageAck
argument_list|(
name|activemqTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|ack
operator|!=
literal|null
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|ack
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|acked
operator|=
literal|true
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|subscriptionId
operator|!=
literal|null
condition|)
block|{
name|StompSubscription
name|sub
init|=
name|this
operator|.
name|subscriptions
operator|.
name|get
argument_list|(
name|subscriptionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|sub
operator|!=
literal|null
condition|)
block|{
name|MessageAck
name|ack
init|=
name|sub
operator|.
name|onStompMessageAck
argument_list|(
name|messageId
argument_list|,
name|activemqTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|ack
operator|!=
literal|null
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|ack
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|acked
operator|=
literal|true
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|// STOMP v1.0: acking with just a message id is very bogus since the same message id
comment|// could have been sent to 2 different subscriptions on the same Stomp connection.
comment|// For example, when 2 subs are created on the same topic.
for|for
control|(
name|StompSubscription
name|sub
range|:
name|subscriptionsByConsumerId
operator|.
name|values
argument_list|()
control|)
block|{
name|MessageAck
name|ack
init|=
name|sub
operator|.
name|onStompMessageAck
argument_list|(
name|messageId
argument_list|,
name|activemqTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|ack
operator|!=
literal|null
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|ack
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|acked
operator|=
literal|true
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|acked
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Unexpected ACK received for message-id ["
operator|+
name|messageId
operator|+
literal|"]"
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompBegin
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|stompTx
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|headers
operator|.
name|containsKey
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Must specify the transaction you are beginning"
argument_list|)
throw|;
block|}
if|if
condition|(
name|transactions
operator|.
name|get
argument_list|(
name|stompTx
argument_list|)
operator|!=
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"The transaction was already started: "
operator|+
name|stompTx
argument_list|)
throw|;
block|}
name|LocalTransactionId
name|activemqTx
init|=
operator|new
name|LocalTransactionId
argument_list|(
name|connectionId
argument_list|,
name|transactionIdGenerator
operator|.
name|getNextSequenceId
argument_list|()
argument_list|)
decl_stmt|;
name|transactions
operator|.
name|put
argument_list|(
name|stompTx
argument_list|,
name|activemqTx
argument_list|)
expr_stmt|;
name|TransactionInfo
name|tx
init|=
operator|new
name|TransactionInfo
argument_list|()
decl_stmt|;
name|tx
operator|.
name|setConnectionId
argument_list|(
name|connectionId
argument_list|)
expr_stmt|;
name|tx
operator|.
name|setTransactionId
argument_list|(
name|activemqTx
argument_list|)
expr_stmt|;
name|tx
operator|.
name|setType
argument_list|(
name|TransactionInfo
operator|.
name|BEGIN
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|tx
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompCommit
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|stompTx
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
decl_stmt|;
if|if
condition|(
name|stompTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Must specify the transaction you are committing"
argument_list|)
throw|;
block|}
name|TransactionId
name|activemqTx
init|=
name|transactions
operator|.
name|remove
argument_list|(
name|stompTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|activemqTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid transaction id: "
operator|+
name|stompTx
argument_list|)
throw|;
block|}
for|for
control|(
name|StompSubscription
name|sub
range|:
name|subscriptionsByConsumerId
operator|.
name|values
argument_list|()
control|)
block|{
name|sub
operator|.
name|onStompCommit
argument_list|(
name|activemqTx
argument_list|)
expr_stmt|;
block|}
name|pedingAcks
operator|.
name|clear
argument_list|()
expr_stmt|;
name|TransactionInfo
name|tx
init|=
operator|new
name|TransactionInfo
argument_list|()
decl_stmt|;
name|tx
operator|.
name|setConnectionId
argument_list|(
name|connectionId
argument_list|)
expr_stmt|;
name|tx
operator|.
name|setTransactionId
argument_list|(
name|activemqTx
argument_list|)
expr_stmt|;
name|tx
operator|.
name|setType
argument_list|(
name|TransactionInfo
operator|.
name|COMMIT_ONE_PHASE
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|tx
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompAbort
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|stompTx
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSACTION
argument_list|)
decl_stmt|;
if|if
condition|(
name|stompTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Must specify the transaction you are committing"
argument_list|)
throw|;
block|}
name|TransactionId
name|activemqTx
init|=
name|transactions
operator|.
name|remove
argument_list|(
name|stompTx
argument_list|)
decl_stmt|;
if|if
condition|(
name|activemqTx
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid transaction id: "
operator|+
name|stompTx
argument_list|)
throw|;
block|}
for|for
control|(
name|StompSubscription
name|sub
range|:
name|subscriptionsByConsumerId
operator|.
name|values
argument_list|()
control|)
block|{
try|try
block|{
name|sub
operator|.
name|onStompAbort
argument_list|(
name|activemqTx
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Transaction abort failed"
argument_list|,
literal|false
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
name|pedingAcks
operator|.
name|clear
argument_list|()
expr_stmt|;
name|TransactionInfo
name|tx
init|=
operator|new
name|TransactionInfo
argument_list|()
decl_stmt|;
name|tx
operator|.
name|setConnectionId
argument_list|(
name|connectionId
argument_list|)
expr_stmt|;
name|tx
operator|.
name|setTransactionId
argument_list|(
name|activemqTx
argument_list|)
expr_stmt|;
name|tx
operator|.
name|setType
argument_list|(
name|TransactionInfo
operator|.
name|ROLLBACK
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|tx
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompSubscribe
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|FrameTranslator
name|translator
init|=
name|findTranslator
argument_list|(
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSFORMATION
argument_list|)
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|String
name|subscriptionId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|ID
argument_list|)
decl_stmt|;
name|String
name|destination
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|DESTINATION
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_0
argument_list|)
operator|&&
name|subscriptionId
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"SUBSCRIBE received without a subscription id!"
argument_list|)
throw|;
block|}
specifier|final
name|ActiveMQDestination
name|actualDest
init|=
name|translator
operator|.
name|convertDestination
argument_list|(
name|this
argument_list|,
name|destination
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|actualDest
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid 'null' Destination."
argument_list|)
throw|;
block|}
specifier|final
name|ConsumerId
name|id
init|=
operator|new
name|ConsumerId
argument_list|(
name|sessionId
argument_list|,
name|consumerIdGenerator
operator|.
name|getNextSequenceId
argument_list|()
argument_list|)
decl_stmt|;
name|ConsumerInfo
name|consumerInfo
init|=
operator|new
name|ConsumerInfo
argument_list|(
name|id
argument_list|)
decl_stmt|;
name|consumerInfo
operator|.
name|setPrefetchSize
argument_list|(
name|actualDest
operator|.
name|isQueue
argument_list|()
condition|?
name|ActiveMQPrefetchPolicy
operator|.
name|DEFAULT_QUEUE_PREFETCH
else|:
name|headers
operator|.
name|containsKey
argument_list|(
literal|"activemq.subscriptionName"
argument_list|)
condition|?
name|ActiveMQPrefetchPolicy
operator|.
name|DEFAULT_DURABLE_TOPIC_PREFETCH
else|:
name|ActiveMQPrefetchPolicy
operator|.
name|DEFAULT_TOPIC_PREFETCH
argument_list|)
expr_stmt|;
name|consumerInfo
operator|.
name|setDispatchAsync
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|String
name|browser
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|BROWSER
argument_list|)
decl_stmt|;
if|if
condition|(
name|browser
operator|!=
literal|null
operator|&&
name|browser
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|TRUE
argument_list|)
condition|)
block|{
if|if
condition|(
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_0
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Queue Browser feature only valid for Stomp v1.1+ clients!"
argument_list|)
throw|;
block|}
name|consumerInfo
operator|.
name|setBrowser
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|consumerInfo
operator|.
name|setPrefetchSize
argument_list|(
name|ActiveMQPrefetchPolicy
operator|.
name|DEFAULT_QUEUE_BROWSER_PREFETCH
argument_list|)
expr_stmt|;
block|}
name|String
name|selector
init|=
name|headers
operator|.
name|remove
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|SELECTOR
argument_list|)
decl_stmt|;
if|if
condition|(
name|selector
operator|!=
literal|null
condition|)
block|{
name|consumerInfo
operator|.
name|setSelector
argument_list|(
literal|"convert_string_expressions:"
operator|+
name|selector
argument_list|)
expr_stmt|;
block|}
name|IntrospectionSupport
operator|.
name|setProperties
argument_list|(
name|consumerInfo
argument_list|,
name|headers
argument_list|,
literal|"activemq."
argument_list|)
expr_stmt|;
if|if
condition|(
name|actualDest
operator|.
name|isQueue
argument_list|()
operator|&&
name|consumerInfo
operator|.
name|getSubscriptionName
argument_list|()
operator|!=
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid Subscription: cannot durably subscribe to a Queue destination!"
argument_list|)
throw|;
block|}
name|consumerInfo
operator|.
name|setDestination
argument_list|(
name|translator
operator|.
name|convertDestination
argument_list|(
name|this
argument_list|,
name|destination
argument_list|,
literal|true
argument_list|)
argument_list|)
expr_stmt|;
name|StompSubscription
name|stompSubscription
decl_stmt|;
if|if
condition|(
operator|!
name|consumerInfo
operator|.
name|isBrowser
argument_list|()
condition|)
block|{
name|stompSubscription
operator|=
operator|new
name|StompSubscription
argument_list|(
name|this
argument_list|,
name|subscriptionId
argument_list|,
name|consumerInfo
argument_list|,
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSFORMATION
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stompSubscription
operator|=
operator|new
name|StompQueueBrowserSubscription
argument_list|(
name|this
argument_list|,
name|subscriptionId
argument_list|,
name|consumerInfo
argument_list|,
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSFORMATION
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|stompSubscription
operator|.
name|setDestination
argument_list|(
name|actualDest
argument_list|)
expr_stmt|;
name|String
name|ackMode
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|ACK_MODE
argument_list|)
decl_stmt|;
if|if
condition|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|AckModeValues
operator|.
name|CLIENT
operator|.
name|equals
argument_list|(
name|ackMode
argument_list|)
condition|)
block|{
name|stompSubscription
operator|.
name|setAckMode
argument_list|(
name|StompSubscription
operator|.
name|CLIENT_ACK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|AckModeValues
operator|.
name|INDIVIDUAL
operator|.
name|equals
argument_list|(
name|ackMode
argument_list|)
condition|)
block|{
name|stompSubscription
operator|.
name|setAckMode
argument_list|(
name|StompSubscription
operator|.
name|INDIVIDUAL_ACK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stompSubscription
operator|.
name|setAckMode
argument_list|(
name|StompSubscription
operator|.
name|AUTO_ACK
argument_list|)
expr_stmt|;
block|}
name|subscriptionsByConsumerId
operator|.
name|put
argument_list|(
name|id
argument_list|,
name|stompSubscription
argument_list|)
expr_stmt|;
comment|// Stomp v1.0 doesn't need to set this header so we avoid an NPE if not set.
if|if
condition|(
name|subscriptionId
operator|!=
literal|null
condition|)
block|{
name|subscriptions
operator|.
name|put
argument_list|(
name|subscriptionId
argument_list|,
name|stompSubscription
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|receiptId
init|=
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|RECEIPT_REQUESTED
argument_list|)
decl_stmt|;
if|if
condition|(
name|receiptId
operator|!=
literal|null
operator|&&
name|consumerInfo
operator|.
name|getPrefetchSize
argument_list|()
operator|>
literal|0
condition|)
block|{
specifier|final
name|StompFrame
name|cmd
init|=
name|command
decl_stmt|;
specifier|final
name|int
name|prefetch
init|=
name|consumerInfo
operator|.
name|getPrefetchSize
argument_list|()
decl_stmt|;
comment|// Since dispatch could beat the receipt we set prefetch to zero to start and then
comment|// once we've sent our Receipt we are safe to turn on dispatch if the response isn't
comment|// an error message.
name|consumerInfo
operator|.
name|setPrefetchSize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
specifier|final
name|ResponseHandler
name|handler
init|=
operator|new
name|ResponseHandler
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|ProtocolConverter
name|converter
parameter_list|,
name|Response
name|response
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|response
operator|.
name|isException
argument_list|()
condition|)
block|{
comment|// Generally a command can fail.. but that does not invalidate the connection.
comment|// We report back the failure but we don't close the connection.
name|Throwable
name|exception
init|=
operator|(
operator|(
name|ExceptionResponse
operator|)
name|response
operator|)
operator|.
name|getException
argument_list|()
decl_stmt|;
name|handleException
argument_list|(
name|exception
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StompFrame
name|sc
init|=
operator|new
name|StompFrame
argument_list|()
decl_stmt|;
name|sc
operator|.
name|setAction
argument_list|(
name|Stomp
operator|.
name|Responses
operator|.
name|RECEIPT
argument_list|)
expr_stmt|;
name|sc
operator|.
name|setHeaders
argument_list|(
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|getHeaders
argument_list|()
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Response
operator|.
name|RECEIPT_ID
argument_list|,
name|receiptId
argument_list|)
expr_stmt|;
name|stompTransport
operator|.
name|sendToStomp
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ConsumerControl
name|control
init|=
operator|new
name|ConsumerControl
argument_list|()
decl_stmt|;
name|control
operator|.
name|setPrefetch
argument_list|(
name|prefetch
argument_list|)
expr_stmt|;
name|control
operator|.
name|setDestination
argument_list|(
name|actualDest
argument_list|)
expr_stmt|;
name|control
operator|.
name|setConsumerId
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|control
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
name|sendToActiveMQ
argument_list|(
name|consumerInfo
argument_list|,
name|handler
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sendToActiveMQ
argument_list|(
name|consumerInfo
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompUnsubscribe
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|checkConnected
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
name|ActiveMQDestination
name|destination
init|=
literal|null
decl_stmt|;
name|Object
name|o
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Unsubscribe
operator|.
name|DESTINATION
argument_list|)
decl_stmt|;
if|if
condition|(
name|o
operator|!=
literal|null
condition|)
block|{
name|destination
operator|=
name|findTranslator
argument_list|(
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSFORMATION
argument_list|)
argument_list|)
operator|.
name|convertDestination
argument_list|(
name|this
argument_list|,
operator|(
name|String
operator|)
name|o
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
name|String
name|subscriptionId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Unsubscribe
operator|.
name|ID
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_0
argument_list|)
operator|&&
name|subscriptionId
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"UNSUBSCRIBE received without a subscription id!"
argument_list|)
throw|;
block|}
if|if
condition|(
name|subscriptionId
operator|==
literal|null
operator|&&
name|destination
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Must specify the subscriptionId or the destination you are unsubscribing from"
argument_list|)
throw|;
block|}
comment|// check if it is a durable subscription
name|String
name|durable
init|=
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
literal|"activemq.subscriptionName"
argument_list|)
decl_stmt|;
name|String
name|clientId
init|=
name|durable
decl_stmt|;
if|if
condition|(
operator|!
name|this
operator|.
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_0
argument_list|)
condition|)
block|{
name|clientId
operator|=
name|connectionInfo
operator|.
name|getClientId
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|durable
operator|!=
literal|null
condition|)
block|{
name|RemoveSubscriptionInfo
name|info
init|=
operator|new
name|RemoveSubscriptionInfo
argument_list|()
decl_stmt|;
name|info
operator|.
name|setClientId
argument_list|(
name|clientId
argument_list|)
expr_stmt|;
name|info
operator|.
name|setSubscriptionName
argument_list|(
name|durable
argument_list|)
expr_stmt|;
name|info
operator|.
name|setConnectionId
argument_list|(
name|connectionId
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|info
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|subscriptionId
operator|!=
literal|null
condition|)
block|{
name|StompSubscription
name|sub
init|=
name|this
operator|.
name|subscriptions
operator|.
name|remove
argument_list|(
name|subscriptionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|sub
operator|!=
literal|null
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|sub
operator|.
name|getConsumerInfo
argument_list|()
operator|.
name|createRemoveCommand
argument_list|()
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|// Unsubscribing using a destination is a bit weird if multiple subscriptions
comment|// are created with the same destination.
for|for
control|(
name|Iterator
argument_list|<
name|StompSubscription
argument_list|>
name|iter
init|=
name|subscriptionsByConsumerId
operator|.
name|values
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|StompSubscription
name|sub
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|destination
operator|!=
literal|null
operator|&&
name|destination
operator|.
name|equals
argument_list|(
name|sub
operator|.
name|getDestination
argument_list|()
argument_list|)
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|sub
operator|.
name|getConsumerInfo
argument_list|()
operator|.
name|createRemoveCommand
argument_list|()
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|iter
operator|.
name|remove
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
block|}
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"No subscription matched."
argument_list|)
throw|;
block|}
end_function

begin_decl_stmt
name|ConnectionInfo
name|connectionInfo
init|=
operator|new
name|ConnectionInfo
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
specifier|protected
name|void
name|onStompConnect
parameter_list|(
specifier|final
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
if|if
condition|(
name|connected
operator|.
name|get
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Already connected."
argument_list|)
throw|;
block|}
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
init|=
name|command
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
comment|// allow anyone to login for now
name|String
name|login
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connect
operator|.
name|LOGIN
argument_list|)
decl_stmt|;
name|String
name|passcode
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connect
operator|.
name|PASSCODE
argument_list|)
decl_stmt|;
name|String
name|clientId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connect
operator|.
name|CLIENT_ID
argument_list|)
decl_stmt|;
name|String
name|heartBeat
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connect
operator|.
name|HEART_BEAT
argument_list|)
decl_stmt|;
if|if
condition|(
name|heartBeat
operator|==
literal|null
condition|)
block|{
name|heartBeat
operator|=
name|defaultHeartBeat
expr_stmt|;
block|}
name|this
operator|.
name|version
operator|=
name|StompCodec
operator|.
name|detectVersion
argument_list|(
name|headers
argument_list|)
expr_stmt|;
name|configureInactivityMonitor
argument_list|(
name|heartBeat
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
name|IntrospectionSupport
operator|.
name|setProperties
argument_list|(
name|connectionInfo
argument_list|,
name|headers
argument_list|,
literal|"activemq."
argument_list|)
expr_stmt|;
name|connectionInfo
operator|.
name|setConnectionId
argument_list|(
name|connectionId
argument_list|)
expr_stmt|;
if|if
condition|(
name|clientId
operator|!=
literal|null
condition|)
block|{
name|connectionInfo
operator|.
name|setClientId
argument_list|(
name|clientId
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|connectionInfo
operator|.
name|setClientId
argument_list|(
literal|""
operator|+
name|connectionInfo
operator|.
name|getConnectionId
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|connectionInfo
operator|.
name|setResponseRequired
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|connectionInfo
operator|.
name|setUserName
argument_list|(
name|login
argument_list|)
expr_stmt|;
name|connectionInfo
operator|.
name|setPassword
argument_list|(
name|passcode
argument_list|)
expr_stmt|;
name|connectionInfo
operator|.
name|setTransportContext
argument_list|(
name|command
operator|.
name|getTransportContext
argument_list|()
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
name|connectionInfo
argument_list|,
operator|new
name|ResponseHandler
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|ProtocolConverter
name|converter
parameter_list|,
name|Response
name|response
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|response
operator|.
name|isException
argument_list|()
condition|)
block|{
comment|// If the connection attempt fails we close the socket.
name|Throwable
name|exception
init|=
operator|(
operator|(
name|ExceptionResponse
operator|)
name|response
operator|)
operator|.
name|getException
argument_list|()
decl_stmt|;
name|handleException
argument_list|(
name|exception
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|getStompTransport
argument_list|()
operator|.
name|onException
argument_list|(
name|IOExceptionSupport
operator|.
name|create
argument_list|(
name|exception
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|final
name|SessionInfo
name|sessionInfo
init|=
operator|new
name|SessionInfo
argument_list|(
name|sessionId
argument_list|)
decl_stmt|;
name|sendToActiveMQ
argument_list|(
name|sessionInfo
argument_list|,
literal|null
argument_list|)
expr_stmt|;
specifier|final
name|ProducerInfo
name|producerInfo
init|=
operator|new
name|ProducerInfo
argument_list|(
name|producerId
argument_list|)
decl_stmt|;
name|sendToActiveMQ
argument_list|(
name|producerInfo
argument_list|,
operator|new
name|ResponseHandler
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|ProtocolConverter
name|converter
parameter_list|,
name|Response
name|response
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|response
operator|.
name|isException
argument_list|()
condition|)
block|{
comment|// If the connection attempt fails we close the socket.
name|Throwable
name|exception
init|=
operator|(
operator|(
name|ExceptionResponse
operator|)
name|response
operator|)
operator|.
name|getException
argument_list|()
decl_stmt|;
name|handleException
argument_list|(
name|exception
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|getStompTransport
argument_list|()
operator|.
name|onException
argument_list|(
name|IOExceptionSupport
operator|.
name|create
argument_list|(
name|exception
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|connected
operator|.
name|set
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|responseHeaders
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|responseHeaders
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connected
operator|.
name|SESSION
argument_list|,
name|connectionInfo
operator|.
name|getClientId
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|requestId
init|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connect
operator|.
name|REQUEST_ID
argument_list|)
decl_stmt|;
if|if
condition|(
name|requestId
operator|==
literal|null
condition|)
block|{
comment|// TODO legacy
name|requestId
operator|=
name|headers
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|RECEIPT_REQUESTED
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|requestId
operator|!=
literal|null
condition|)
block|{
comment|// TODO legacy
name|responseHeaders
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connected
operator|.
name|RESPONSE_ID
argument_list|,
name|requestId
argument_list|)
expr_stmt|;
name|responseHeaders
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Response
operator|.
name|RECEIPT_ID
argument_list|,
name|requestId
argument_list|)
expr_stmt|;
block|}
name|responseHeaders
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connected
operator|.
name|VERSION
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|responseHeaders
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connected
operator|.
name|HEART_BEAT
argument_list|,
name|String
operator|.
name|format
argument_list|(
literal|"%d,%d"
argument_list|,
name|hbWriteInterval
argument_list|,
name|hbReadInterval
argument_list|)
argument_list|)
expr_stmt|;
name|responseHeaders
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Connected
operator|.
name|SERVER
argument_list|,
literal|"ActiveMQ/"
operator|+
name|BROKER_VERSION
argument_list|)
expr_stmt|;
name|StompFrame
name|sc
init|=
operator|new
name|StompFrame
argument_list|()
decl_stmt|;
name|sc
operator|.
name|setAction
argument_list|(
name|Stomp
operator|.
name|Responses
operator|.
name|CONNECTED
argument_list|)
expr_stmt|;
name|sc
operator|.
name|setHeaders
argument_list|(
name|responseHeaders
argument_list|)
expr_stmt|;
name|sendToStomp
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|StompWireFormat
name|format
init|=
name|stompTransport
operator|.
name|getWireFormat
argument_list|()
decl_stmt|;
if|if
condition|(
name|format
operator|!=
literal|null
condition|)
block|{
name|format
operator|.
name|setStompVersion
argument_list|(
name|version
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|onStompDisconnect
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|ProtocolException
block|{
if|if
condition|(
name|connected
operator|.
name|get
argument_list|()
condition|)
block|{
name|sendToActiveMQ
argument_list|(
name|connectionInfo
operator|.
name|createRemoveCommand
argument_list|()
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|sendToActiveMQ
argument_list|(
operator|new
name|ShutdownInfo
argument_list|()
argument_list|,
name|createResponseHandler
argument_list|(
name|command
argument_list|)
argument_list|)
expr_stmt|;
name|connected
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|checkConnected
parameter_list|()
throws|throws
name|ProtocolException
block|{
if|if
condition|(
operator|!
name|connected
operator|.
name|get
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Not connected."
argument_list|)
throw|;
block|}
block|}
end_function

begin_comment
comment|/**      * Dispatch a ActiveMQ command      *      * @param command      * @throws IOException      */
end_comment

begin_function
specifier|public
name|void
name|onActiveMQCommand
parameter_list|(
name|Command
name|command
parameter_list|)
throws|throws
name|IOException
throws|,
name|JMSException
block|{
if|if
condition|(
name|command
operator|.
name|isResponse
argument_list|()
condition|)
block|{
name|Response
name|response
init|=
operator|(
name|Response
operator|)
name|command
decl_stmt|;
name|ResponseHandler
name|rh
init|=
name|resposeHandlers
operator|.
name|remove
argument_list|(
name|Integer
operator|.
name|valueOf
argument_list|(
name|response
operator|.
name|getCorrelationId
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|rh
operator|!=
literal|null
condition|)
block|{
name|rh
operator|.
name|onResponse
argument_list|(
name|this
argument_list|,
name|response
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Pass down any unexpected errors. Should this close the connection?
if|if
condition|(
name|response
operator|.
name|isException
argument_list|()
condition|)
block|{
name|Throwable
name|exception
init|=
operator|(
operator|(
name|ExceptionResponse
operator|)
name|response
operator|)
operator|.
name|getException
argument_list|()
decl_stmt|;
name|handleException
argument_list|(
name|exception
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|isMessageDispatch
argument_list|()
condition|)
block|{
name|MessageDispatch
name|md
init|=
operator|(
name|MessageDispatch
operator|)
name|command
decl_stmt|;
name|StompSubscription
name|sub
init|=
name|subscriptionsByConsumerId
operator|.
name|get
argument_list|(
name|md
operator|.
name|getConsumerId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|sub
operator|!=
literal|null
condition|)
block|{
name|String
name|ackId
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|version
operator|.
name|equals
argument_list|(
name|Stomp
operator|.
name|V1_2
argument_list|)
operator|&&
name|sub
operator|.
name|getAckMode
argument_list|()
operator|!=
name|Stomp
operator|.
name|Headers
operator|.
name|Subscribe
operator|.
name|AckModeValues
operator|.
name|AUTO
operator|&&
name|md
operator|.
name|getMessage
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|AckEntry
name|pendingAck
init|=
operator|new
name|AckEntry
argument_list|(
name|md
operator|.
name|getMessage
argument_list|()
operator|.
name|getMessageId
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|,
name|sub
argument_list|)
decl_stmt|;
name|ackId
operator|=
name|this
operator|.
name|ACK_ID_GENERATOR
operator|.
name|generateId
argument_list|()
expr_stmt|;
name|this
operator|.
name|pedingAcks
operator|.
name|put
argument_list|(
name|ackId
argument_list|,
name|pendingAck
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|sub
operator|.
name|onMessageDispatch
argument_list|(
name|md
argument_list|,
name|ackId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
if|if
condition|(
name|ackId
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|pedingAcks
operator|.
name|remove
argument_list|(
name|ackId
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|getDataStructureType
argument_list|()
operator|==
name|CommandTypes
operator|.
name|KEEP_ALIVE_INFO
condition|)
block|{
name|stompTransport
operator|.
name|sendToStomp
argument_list|(
name|ping
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|getDataStructureType
argument_list|()
operator|==
name|ConnectionError
operator|.
name|DATA_STRUCTURE_TYPE
condition|)
block|{
comment|// Pass down any unexpected async errors. Should this close the connection?
name|Throwable
name|exception
init|=
operator|(
operator|(
name|ConnectionError
operator|)
name|command
operator|)
operator|.
name|getException
argument_list|()
decl_stmt|;
name|handleException
argument_list|(
name|exception
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|public
name|ActiveMQMessage
name|convertMessage
parameter_list|(
name|StompFrame
name|command
parameter_list|)
throws|throws
name|IOException
throws|,
name|JMSException
block|{
name|ActiveMQMessage
name|msg
init|=
name|findTranslator
argument_list|(
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSFORMATION
argument_list|)
argument_list|)
operator|.
name|convertFrame
argument_list|(
name|this
argument_list|,
name|command
argument_list|)
decl_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|public
name|StompFrame
name|convertMessage
parameter_list|(
name|ActiveMQMessage
name|message
parameter_list|,
name|boolean
name|ignoreTransformation
parameter_list|)
throws|throws
name|IOException
throws|,
name|JMSException
block|{
if|if
condition|(
name|ignoreTransformation
operator|==
literal|true
condition|)
block|{
return|return
name|frameTranslator
operator|.
name|convertMessage
argument_list|(
name|this
argument_list|,
name|message
argument_list|)
return|;
block|}
else|else
block|{
name|FrameTranslator
name|translator
init|=
name|findTranslator
argument_list|(
name|message
operator|.
name|getStringProperty
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|TRANSFORMATION
argument_list|)
argument_list|,
name|message
operator|.
name|getDestination
argument_list|()
argument_list|,
name|message
operator|.
name|isAdvisory
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|translator
operator|.
name|convertMessage
argument_list|(
name|this
argument_list|,
name|message
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|public
name|StompTransport
name|getStompTransport
parameter_list|()
block|{
return|return
name|stompTransport
return|;
block|}
end_function

begin_function
specifier|public
name|ActiveMQDestination
name|createTempDestination
parameter_list|(
name|String
name|name
parameter_list|,
name|boolean
name|topic
parameter_list|)
block|{
name|ActiveMQDestination
name|rc
init|=
name|tempDestinations
operator|.
name|get
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|topic
condition|)
block|{
name|rc
operator|=
operator|new
name|ActiveMQTempTopic
argument_list|(
name|connectionId
argument_list|,
name|tempDestinationGenerator
operator|.
name|getNextSequenceId
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
operator|new
name|ActiveMQTempQueue
argument_list|(
name|connectionId
argument_list|,
name|tempDestinationGenerator
operator|.
name|getNextSequenceId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|sendToActiveMQ
argument_list|(
operator|new
name|DestinationInfo
argument_list|(
name|connectionId
argument_list|,
name|DestinationInfo
operator|.
name|ADD_OPERATION_TYPE
argument_list|,
name|rc
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|tempDestinations
operator|.
name|put
argument_list|(
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|tempDestinationAmqToStompMap
operator|.
name|put
argument_list|(
name|rc
operator|.
name|getQualifiedName
argument_list|()
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|public
name|String
name|getCreatedTempDestinationName
parameter_list|(
name|ActiveMQDestination
name|destination
parameter_list|)
block|{
return|return
name|tempDestinationAmqToStompMap
operator|.
name|get
argument_list|(
name|destination
operator|.
name|getQualifiedName
argument_list|()
argument_list|)
return|;
block|}
end_function

begin_function
specifier|public
name|String
name|getDefaultHeartBeat
parameter_list|()
block|{
return|return
name|defaultHeartBeat
return|;
block|}
end_function

begin_function
specifier|public
name|void
name|setDefaultHeartBeat
parameter_list|(
name|String
name|defaultHeartBeat
parameter_list|)
block|{
name|this
operator|.
name|defaultHeartBeat
operator|=
name|defaultHeartBeat
expr_stmt|;
block|}
end_function

begin_comment
comment|/**      * @return the hbGracePeriodMultiplier      */
end_comment

begin_function
specifier|public
name|float
name|getHbGracePeriodMultiplier
parameter_list|()
block|{
return|return
name|hbGracePeriodMultiplier
return|;
block|}
end_function

begin_comment
comment|/**      * @param hbGracePeriodMultiplier the hbGracePeriodMultiplier to set      */
end_comment

begin_function
specifier|public
name|void
name|setHbGracePeriodMultiplier
parameter_list|(
name|float
name|hbGracePeriodMultiplier
parameter_list|)
block|{
name|this
operator|.
name|hbGracePeriodMultiplier
operator|=
name|hbGracePeriodMultiplier
expr_stmt|;
block|}
end_function

begin_function
specifier|protected
name|void
name|configureInactivityMonitor
parameter_list|(
name|String
name|heartBeatConfig
parameter_list|)
throws|throws
name|ProtocolException
block|{
name|String
index|[]
name|keepAliveOpts
init|=
name|heartBeatConfig
operator|.
name|split
argument_list|(
name|Stomp
operator|.
name|COMMA
argument_list|)
decl_stmt|;
if|if
condition|(
name|keepAliveOpts
operator|==
literal|null
operator|||
name|keepAliveOpts
operator|.
name|length
operator|!=
literal|2
condition|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid heart-beat header:"
operator|+
name|heartBeatConfig
argument_list|,
literal|true
argument_list|)
throw|;
block|}
else|else
block|{
try|try
block|{
name|hbReadInterval
operator|=
operator|(
name|Long
operator|.
name|parseLong
argument_list|(
name|keepAliveOpts
index|[
literal|0
index|]
argument_list|)
operator|)
expr_stmt|;
name|hbWriteInterval
operator|=
name|Long
operator|.
name|parseLong
argument_list|(
name|keepAliveOpts
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ProtocolException
argument_list|(
literal|"Invalid heart-beat header:"
operator|+
name|heartBeatConfig
argument_list|,
literal|true
argument_list|)
throw|;
block|}
try|try
block|{
name|StompInactivityMonitor
name|monitor
init|=
name|this
operator|.
name|stompTransport
operator|.
name|getInactivityMonitor
argument_list|()
decl_stmt|;
name|monitor
operator|.
name|setReadCheckTime
argument_list|(
call|(
name|long
call|)
argument_list|(
name|hbReadInterval
operator|*
name|hbGracePeriodMultiplier
argument_list|)
argument_list|)
expr_stmt|;
name|monitor
operator|.
name|setInitialDelayTime
argument_list|(
name|Math
operator|.
name|min
argument_list|(
name|hbReadInterval
argument_list|,
name|hbWriteInterval
argument_list|)
argument_list|)
expr_stmt|;
name|monitor
operator|.
name|setWriteCheckTime
argument_list|(
name|hbWriteInterval
argument_list|)
expr_stmt|;
name|monitor
operator|.
name|startMonitoring
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|hbReadInterval
operator|=
literal|0
expr_stmt|;
name|hbWriteInterval
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Stomp Connect heartbeat conf RW["
operator|+
name|hbReadInterval
operator|+
literal|","
operator|+
name|hbWriteInterval
operator|+
literal|"]"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|protected
name|void
name|sendReceipt
parameter_list|(
name|StompFrame
name|command
parameter_list|)
block|{
specifier|final
name|String
name|receiptId
init|=
name|command
operator|.
name|getHeaders
argument_list|()
operator|.
name|get
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|RECEIPT_REQUESTED
argument_list|)
decl_stmt|;
if|if
condition|(
name|receiptId
operator|!=
literal|null
condition|)
block|{
name|StompFrame
name|sc
init|=
operator|new
name|StompFrame
argument_list|()
decl_stmt|;
name|sc
operator|.
name|setAction
argument_list|(
name|Stomp
operator|.
name|Responses
operator|.
name|RECEIPT
argument_list|)
expr_stmt|;
name|sc
operator|.
name|setHeaders
argument_list|(
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|getHeaders
argument_list|()
operator|.
name|put
argument_list|(
name|Stomp
operator|.
name|Headers
operator|.
name|Response
operator|.
name|RECEIPT_ID
argument_list|,
name|receiptId
argument_list|)
expr_stmt|;
try|try
block|{
name|sendToStomp
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Could not send a receipt for "
operator|+
name|command
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

unit|}
end_unit

