begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  *   * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE  * file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file  * to You under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the  * License. You may obtain a copy of the License at  *   * http://www.apache.org/licenses/LICENSE-2.0  *   * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on  * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the  * specific language governing permissions and limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CountDownLatch
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicBoolean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|Service
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|ft
operator|.
name|MasterBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|ConnectionStatistics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|broker
operator|.
name|region
operator|.
name|RegionBroker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|BrokerInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|Command
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionControl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionError
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConnectionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConsumerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ConsumerInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|DataArrayResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|DestinationInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ExceptionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|FlushCommand
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|IntegerResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|KeepAliveInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessageAck
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessageDispatch
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessageDispatchNotification
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|MessagePull
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ProducerId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ProducerInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|RemoveSubscriptionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|Response
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|SessionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|SessionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|ShutdownInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|TransactionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|TransactionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|command
operator|.
name|WireFormatInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|security
operator|.
name|MessageAuthorizationPolicy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|state
operator|.
name|CommandVisitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|state
operator|.
name|ConsumerState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|state
operator|.
name|ProducerState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|state
operator|.
name|SessionState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|state
operator|.
name|TransactionState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|thread
operator|.
name|Task
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|thread
operator|.
name|TaskRunner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|thread
operator|.
name|TaskRunnerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|transport
operator|.
name|DefaultTransportListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|transport
operator|.
name|Transport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|util
operator|.
name|ServiceSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_comment
comment|/**  * @version $Revision: 1.8 $  */
end_comment

begin_class
specifier|public
class|class
name|TransportConnection
implements|implements
name|Service
implements|,
name|Connection
implements|,
name|Task
implements|,
name|CommandVisitor
block|{
specifier|private
specifier|static
specifier|final
name|Log
name|log
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TransportConnection
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Log
name|transportLog
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TransportConnection
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|".Transport"
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Log
name|serviceLog
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|TransportConnection
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|".Service"
argument_list|)
decl_stmt|;
comment|// Keeps track of the broker and connector that created this connection.
specifier|protected
specifier|final
name|Broker
name|broker
decl_stmt|;
specifier|private
name|MasterBroker
name|masterBroker
decl_stmt|;
specifier|protected
specifier|final
name|TransportConnector
name|connector
decl_stmt|;
specifier|private
specifier|final
name|Transport
name|transport
decl_stmt|;
specifier|private
name|MessageAuthorizationPolicy
name|messageAuthorizationPolicy
decl_stmt|;
comment|// Keeps track of the state of the connections.
specifier|protected
specifier|final
name|ConcurrentHashMap
name|localConnectionStates
init|=
operator|new
name|ConcurrentHashMap
argument_list|()
decl_stmt|;
specifier|protected
specifier|final
name|Map
name|brokerConnectionStates
decl_stmt|;
comment|// The broker and wireformat info that was exchanged.
specifier|protected
name|BrokerInfo
name|brokerInfo
decl_stmt|;
specifier|private
name|WireFormatInfo
name|wireFormatInfo
decl_stmt|;
comment|// Used to do async dispatch.. this should perhaps be pushed down into the transport layer..
specifier|protected
specifier|final
name|List
name|dispatchQueue
init|=
name|Collections
operator|.
name|synchronizedList
argument_list|(
operator|new
name|LinkedList
argument_list|()
argument_list|)
decl_stmt|;
specifier|protected
specifier|final
name|TaskRunner
name|taskRunner
decl_stmt|;
specifier|protected
name|IOException
name|transportException
decl_stmt|;
specifier|private
name|boolean
name|inServiceException
init|=
literal|false
decl_stmt|;
specifier|private
name|ConnectionStatistics
name|statistics
init|=
operator|new
name|ConnectionStatistics
argument_list|()
decl_stmt|;
specifier|private
name|boolean
name|manageable
decl_stmt|;
specifier|private
name|boolean
name|slow
decl_stmt|;
specifier|private
name|boolean
name|markedCandidate
decl_stmt|;
specifier|private
name|boolean
name|blockedCandidate
decl_stmt|;
specifier|private
name|boolean
name|blocked
decl_stmt|;
specifier|private
name|boolean
name|connected
decl_stmt|;
specifier|private
name|boolean
name|active
decl_stmt|;
specifier|private
name|boolean
name|starting
decl_stmt|;
specifier|private
name|boolean
name|pendingStop
decl_stmt|;
specifier|private
name|long
name|timeStamp
init|=
literal|0
decl_stmt|;
specifier|private
name|AtomicBoolean
name|stopped
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|disposed
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
name|CountDownLatch
name|stopLatch
init|=
operator|new
name|CountDownLatch
argument_list|(
literal|1
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|AtomicBoolean
name|asyncException
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|Map
argument_list|<
name|ProducerId
argument_list|,
name|ProducerBrokerExchange
argument_list|>
name|producerExchanges
init|=
operator|new
name|HashMap
argument_list|<
name|ProducerId
argument_list|,
name|ProducerBrokerExchange
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|Map
argument_list|<
name|ConsumerId
argument_list|,
name|ConsumerBrokerExchange
argument_list|>
name|consumerExchanges
init|=
operator|new
name|HashMap
argument_list|<
name|ConsumerId
argument_list|,
name|ConsumerBrokerExchange
argument_list|>
argument_list|()
decl_stmt|;
specifier|static
class|class
name|ConnectionState
extends|extends
name|org
operator|.
name|apache
operator|.
name|activemq
operator|.
name|state
operator|.
name|ConnectionState
block|{
specifier|private
specifier|final
name|ConnectionContext
name|context
decl_stmt|;
name|TransportConnection
name|connection
decl_stmt|;
specifier|public
name|ConnectionState
parameter_list|(
name|ConnectionInfo
name|info
parameter_list|,
name|ConnectionContext
name|context
parameter_list|,
name|TransportConnection
name|connection
parameter_list|)
block|{
name|super
argument_list|(
name|info
argument_list|)
expr_stmt|;
name|this
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|this
operator|.
name|connection
operator|=
name|connection
expr_stmt|;
block|}
specifier|public
name|ConnectionContext
name|getContext
parameter_list|()
block|{
return|return
name|context
return|;
block|}
specifier|public
name|TransportConnection
name|getConnection
parameter_list|()
block|{
return|return
name|connection
return|;
block|}
block|}
comment|/**      * @param connector      * @param transport      * @param broker      * @param taskRunnerFactory - can be null if you want direct dispatch to the transport else commands are sent async.      */
specifier|public
name|TransportConnection
parameter_list|(
name|TransportConnector
name|connector
parameter_list|,
specifier|final
name|Transport
name|transport
parameter_list|,
name|Broker
name|broker
parameter_list|,
name|TaskRunnerFactory
name|taskRunnerFactory
parameter_list|)
block|{
name|this
operator|.
name|connector
operator|=
name|connector
expr_stmt|;
name|this
operator|.
name|broker
operator|=
name|broker
expr_stmt|;
name|RegionBroker
name|rb
init|=
operator|(
name|RegionBroker
operator|)
name|broker
operator|.
name|getAdaptor
argument_list|(
name|RegionBroker
operator|.
name|class
argument_list|)
decl_stmt|;
name|brokerConnectionStates
operator|=
name|rb
operator|.
name|getConnectionStates
argument_list|()
expr_stmt|;
if|if
condition|(
name|connector
operator|!=
literal|null
condition|)
block|{
name|this
operator|.
name|statistics
operator|.
name|setParent
argument_list|(
name|connector
operator|.
name|getStatistics
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|taskRunnerFactory
operator|!=
literal|null
condition|)
block|{
name|taskRunner
operator|=
name|taskRunnerFactory
operator|.
name|createTaskRunner
argument_list|(
name|this
argument_list|,
literal|"ActiveMQ Connection Dispatcher: "
operator|+
name|System
operator|.
name|identityHashCode
argument_list|(
name|this
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|taskRunner
operator|=
literal|null
expr_stmt|;
block|}
name|connector
operator|.
name|setBrokerName
argument_list|(
name|broker
operator|.
name|getBrokerName
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|transport
operator|=
name|transport
expr_stmt|;
name|this
operator|.
name|transport
operator|.
name|setTransportListener
argument_list|(
operator|new
name|DefaultTransportListener
argument_list|()
block|{
specifier|public
name|void
name|onCommand
parameter_list|(
name|Object
name|o
parameter_list|)
block|{
name|Command
name|command
init|=
operator|(
name|Command
operator|)
name|o
decl_stmt|;
name|Response
name|response
init|=
name|service
argument_list|(
name|command
argument_list|)
decl_stmt|;
if|if
condition|(
name|response
operator|!=
literal|null
condition|)
block|{
name|dispatch
argument_list|(
name|response
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|onException
parameter_list|(
name|IOException
name|exception
parameter_list|)
block|{
name|serviceTransportException
argument_list|(
name|exception
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
name|connected
operator|=
literal|true
expr_stmt|;
block|}
comment|/**      * Returns the number of messages to be dispatched to this connection      */
specifier|public
name|int
name|getDispatchQueueSize
parameter_list|()
block|{
return|return
name|dispatchQueue
operator|.
name|size
argument_list|()
return|;
block|}
specifier|public
name|void
name|serviceTransportException
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
if|if
condition|(
operator|!
name|disposed
operator|.
name|get
argument_list|()
condition|)
block|{
name|transportException
operator|=
name|e
expr_stmt|;
if|if
condition|(
name|transportLog
operator|.
name|isDebugEnabled
argument_list|()
condition|)
name|transportLog
operator|.
name|debug
argument_list|(
literal|"Transport failed: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|ServiceSupport
operator|.
name|dispose
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * Calls the serviceException method in an async thread. Since handling a service exception closes a socket, we      * should not tie up broker threads since client sockets may hang or cause deadlocks.      *       * @param e      */
specifier|public
name|void
name|serviceExceptionAsync
parameter_list|(
specifier|final
name|IOException
name|e
parameter_list|)
block|{
if|if
condition|(
name|asyncException
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
operator|new
name|Thread
argument_list|(
literal|"Async Exception Handler"
argument_list|)
block|{
specifier|public
name|void
name|run
parameter_list|()
block|{
name|serviceException
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
block|}
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Closes a clients connection due to a detected error.      *       * Errors are ignored if: the client is closing or broker is closing. Otherwise, the connection error transmitted to      * the client before stopping it's transport.      */
specifier|public
name|void
name|serviceException
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
comment|// are we a transport exception such as not being able to dispatch
comment|// synchronously to a transport
if|if
condition|(
name|e
operator|instanceof
name|IOException
condition|)
block|{
name|serviceTransportException
argument_list|(
operator|(
name|IOException
operator|)
name|e
argument_list|)
expr_stmt|;
block|}
comment|// Handle the case where the broker is stopped
comment|// But the client is still connected.
elseif|else
if|if
condition|(
name|e
operator|.
name|getClass
argument_list|()
operator|==
name|BrokerStoppedException
operator|.
name|class
condition|)
block|{
if|if
condition|(
operator|!
name|disposed
operator|.
name|get
argument_list|()
condition|)
block|{
if|if
condition|(
name|serviceLog
operator|.
name|isDebugEnabled
argument_list|()
condition|)
name|serviceLog
operator|.
name|debug
argument_list|(
literal|"Broker has been stopped.  Notifying client and closing his connection."
argument_list|)
expr_stmt|;
name|ConnectionError
name|ce
init|=
operator|new
name|ConnectionError
argument_list|()
decl_stmt|;
name|ce
operator|.
name|setException
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|dispatchSync
argument_list|(
name|ce
argument_list|)
expr_stmt|;
comment|// Wait a little bit to try to get the output buffer to flush the exption notification to the client.
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
comment|// Worst case is we just kill the connection before the notification gets to him.
name|ServiceSupport
operator|.
name|dispose
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|disposed
operator|.
name|get
argument_list|()
operator|&&
operator|!
name|inServiceException
condition|)
block|{
name|inServiceException
operator|=
literal|true
expr_stmt|;
try|try
block|{
name|serviceLog
operator|.
name|error
argument_list|(
literal|"Async error occurred: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|ConnectionError
name|ce
init|=
operator|new
name|ConnectionError
argument_list|()
decl_stmt|;
name|ce
operator|.
name|setException
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|dispatchAsync
argument_list|(
name|ce
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|inServiceException
operator|=
literal|false
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|Response
name|service
parameter_list|(
name|Command
name|command
parameter_list|)
block|{
name|Response
name|response
init|=
literal|null
decl_stmt|;
name|boolean
name|responseRequired
init|=
name|command
operator|.
name|isResponseRequired
argument_list|()
decl_stmt|;
name|int
name|commandId
init|=
name|command
operator|.
name|getCommandId
argument_list|()
decl_stmt|;
try|try
block|{
name|response
operator|=
name|command
operator|.
name|visit
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
if|if
condition|(
name|responseRequired
condition|)
block|{
if|if
condition|(
name|serviceLog
operator|.
name|isDebugEnabled
argument_list|()
operator|&&
name|e
operator|.
name|getClass
argument_list|()
operator|!=
name|BrokerStoppedException
operator|.
name|class
condition|)
name|serviceLog
operator|.
name|debug
argument_list|(
literal|"Error occured while processing sync command: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|response
operator|=
operator|new
name|ExceptionResponse
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|serviceException
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|responseRequired
condition|)
block|{
if|if
condition|(
name|response
operator|==
literal|null
condition|)
block|{
name|response
operator|=
operator|new
name|Response
argument_list|()
expr_stmt|;
block|}
name|response
operator|.
name|setCorrelationId
argument_list|(
name|commandId
argument_list|)
expr_stmt|;
block|}
return|return
name|response
return|;
block|}
specifier|protected
name|ConnectionState
name|lookupConnectionState
parameter_list|(
name|ConsumerId
name|id
parameter_list|)
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|id
operator|.
name|getParentId
argument_list|()
operator|.
name|getParentId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot lookup a consumer from a connection that had not been registered: "
operator|+
name|id
operator|.
name|getParentId
argument_list|()
operator|.
name|getParentId
argument_list|()
argument_list|)
throw|;
return|return
name|cs
return|;
block|}
specifier|protected
name|ConnectionState
name|lookupConnectionState
parameter_list|(
name|ProducerId
name|id
parameter_list|)
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|id
operator|.
name|getParentId
argument_list|()
operator|.
name|getParentId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot lookup a producer from a connection that had not been registered: "
operator|+
name|id
operator|.
name|getParentId
argument_list|()
operator|.
name|getParentId
argument_list|()
argument_list|)
throw|;
return|return
name|cs
return|;
block|}
specifier|protected
name|ConnectionState
name|lookupConnectionState
parameter_list|(
name|SessionId
name|id
parameter_list|)
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|id
operator|.
name|getParentId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot lookup a session from a connection that had not been registered: "
operator|+
name|id
operator|.
name|getParentId
argument_list|()
argument_list|)
throw|;
return|return
name|cs
return|;
block|}
specifier|protected
name|ConnectionState
name|lookupConnectionState
parameter_list|(
name|ConnectionId
name|connectionId
parameter_list|)
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot lookup a connection that had not been registered: "
operator|+
name|connectionId
argument_list|)
throw|;
return|return
name|cs
return|;
block|}
specifier|public
name|Response
name|processKeepAlive
parameter_list|(
name|KeepAliveInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
return|return
literal|null
return|;
block|}
specifier|public
name|Response
name|processRemoveSubscription
parameter_list|(
name|RemoveSubscriptionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|broker
operator|.
name|removeSubscription
argument_list|(
name|lookupConnectionState
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|public
name|Response
name|processWireFormat
parameter_list|(
name|WireFormatInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|wireFormatInfo
operator|=
name|info
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|public
name|Response
name|processShutdown
parameter_list|(
name|ShutdownInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|stop
argument_list|()
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|public
name|Response
name|processFlush
parameter_list|(
name|FlushCommand
name|command
parameter_list|)
throws|throws
name|Exception
block|{
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processBeginTransaction
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
comment|// Avoid replaying dup commands
if|if
condition|(
name|cs
operator|.
name|getTransactionState
argument_list|(
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
operator|==
literal|null
condition|)
block|{
name|cs
operator|.
name|addTransactionState
argument_list|(
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|beginTransaction
argument_list|(
name|context
argument_list|,
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processEndTransaction
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
comment|// No need to do anything. This packet is just sent by the client
comment|// make sure he is synced with the server as commit command could
comment|// come from a different connection.
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processPrepareTransaction
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
name|TransactionState
name|transactionState
init|=
name|cs
operator|.
name|getTransactionState
argument_list|(
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|transactionState
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot prepare a transaction that had not been started: "
operator|+
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
throw|;
comment|// Avoid dups.
if|if
condition|(
operator|!
name|transactionState
operator|.
name|isPrepared
argument_list|()
condition|)
block|{
name|transactionState
operator|.
name|setPrepared
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|int
name|result
init|=
name|broker
operator|.
name|prepareTransaction
argument_list|(
name|context
argument_list|,
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
decl_stmt|;
name|transactionState
operator|.
name|setPreparedResult
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|IntegerResponse
name|response
init|=
operator|new
name|IntegerResponse
argument_list|(
name|result
argument_list|)
decl_stmt|;
return|return
name|response
return|;
block|}
else|else
block|{
name|IntegerResponse
name|response
init|=
operator|new
name|IntegerResponse
argument_list|(
name|transactionState
operator|.
name|getPreparedResult
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|response
return|;
block|}
block|}
specifier|synchronized
specifier|public
name|Response
name|processCommitTransactionOnePhase
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
name|cs
operator|.
name|removeTransactionState
argument_list|(
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|commitTransaction
argument_list|(
name|context
argument_list|,
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processCommitTransactionTwoPhase
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
name|cs
operator|.
name|removeTransactionState
argument_list|(
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|commitTransaction
argument_list|(
name|context
argument_list|,
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRollbackTransaction
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
name|cs
operator|.
name|removeTransactionState
argument_list|(
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
name|broker
operator|.
name|rollbackTransaction
argument_list|(
name|context
argument_list|,
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processForgetTransaction
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
name|broker
operator|.
name|forgetTransaction
argument_list|(
name|context
argument_list|,
name|info
operator|.
name|getTransactionId
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRecoverTransactions
parameter_list|(
name|TransactionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|context
operator|=
name|cs
operator|.
name|getContext
argument_list|()
expr_stmt|;
block|}
name|TransactionId
index|[]
name|preparedTransactions
init|=
name|broker
operator|.
name|getPreparedTransactions
argument_list|(
name|context
argument_list|)
decl_stmt|;
return|return
operator|new
name|DataArrayResponse
argument_list|(
name|preparedTransactions
argument_list|)
return|;
block|}
specifier|public
name|Response
name|processMessage
parameter_list|(
name|Message
name|messageSend
parameter_list|)
throws|throws
name|Exception
block|{
name|ProducerId
name|producerId
init|=
name|messageSend
operator|.
name|getProducerId
argument_list|()
decl_stmt|;
name|ProducerBrokerExchange
name|producerExchange
init|=
name|getProducerBrokerExchange
argument_list|(
name|producerId
argument_list|)
decl_stmt|;
name|ProducerState
name|producerState
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|messageSend
operator|.
name|getMessageId
argument_list|()
operator|.
name|getProducerId
argument_list|()
operator|.
name|equals
argument_list|(
name|messageSend
operator|.
name|getProducerId
argument_list|()
argument_list|)
condition|)
block|{
name|producerState
operator|=
name|producerExchange
operator|.
name|getProducerState
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|producerState
operator|!=
literal|null
condition|)
block|{
name|long
name|seq
init|=
name|messageSend
operator|.
name|getMessageId
argument_list|()
operator|.
name|getProducerSequenceId
argument_list|()
decl_stmt|;
if|if
condition|(
name|seq
operator|>
name|producerState
operator|.
name|getLastSequenceId
argument_list|()
condition|)
block|{
name|producerState
operator|.
name|setLastSequenceId
argument_list|(
name|seq
argument_list|)
expr_stmt|;
name|broker
operator|.
name|send
argument_list|(
name|producerExchange
argument_list|,
name|messageSend
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// producer not local to this broker
name|broker
operator|.
name|send
argument_list|(
name|producerExchange
argument_list|,
name|messageSend
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
specifier|public
name|Response
name|processMessageAck
parameter_list|(
name|MessageAck
name|ack
parameter_list|)
throws|throws
name|Exception
block|{
name|ConsumerBrokerExchange
name|consumerExchange
init|=
name|getConsumerBrokerExchange
argument_list|(
name|ack
operator|.
name|getConsumerId
argument_list|()
argument_list|)
decl_stmt|;
name|broker
operator|.
name|acknowledge
argument_list|(
name|consumerExchange
argument_list|,
name|ack
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|public
name|Response
name|processMessagePull
parameter_list|(
name|MessagePull
name|pull
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|broker
operator|.
name|messagePull
argument_list|(
name|lookupConnectionState
argument_list|(
name|pull
operator|.
name|getConsumerId
argument_list|()
argument_list|)
operator|.
name|getContext
argument_list|()
argument_list|,
name|pull
argument_list|)
return|;
block|}
specifier|public
name|Response
name|processMessageDispatchNotification
parameter_list|(
name|MessageDispatchNotification
name|notification
parameter_list|)
throws|throws
name|Exception
block|{
name|broker
operator|.
name|processDispatchNotification
argument_list|(
name|notification
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processAddDestination
parameter_list|(
name|DestinationInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|broker
operator|.
name|addDestinationInfo
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|.
name|getDestination
argument_list|()
operator|.
name|isTemporary
argument_list|()
condition|)
block|{
name|cs
operator|.
name|addTempDestination
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRemoveDestination
parameter_list|(
name|DestinationInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
name|broker
operator|.
name|removeDestinationInfo
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|.
name|getDestination
argument_list|()
operator|.
name|isTemporary
argument_list|()
condition|)
block|{
name|cs
operator|.
name|removeTempDestination
argument_list|(
name|info
operator|.
name|getDestination
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processAddProducer
parameter_list|(
name|ProducerInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|SessionId
name|sessionId
init|=
name|info
operator|.
name|getProducerId
argument_list|()
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionId
name|connectionId
init|=
name|sessionId
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
name|SessionState
name|ss
init|=
name|cs
operator|.
name|getSessionState
argument_list|(
name|sessionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|ss
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot add a producer to a session that had not been registered: "
operator|+
name|sessionId
argument_list|)
throw|;
comment|// Avoid replaying dup commands
if|if
condition|(
operator|!
name|ss
operator|.
name|getProducerIds
argument_list|()
operator|.
name|contains
argument_list|(
name|info
operator|.
name|getProducerId
argument_list|()
argument_list|)
condition|)
block|{
name|broker
operator|.
name|addProducer
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
try|try
block|{
name|ss
operator|.
name|addProducer
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalStateException
name|e
parameter_list|)
block|{
name|broker
operator|.
name|removeProducer
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRemoveProducer
parameter_list|(
name|ProducerId
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|SessionId
name|sessionId
init|=
name|id
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionId
name|connectionId
init|=
name|sessionId
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
name|SessionState
name|ss
init|=
name|cs
operator|.
name|getSessionState
argument_list|(
name|sessionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|ss
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot remove a producer from a session that had not been registered: "
operator|+
name|sessionId
argument_list|)
throw|;
name|ProducerState
name|ps
init|=
name|ss
operator|.
name|removeProducer
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|ps
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot remove a producer that had not been registered: "
operator|+
name|id
argument_list|)
throw|;
name|removeProducerBrokerExchange
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|broker
operator|.
name|removeProducer
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|ps
operator|.
name|getInfo
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processAddConsumer
parameter_list|(
name|ConsumerInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|SessionId
name|sessionId
init|=
name|info
operator|.
name|getConsumerId
argument_list|()
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionId
name|connectionId
init|=
name|sessionId
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
name|SessionState
name|ss
init|=
name|cs
operator|.
name|getSessionState
argument_list|(
name|sessionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|ss
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot add a consumer to a session that had not been registered: "
operator|+
name|sessionId
argument_list|)
throw|;
comment|// Avoid replaying dup commands
if|if
condition|(
operator|!
name|ss
operator|.
name|getConsumerIds
argument_list|()
operator|.
name|contains
argument_list|(
name|info
operator|.
name|getConsumerId
argument_list|()
argument_list|)
condition|)
block|{
name|broker
operator|.
name|addConsumer
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
try|try
block|{
name|ss
operator|.
name|addConsumer
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalStateException
name|e
parameter_list|)
block|{
name|broker
operator|.
name|removeConsumer
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRemoveConsumer
parameter_list|(
name|ConsumerId
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|SessionId
name|sessionId
init|=
name|id
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionId
name|connectionId
init|=
name|sessionId
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
name|SessionState
name|ss
init|=
name|cs
operator|.
name|getSessionState
argument_list|(
name|sessionId
argument_list|)
decl_stmt|;
if|if
condition|(
name|ss
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot remove a consumer from a session that had not been registered: "
operator|+
name|sessionId
argument_list|)
throw|;
name|ConsumerState
name|consumerState
init|=
name|ss
operator|.
name|removeConsumer
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|consumerState
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot remove a consumer that had not been registered: "
operator|+
name|id
argument_list|)
throw|;
name|broker
operator|.
name|removeConsumer
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|consumerState
operator|.
name|getInfo
argument_list|()
argument_list|)
expr_stmt|;
name|removeConsumerBrokerExchange
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processAddSession
parameter_list|(
name|SessionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionId
name|connectionId
init|=
name|info
operator|.
name|getSessionId
argument_list|()
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
comment|// Avoid replaying dup commands
if|if
condition|(
operator|!
name|cs
operator|.
name|getSessionIds
argument_list|()
operator|.
name|contains
argument_list|(
name|info
operator|.
name|getSessionId
argument_list|()
argument_list|)
condition|)
block|{
name|broker
operator|.
name|addSession
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
try|try
block|{
name|cs
operator|.
name|addSession
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalStateException
name|e
parameter_list|)
block|{
name|broker
operator|.
name|removeSession
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRemoveSession
parameter_list|(
name|SessionId
name|id
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionId
name|connectionId
init|=
name|id
operator|.
name|getParentId
argument_list|()
decl_stmt|;
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|connectionId
argument_list|)
decl_stmt|;
name|SessionState
name|session
init|=
name|cs
operator|.
name|getSessionState
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|session
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"Cannot remove session that had not been registered: "
operator|+
name|id
argument_list|)
throw|;
comment|// Don't let new consumers or producers get added while we are closing this down.
name|session
operator|.
name|shutdown
argument_list|()
expr_stmt|;
comment|// Cascade the connection stop to the consumers and producers.
for|for
control|(
name|Iterator
name|iter
init|=
name|session
operator|.
name|getConsumerIds
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|ConsumerId
name|consumerId
init|=
operator|(
name|ConsumerId
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
try|try
block|{
name|processRemoveConsumer
argument_list|(
name|consumerId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Failed to remove consumer: "
operator|+
name|consumerId
operator|+
literal|". Reason: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|Iterator
name|iter
init|=
name|session
operator|.
name|getProducerIds
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|ProducerId
name|producerId
init|=
operator|(
name|ProducerId
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
try|try
block|{
name|processRemoveProducer
argument_list|(
name|producerId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Failed to remove producer: "
operator|+
name|producerId
operator|+
literal|". Reason: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|cs
operator|.
name|removeSession
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|broker
operator|.
name|removeSession
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|session
operator|.
name|getInfo
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processAddConnection
parameter_list|(
name|ConnectionInfo
name|info
parameter_list|)
throws|throws
name|Exception
block|{
name|ConnectionState
name|state
init|=
operator|(
name|ConnectionState
operator|)
name|brokerConnectionStates
operator|.
name|get
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|state
operator|!=
literal|null
condition|)
block|{
comment|// ConnectionInfo replay?? Chances are that it's a client reconnecting,
comment|// and we have not detected that that old connection died.. Kill the old connection
comment|// to make sure our state is in sync with the client.
if|if
condition|(
name|this
operator|!=
name|state
operator|.
name|getConnection
argument_list|()
condition|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"Killing previous stale connection: "
operator|+
name|state
operator|.
name|getConnection
argument_list|()
argument_list|)
expr_stmt|;
name|state
operator|.
name|getConnection
argument_list|()
operator|.
name|stop
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|state
operator|.
name|getConnection
argument_list|()
operator|.
name|stopLatch
operator|.
name|await
argument_list|(
literal|15
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|Exception
argument_list|(
literal|"Previous connection could not be clean up."
argument_list|)
throw|;
block|}
block|}
block|}
name|log
operator|.
name|debug
argument_list|(
literal|"Setting up new connection: "
operator|+
name|this
argument_list|)
expr_stmt|;
comment|// Setup the context.
name|String
name|clientId
init|=
name|info
operator|.
name|getClientId
argument_list|()
decl_stmt|;
name|ConnectionContext
name|context
init|=
operator|new
name|ConnectionContext
argument_list|()
decl_stmt|;
name|context
operator|.
name|setConnection
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|context
operator|.
name|setBroker
argument_list|(
name|broker
argument_list|)
expr_stmt|;
name|context
operator|.
name|setConnector
argument_list|(
name|connector
argument_list|)
expr_stmt|;
name|context
operator|.
name|setTransactions
argument_list|(
operator|new
name|ConcurrentHashMap
argument_list|()
argument_list|)
expr_stmt|;
name|context
operator|.
name|setClientId
argument_list|(
name|clientId
argument_list|)
expr_stmt|;
name|context
operator|.
name|setUserName
argument_list|(
name|info
operator|.
name|getUserName
argument_list|()
argument_list|)
expr_stmt|;
name|context
operator|.
name|setConnectionId
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|)
expr_stmt|;
name|context
operator|.
name|setWireFormatInfo
argument_list|(
name|wireFormatInfo
argument_list|)
expr_stmt|;
name|context
operator|.
name|incrementReference
argument_list|()
expr_stmt|;
name|this
operator|.
name|manageable
operator|=
name|info
operator|.
name|isManageable
argument_list|()
expr_stmt|;
name|state
operator|=
operator|new
name|ConnectionState
argument_list|(
name|info
argument_list|,
name|context
argument_list|,
name|this
argument_list|)
expr_stmt|;
name|brokerConnectionStates
operator|.
name|put
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|localConnectionStates
operator|.
name|put
argument_list|(
name|info
operator|.
name|getConnectionId
argument_list|()
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|broker
operator|.
name|addConnection
argument_list|(
name|context
argument_list|,
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|.
name|isManageable
argument_list|()
operator|&&
name|broker
operator|.
name|isFaultTolerantConfiguration
argument_list|()
condition|)
block|{
comment|// send ConnectionCommand
name|ConnectionControl
name|command
init|=
operator|new
name|ConnectionControl
argument_list|()
decl_stmt|;
name|command
operator|.
name|setFaultTolerant
argument_list|(
name|broker
operator|.
name|isFaultTolerantConfiguration
argument_list|()
argument_list|)
expr_stmt|;
name|dispatchAsync
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
specifier|synchronized
specifier|public
name|Response
name|processRemoveConnection
parameter_list|(
name|ConnectionId
name|id
parameter_list|)
block|{
name|ConnectionState
name|cs
init|=
name|lookupConnectionState
argument_list|(
name|id
argument_list|)
decl_stmt|;
comment|// Don't allow things to be added to the connection state while we are shutting down.
name|cs
operator|.
name|shutdown
argument_list|()
expr_stmt|;
comment|// Cascade the connection stop to the sessions.
for|for
control|(
name|Iterator
name|iter
init|=
name|cs
operator|.
name|getSessionIds
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|SessionId
name|sessionId
init|=
operator|(
name|SessionId
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
try|try
block|{
name|processRemoveSession
argument_list|(
name|sessionId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|serviceLog
operator|.
name|warn
argument_list|(
literal|"Failed to remove session "
operator|+
name|sessionId
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Cascade the connection stop to temp destinations.
for|for
control|(
name|Iterator
name|iter
init|=
name|cs
operator|.
name|getTempDesinations
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|DestinationInfo
name|di
init|=
operator|(
name|DestinationInfo
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
try|try
block|{
name|broker
operator|.
name|removeDestination
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|di
operator|.
name|getDestination
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|serviceLog
operator|.
name|warn
argument_list|(
literal|"Failed to remove tmp destination "
operator|+
name|di
operator|.
name|getDestination
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
name|iter
operator|.
name|remove
argument_list|()
expr_stmt|;
block|}
try|try
block|{
name|broker
operator|.
name|removeConnection
argument_list|(
name|cs
operator|.
name|getContext
argument_list|()
argument_list|,
name|cs
operator|.
name|getInfo
argument_list|()
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|serviceLog
operator|.
name|warn
argument_list|(
literal|"Failed to remove connection "
operator|+
name|cs
operator|.
name|getInfo
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
name|ConnectionState
name|state
init|=
operator|(
name|ConnectionState
operator|)
name|localConnectionStates
operator|.
name|remove
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|state
operator|!=
literal|null
condition|)
block|{
comment|// If we are the last reference, we should remove the state
comment|// from the broker.
if|if
condition|(
name|state
operator|.
name|getContext
argument_list|()
operator|.
name|decrementReference
argument_list|()
operator|==
literal|0
condition|)
block|{
name|brokerConnectionStates
operator|.
name|remove
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|null
return|;
block|}
specifier|public
name|Connector
name|getConnector
parameter_list|()
block|{
return|return
name|connector
return|;
block|}
specifier|public
name|void
name|dispatchSync
parameter_list|(
name|Command
name|message
parameter_list|)
block|{
name|processDispatch
argument_list|(
name|message
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|dispatchAsync
parameter_list|(
name|Command
name|message
parameter_list|)
block|{
if|if
condition|(
name|taskRunner
operator|==
literal|null
condition|)
block|{
name|dispatchSync
argument_list|(
name|message
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dispatchQueue
operator|.
name|add
argument_list|(
name|message
argument_list|)
expr_stmt|;
try|try
block|{
name|taskRunner
operator|.
name|wakeup
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
block|}
block|}
specifier|protected
name|void
name|processDispatch
parameter_list|(
name|Command
name|command
parameter_list|)
block|{
if|if
condition|(
name|command
operator|.
name|isMessageDispatch
argument_list|()
condition|)
block|{
name|MessageDispatch
name|md
init|=
operator|(
name|MessageDispatch
operator|)
name|command
decl_stmt|;
name|Runnable
name|sub
init|=
operator|(
name|Runnable
operator|)
name|md
operator|.
name|getConsumer
argument_list|()
decl_stmt|;
name|broker
operator|.
name|processDispatch
argument_list|(
name|md
argument_list|)
expr_stmt|;
try|try
block|{
name|dispatch
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|sub
operator|!=
literal|null
condition|)
block|{
name|sub
operator|.
name|run
argument_list|()
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|dispatch
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|boolean
name|iterate
parameter_list|()
block|{
if|if
condition|(
name|dispatchQueue
operator|.
name|isEmpty
argument_list|()
operator|||
name|broker
operator|.
name|isStopped
argument_list|()
condition|)
block|{
return|return
literal|false
return|;
block|}
else|else
block|{
name|Command
name|command
init|=
operator|(
name|Command
operator|)
name|dispatchQueue
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|processDispatch
argument_list|(
name|command
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
comment|/**      * Returns the statistics for this connection      */
specifier|public
name|ConnectionStatistics
name|getStatistics
parameter_list|()
block|{
return|return
name|statistics
return|;
block|}
specifier|public
name|MessageAuthorizationPolicy
name|getMessageAuthorizationPolicy
parameter_list|()
block|{
return|return
name|messageAuthorizationPolicy
return|;
block|}
specifier|public
name|void
name|setMessageAuthorizationPolicy
parameter_list|(
name|MessageAuthorizationPolicy
name|messageAuthorizationPolicy
parameter_list|)
block|{
name|this
operator|.
name|messageAuthorizationPolicy
operator|=
name|messageAuthorizationPolicy
expr_stmt|;
block|}
specifier|public
name|boolean
name|isManageable
parameter_list|()
block|{
return|return
name|manageable
return|;
block|}
specifier|public
specifier|synchronized
name|void
name|start
parameter_list|()
throws|throws
name|Exception
block|{
name|starting
operator|=
literal|true
expr_stmt|;
try|try
block|{
name|transport
operator|.
name|start
argument_list|()
expr_stmt|;
name|active
operator|=
literal|true
expr_stmt|;
name|this
operator|.
name|processDispatch
argument_list|(
name|connector
operator|.
name|getBrokerInfo
argument_list|()
argument_list|)
expr_stmt|;
name|connector
operator|.
name|onStarted
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
comment|// stop() can be called from within the above block,
comment|// but we want to be sure start() completes before
comment|// stop() runs, so queue the stop until right now:
name|starting
operator|=
literal|false
expr_stmt|;
if|if
condition|(
name|pendingStop
condition|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"Calling the delayed stop()"
argument_list|)
expr_stmt|;
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|void
name|stop
parameter_list|()
throws|throws
name|Exception
block|{
comment|// If we're in the middle of starting
comment|// then go no further... for now.
synchronized|synchronized
init|(
name|this
init|)
block|{
name|pendingStop
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|starting
condition|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"stop() called in the middle of start(). Delaying..."
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|stopped
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"Stopping connection: "
operator|+
name|transport
operator|.
name|getRemoteAddress
argument_list|()
argument_list|)
expr_stmt|;
name|connector
operator|.
name|onStopped
argument_list|(
name|this
argument_list|)
expr_stmt|;
try|try
block|{
if|if
condition|(
name|masterBroker
operator|!=
literal|null
condition|)
block|{
name|masterBroker
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
comment|// If the transport has not failed yet,
comment|// notify the peer that we are doing a normal shutdown.
if|if
condition|(
name|transportException
operator|==
literal|null
condition|)
block|{
name|transport
operator|.
name|oneway
argument_list|(
operator|new
name|ShutdownInfo
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|ignore
parameter_list|)
block|{
comment|// ignore.printStackTrace();
block|}
name|transport
operator|.
name|stop
argument_list|()
expr_stmt|;
name|active
operator|=
literal|false
expr_stmt|;
if|if
condition|(
name|disposed
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
if|if
condition|(
name|taskRunner
operator|!=
literal|null
condition|)
name|taskRunner
operator|.
name|shutdown
argument_list|()
expr_stmt|;
comment|// Clear out the dispatch queue to release any memory that
comment|// is being held on to.
name|dispatchQueue
operator|.
name|clear
argument_list|()
expr_stmt|;
comment|//
comment|// Remove all logical connection associated with this connection
comment|// from the broker.
if|if
condition|(
operator|!
name|broker
operator|.
name|isStopped
argument_list|()
condition|)
block|{
name|ArrayList
name|l
init|=
operator|new
name|ArrayList
argument_list|(
name|localConnectionStates
operator|.
name|keySet
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|Iterator
name|iter
init|=
name|l
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|ConnectionId
name|connectionId
init|=
operator|(
name|ConnectionId
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
try|try
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"Cleaning up connection resources."
argument_list|)
expr_stmt|;
name|processRemoveConnection
argument_list|(
name|connectionId
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|ignore
parameter_list|)
block|{
name|ignore
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|brokerInfo
operator|!=
literal|null
condition|)
block|{
name|broker
operator|.
name|removeBroker
argument_list|(
name|this
argument_list|,
name|brokerInfo
argument_list|)
expr_stmt|;
block|}
block|}
name|stopLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
name|log
operator|.
name|debug
argument_list|(
literal|"Stopped connection: "
operator|+
name|transport
operator|.
name|getRemoteAddress
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * @return Returns the blockedCandidate.      */
specifier|public
name|boolean
name|isBlockedCandidate
parameter_list|()
block|{
return|return
name|blockedCandidate
return|;
block|}
comment|/**      * @param blockedCandidate The blockedCandidate to set.      */
specifier|public
name|void
name|setBlockedCandidate
parameter_list|(
name|boolean
name|blockedCandidate
parameter_list|)
block|{
name|this
operator|.
name|blockedCandidate
operator|=
name|blockedCandidate
expr_stmt|;
block|}
comment|/**      * @return Returns the markedCandidate.      */
specifier|public
name|boolean
name|isMarkedCandidate
parameter_list|()
block|{
return|return
name|markedCandidate
return|;
block|}
comment|/**      * @param markedCandidate The markedCandidate to set.      */
specifier|public
name|void
name|setMarkedCandidate
parameter_list|(
name|boolean
name|markedCandidate
parameter_list|)
block|{
name|this
operator|.
name|markedCandidate
operator|=
name|markedCandidate
expr_stmt|;
if|if
condition|(
operator|!
name|markedCandidate
condition|)
block|{
name|timeStamp
operator|=
literal|0
expr_stmt|;
name|blockedCandidate
operator|=
literal|false
expr_stmt|;
block|}
block|}
comment|/**      * @param slow The slow to set.      */
specifier|public
name|void
name|setSlow
parameter_list|(
name|boolean
name|slow
parameter_list|)
block|{
name|this
operator|.
name|slow
operator|=
name|slow
expr_stmt|;
block|}
comment|/**      * @return true if the Connection is slow      */
specifier|public
name|boolean
name|isSlow
parameter_list|()
block|{
return|return
name|slow
return|;
block|}
comment|/**      * @return true if the Connection is potentially blocked      */
specifier|public
name|boolean
name|isMarkedBlockedCandidate
parameter_list|()
block|{
return|return
name|markedCandidate
return|;
block|}
comment|/**      * Mark the Connection, so we can deem if it's collectable on the next sweep      */
specifier|public
name|void
name|doMark
parameter_list|()
block|{
if|if
condition|(
name|timeStamp
operator|==
literal|0
condition|)
block|{
name|timeStamp
operator|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * @return if after being marked, the Connection is still writing      */
specifier|public
name|boolean
name|isBlocked
parameter_list|()
block|{
return|return
name|blocked
return|;
block|}
comment|/**      * @return true if the Connection is connected      */
specifier|public
name|boolean
name|isConnected
parameter_list|()
block|{
return|return
name|connected
return|;
block|}
comment|/**      * @param blocked The blocked to set.      */
specifier|public
name|void
name|setBlocked
parameter_list|(
name|boolean
name|blocked
parameter_list|)
block|{
name|this
operator|.
name|blocked
operator|=
name|blocked
expr_stmt|;
block|}
comment|/**      * @param connected The connected to set.      */
specifier|public
name|void
name|setConnected
parameter_list|(
name|boolean
name|connected
parameter_list|)
block|{
name|this
operator|.
name|connected
operator|=
name|connected
expr_stmt|;
block|}
comment|/**      * @return true if the Connection is active      */
specifier|public
name|boolean
name|isActive
parameter_list|()
block|{
return|return
name|active
return|;
block|}
comment|/**      * @param active The active to set.      */
specifier|public
name|void
name|setActive
parameter_list|(
name|boolean
name|active
parameter_list|)
block|{
name|this
operator|.
name|active
operator|=
name|active
expr_stmt|;
block|}
comment|/**      * @return true if the Connection is starting      */
specifier|public
specifier|synchronized
name|boolean
name|isStarting
parameter_list|()
block|{
return|return
name|starting
return|;
block|}
specifier|synchronized
specifier|protected
name|void
name|setStarting
parameter_list|(
name|boolean
name|starting
parameter_list|)
block|{
name|this
operator|.
name|starting
operator|=
name|starting
expr_stmt|;
block|}
comment|/**      * @return true if the Connection needs to stop      */
specifier|public
specifier|synchronized
name|boolean
name|isPendingStop
parameter_list|()
block|{
return|return
name|pendingStop
return|;
block|}
specifier|protected
specifier|synchronized
name|void
name|setPendingStop
parameter_list|(
name|boolean
name|pendingStop
parameter_list|)
block|{
name|this
operator|.
name|pendingStop
operator|=
name|pendingStop
expr_stmt|;
block|}
specifier|public
name|Response
name|processBrokerInfo
parameter_list|(
name|BrokerInfo
name|info
parameter_list|)
block|{
if|if
condition|(
name|info
operator|.
name|isSlaveBroker
argument_list|()
condition|)
block|{
comment|// stream messages from this broker (the master) to
comment|// the slave
name|MutableBrokerFilter
name|parent
init|=
operator|(
name|MutableBrokerFilter
operator|)
name|broker
operator|.
name|getAdaptor
argument_list|(
name|MutableBrokerFilter
operator|.
name|class
argument_list|)
decl_stmt|;
name|masterBroker
operator|=
operator|new
name|MasterBroker
argument_list|(
name|parent
argument_list|,
name|transport
argument_list|)
expr_stmt|;
name|masterBroker
operator|.
name|startProcessing
argument_list|()
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Slave Broker "
operator|+
name|info
operator|.
name|getBrokerName
argument_list|()
operator|+
literal|" is attached"
argument_list|)
expr_stmt|;
block|}
comment|// We only expect to get one broker info command per connection
if|if
condition|(
name|this
operator|.
name|brokerInfo
operator|!=
literal|null
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Unexpected extra broker info command received: "
operator|+
name|info
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|brokerInfo
operator|=
name|info
expr_stmt|;
name|broker
operator|.
name|addBroker
argument_list|(
name|this
argument_list|,
name|info
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
specifier|protected
name|void
name|dispatch
parameter_list|(
name|Command
name|command
parameter_list|)
block|{
try|try
block|{
name|setMarkedCandidate
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|transport
operator|.
name|oneway
argument_list|(
name|command
argument_list|)
expr_stmt|;
name|getStatistics
argument_list|()
operator|.
name|onCommand
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|serviceExceptionAsync
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|setMarkedCandidate
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|String
name|getRemoteAddress
parameter_list|()
block|{
return|return
name|transport
operator|.
name|getRemoteAddress
argument_list|()
return|;
block|}
specifier|private
name|ProducerBrokerExchange
name|getProducerBrokerExchange
parameter_list|(
name|ProducerId
name|id
parameter_list|)
block|{
name|ProducerBrokerExchange
name|result
init|=
name|producerExchanges
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|==
literal|null
condition|)
block|{
synchronized|synchronized
init|(
name|producerExchanges
init|)
block|{
name|result
operator|=
operator|new
name|ProducerBrokerExchange
argument_list|()
expr_stmt|;
name|ConnectionState
name|state
init|=
name|lookupConnectionState
argument_list|(
name|id
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
name|state
operator|.
name|getContext
argument_list|()
decl_stmt|;
name|result
operator|.
name|setConnectionContext
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|SessionState
name|ss
init|=
name|state
operator|.
name|getSessionState
argument_list|(
name|id
operator|.
name|getParentId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|ss
operator|!=
literal|null
condition|)
block|{
name|result
operator|.
name|setProducerState
argument_list|(
name|ss
operator|.
name|getProducerState
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|ProducerState
name|producerState
init|=
name|ss
operator|.
name|getProducerState
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|producerState
operator|!=
literal|null
operator|&&
name|producerState
operator|.
name|getInfo
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|ProducerInfo
name|info
init|=
name|producerState
operator|.
name|getInfo
argument_list|()
decl_stmt|;
name|result
operator|.
name|setMutable
argument_list|(
name|info
operator|.
name|getDestination
argument_list|()
operator|==
literal|null
operator|||
name|info
operator|.
name|getDestination
argument_list|()
operator|.
name|isComposite
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|producerExchanges
operator|.
name|put
argument_list|(
name|id
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
specifier|private
name|void
name|removeProducerBrokerExchange
parameter_list|(
name|ProducerId
name|id
parameter_list|)
block|{
synchronized|synchronized
init|(
name|producerExchanges
init|)
block|{
name|producerExchanges
operator|.
name|remove
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|ConsumerBrokerExchange
name|getConsumerBrokerExchange
parameter_list|(
name|ConsumerId
name|id
parameter_list|)
block|{
name|ConsumerBrokerExchange
name|result
init|=
name|consumerExchanges
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|==
literal|null
condition|)
block|{
synchronized|synchronized
init|(
name|consumerExchanges
init|)
block|{
name|result
operator|=
operator|new
name|ConsumerBrokerExchange
argument_list|()
expr_stmt|;
name|ConnectionState
name|state
init|=
name|lookupConnectionState
argument_list|(
name|id
argument_list|)
decl_stmt|;
name|ConnectionContext
name|context
init|=
name|state
operator|.
name|getContext
argument_list|()
decl_stmt|;
name|result
operator|.
name|setConnectionContext
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|SessionState
name|ss
init|=
name|state
operator|.
name|getSessionState
argument_list|(
name|id
operator|.
name|getParentId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|ss
operator|!=
literal|null
condition|)
block|{
name|ConsumerState
name|cs
init|=
name|ss
operator|.
name|getConsumerState
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|ConsumerInfo
name|info
init|=
name|cs
operator|.
name|getInfo
argument_list|()
decl_stmt|;
if|if
condition|(
name|info
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|info
operator|.
name|getDestination
argument_list|()
operator|!=
literal|null
operator|&&
name|info
operator|.
name|getDestination
argument_list|()
operator|.
name|isPattern
argument_list|()
condition|)
block|{
name|result
operator|.
name|setWildcard
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|consumerExchanges
operator|.
name|put
argument_list|(
name|id
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
specifier|private
name|void
name|removeConsumerBrokerExchange
parameter_list|(
name|ConsumerId
name|id
parameter_list|)
block|{
synchronized|synchronized
init|(
name|consumerExchanges
init|)
block|{
name|consumerExchanges
operator|.
name|remove
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

